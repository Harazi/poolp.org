<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=icon href=/images/poolp_org.png><title>Writing a custom Mail Delivery Agent | poolp.org</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://poolp.org/posts/2020-12-29/writing-a-custom-mail-delivery-agent/cover.jpg"><meta name=twitter:title content="Writing a custom Mail Delivery Agent"><meta name=twitter:description content="TL;DR: In this article, I explain what is an MDA and how to write a custom one from scratch using only shell scripting.  Shout outs to my patrons ! As usual, a huge thanks goes to the people sponsoring me on patreon, github or liberaPay, the work in this post was made possible by my sponsorship.
What is a Mail Delivery Agent (MDA) ? When a mail enters an SMTP server it is initially stored in the server queue before being moved to its next destination."><meta property="og:title" content="Writing a custom Mail Delivery Agent"><meta property="og:description" content="TL;DR: In this article, I explain what is an MDA and how to write a custom one from scratch using only shell scripting.  Shout outs to my patrons ! As usual, a huge thanks goes to the people sponsoring me on patreon, github or liberaPay, the work in this post was made possible by my sponsorship.
What is a Mail Delivery Agent (MDA) ? When a mail enters an SMTP server it is initially stored in the server queue before being moved to its next destination."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2020-12-29/writing-a-custom-mail-delivery-agent/"><meta property="og:image" content="https://poolp.org/posts/2020-12-29/writing-a-custom-mail-delivery-agent/cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-29T01:01:00+02:00"><meta property="article:modified_time" content="2020-12-29T01:01:00+02:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li><li class=nav-item><a class=nav-link href=/authors/gilles-chehade>About Me</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=Writing%20a%20custom%20Mail%20Delivery%20Agent&url=https%3a%2f%2fpoolp.org%2fposts%2f2020-12-29%2fwriting-a-custom-mail-delivery-agent%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=435'),!1"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2020-12-29%2fwriting-a-custom-mail-delivery-agent%2f" onclick="return window.open(this.href,'facebook-share','width=550,height=435'),!1"><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2020-12-29%2fwriting-a-custom-mail-delivery-agent%2f" onclick="return window.open(this.href,'xing-share','width=550,height=435'),!1"><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade</a><br><span class=author-description>foobarbaz-ing since 1981<br></span><br><span class=author-description><i class="far fa-star"></i>
Dec 29, 2020
<i class="far fa-clock clock"></i>
10 min read</span></div></div><div class=after-post-tags><ul class=tags></ul></div><h1 class=posttitle>Writing a custom Mail Delivery Agent</h1></div><div class=article-post><blockquote><b>TL;DR:</b>
In this article, I explain what is an MDA and how to write a custom one from scratch using only shell scripting.</blockquote><h1 id=shout-outs-to-my-patrons->Shout outs to my patrons !</h1><p>As usual, a <strong>huge</strong> thanks goes to the people <strong>sponsoring me</strong> on <strong><a href=https://www.patreon.com/gilles>patreon</a></strong>, <strong><a href=https://github.com/sponsors/poolpOrg>github</a></strong> or <strong><a href=https://liberapay.com/poolpOrg>liberaPay</a></strong>, the work in this post was made possible by my <strong><a href=/sponsorship/>sponsorship</a></strong>.</p><h1 id=what-is-a-mail-delivery-agent-mda->What is a Mail Delivery Agent (MDA) ?</h1><p>When a mail enters an SMTP server it is initially stored in the server queue before being moved to its next destination.</p><p>If the destination is a remote machine, the mail goes back to a Mail Transfer Agent (MTA) and is transferred elsewhere, but if the destination is a local user then it is passed to an MDA for delivery.</p><p>An MDA is a program that is in charge of delivering a mail to a local user and reporting to the SMTP server if the delivery was successful or not.</p><p>The MDA interface is <em>somewhat</em> standard so that if you write an MDA that doesn&rsquo;t take advantage of features specific to a particular SMTP server, it will work with others fine. This is why tools such as <code>procmail</code> or <code>fdm</code> can be used with OpenSMTPD, Postfix, Sendmail, notQmail or Exim indistinctly.</p><p>An MDA can be written in any language but to keep the examples simple and understandable by all, I decided to illustrate with shell scripting which is the poorest choice of a &ldquo;language&rdquo; you could make to write an MDA, be warned.</p><h1 id=how-does-it-work->How does it work ?</h1><p>An MDA works in a straightforward way.</p><p>It is a program that reads its input from <code>stdin</code> and reports success or failure through its <code>exit(3)</code> status.</p><p>Based on this description, the following shell script is a valid MDA as far as any SMTP server is concerned:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
cat
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>What it does is call the <code>cat</code> command, which consumes its input from <code>stdin</code> and writes it back to <code>stdout</code>, then propagate its exit value as that&rsquo;s how <code>cat</code> reports its success or failure.</p><p>This MDA does a poor job at MDA-ing because all it does is consume the input without writing it anywhere useful. As a result, the MDA will report success when <code>cat</code> is done reading the mail and echo-ing it back to <code>stdout</code> but the mail content will be gone forever.</p><p>This MDA could be made more useful by redirecting <code>stdout</code> to a file so that the input does not get lost:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
cat &gt;&gt; /tmp/mail-archives
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>In this version, the <code>/tmp/mail-archives</code> file is opened for append and <code>cat</code> has its <code>stdout</code> redirected to it. Every time the MDA gets called for a mail, the mail gets appended to that file.</p><p>This does a good job at explaining what is expected from an MDA, unfortunately it is a broken example.</p><p>Firstly because an MDA is executed for <em>each</em> mail being delivered, possibly simultaneously, and in the absence of a locking mechanism this might result in concurrent writes mangling its content.</p><p>Secondly because an MDA is executed with the privileges of the <em>recipient user</em> which means that every possible recipient needs to have write access to that file, with all the downsides you can imagine.</p><p>Let&rsquo;s see how to write something better.</p><h1 id=the-stdin-stream>The <code>stdin</code> stream</h1><p>The first thing to understand is that the mail is received on the standard input, <code>stdin</code>, as a stream of lines which are interrupted by an <code>EOF</code>.</p><p>There is no back and forth protocol of any kind, the MDA is the recipient of a unidirectional stream of input and does not have a side-channel to let the server know of what happens during the processing of this stream.</p><p>It consumes <code>stdin</code>, does something which the server doesn&rsquo;t know the details of, and tells the server when its done by exiting with a value indicating success or failure.</p><p>It doesn&rsquo;t get much simpler.</p><h1 id=sysexits3>sysexits(3)</h1><p>To report success or failure, the MDA operates like a standard unix program: it exits with <code>0</code> to indicate success and anything else to report failure.</p><p>Since that is the only way to report information to the server, MDA can make use of <code>sysexits(3)</code> status code to let the server interpret the reason behind a failure &mldr; or at least goes the theory.</p><p>In practice these codes are not used much and they don&rsquo;t impact the SMTP server behaviour much. Using the wrong code will result in nothing bad happening except <em>maybe</em> an inaccurate error message if the SMTP server does try to interpret them.</p><h1 id=mda-privileges>MDA privileges</h1><p>An MDA is not a long-running process that gets started once and runs forever. Every time a delivery happens for a recipient, a process is <code>fork(3)</code>-ed with the recipient privileges in order to execute an instance of the MDA.</p><p>If <code>gilles@poolp.org</code> receives a mail and <code>jules@poolp.org</code> receives a mail, and they use the same MDA, then there will be one process owned by <code>gilles</code> and one process owned by <code>jules</code>, both running concurrently (or at least they might).</p><p>Therefore, the MDA must not assume access to resources that require specific privileges. It must access resources that are available to the recipient user it was executed for. In other words, the MDA for <code>gilles</code> may access resources that <code>gilles</code> could access using a shell if he had one.</p><p>The example MDA above was bad because the <code>/tmp/mail-archives</code> must be shared between all users for it to work and this implies open permissions (<code>770</code> if users share the same group, <code>777</code> otherwise). A simple change to create a recipient-specific file would have been enough to avoid this issue and allow a more restrictive permission of <code>700</code>:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
cat &gt;&gt; /tmp/mail-archives.<span class=sb>`</span>whoami<span class=sb>`</span>
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>Note that the use of <code>whoami</code> here is not a good idea, it is here to back my point, but we&rsquo;ll discuss that in the next section.</p><p>Alternatively, the file could be moved to the recipient user home directory to achieve the same result:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
cat &gt;&gt; ~/mail-archives
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>In that case, we&rsquo;d be ok permission-wise but not with regard to concurrency as lack of locking would mean concurrent deliveries to the same user might mangle the file.</p><h1 id=the-mda-environment>The MDA environment</h1><p>An MDA inherits an environment from the SMTP server allowing it to determine who it is running for, what was the e-mail address of the sender and recipient, and other useful information.</p><p>First comes the shell environment variables, the ones you get when logging in to an account on Unix systems:</p><p>The <code>PATH</code> variable contains the default PATH allowing the MDA to execute standard programs on the host system. In my example MDA above, I didn&rsquo;t write <code>/bin/cat</code> because <code>/bin</code> was exposed in the MDA <code>PATH</code>.</p><p>The <code>SHELL</code> variable contains the shell that was executed to run the MDA.</p><p>The <code>HOME</code> variable contains, well, the path to the current recipient user home directory.</p><p>The <code>LOGNAME</code> and <code>USER</code> variables contain the recipient user. This is the owner of the current process, the one whose <code>HOME</code> is set for.</p><p>Then comes the MDA specific ones:</p><p>The <code>DOMAIN</code> variable contains the domain name of the recipient at the time of the SMTP session (that is before any aliasing).</p><p>The <code>LOCAL</code> variable contains the user-part of the e-mail address that was used during the SMTP session (that is before any aliasing). <code>${LOCAL}@${DOMAIN}</code> is the e-mail address that was used in the SMTP session.</p><p>The <code>RECIPIENT</code> variable contains the recipient e-mail address following all aliasing.</p><p>The <code>SENDER</code> variable is set to the e-mail address of the sender or to an empty string in case of a MAILER-DAEMON bounce.</p><p>The <code>EXTENSION</code> is set to the extension if there&rsquo;s any used with the recipient e-mail address. The extension is what follows <code>+</code> and precedes <code>@</code> in e-mail addresses such as <code>gilles+1@poolp.org</code></p><p>As you can see, there&rsquo;s a few of them covering about all session informations needed to properly execute an MDA. If we were to take a silly broken example from above:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
cat &gt;&gt; /tmp/mail-archives.<span class=sb>`</span>whoami<span class=sb>`</span>
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>We could replace it as follows to make use of the environment:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
cat &gt;&gt; /tmp/mail-archives.<span class=si>${</span><span class=nv>USER</span><span class=si>}</span>
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>It would be better, but what if we wrote a better MDA, one that is usable without concurrency or permission issues ?</p><h1 id=writing-a-maildir-like-mda>Writing a <code>maildir</code>-like MDA</h1><p>In this section, we will write an MDA that delivers mail to a <code>maildir</code>-like structure.</p><p>Contrarily to the previous examples, this one will ensure that there are no issues if multiple instances run concurrently for one or many users.</p><p>First, we&rsquo;ll write the base for our MDA, the <code>stdin</code> reading loop:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
cat
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>Then, we need to figure where the <code>maildir</code> should be located and create the directory structure if needed, applying restrictive permissions. Because we know that the MDA is provided with a <code>HOME</code> environment variable, we can make use of that:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
<span class=nv>MAILDIR</span><span class=o>=</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span>/Maildir

<span class=nb>umask</span> <span class=m>077</span> 
<span class=nb>test</span> -d <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span> <span class=o>||</span> mkdir <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>
<span class=nb>test</span> -d <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/cur <span class=o>||</span> mkdir <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/cur
<span class=nb>test</span> -d <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/new <span class=o>||</span> mkdir <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/new
<span class=nb>test</span> -d <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/tmp <span class=o>||</span> mkdir <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/tmp

cat
<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>At this point, we have dodged issues with two different users running the same MDA since we deliver to a recipients home directory but we have to worry about the same MDA being executed concurrently for the same user.</p><p>This could be handled with a lock, as is done for <code>mbox</code>-style mailboxes that use a single file per user, but <code>maildir</code> has a more elegant solution to solve this: generating unique filenames in a temporary directory, then atomically renaming to the destination directory.</p><p>By writing to a temporary directory, the file is not yet visible by the user until it is finished being written, at which point the atomic rename makes it visible. If any error happens in between, the file remains in the temporary directory and can be purged after a while, but there is no risk of exposing a partial file.</p><p>We&rsquo;ll adapt the MDA to save a copy of the mail from <code>stdin</code> to a temporary file with a unique name. To construct the name, I decided to go with a unix timestamp, followed by a 64-bits random value and the local hostname. This ensures that there can&rsquo;t be collisions if generated on two machines sharing the same network storage due to the hostname, and that collisions are unlikely on the same host as they would require a 64-bits collision of a random value happening within a second. Once the temporary file has been written and <code>cat</code> reported success, it is moved to the <code>~/Maildir/new</code> which makes it visible to clients:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span>
<span class=nv>MAILDIR</span><span class=o>=</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span>/Maildir

<span class=nb>umask</span> <span class=m>077</span> 
<span class=nb>test</span> -d <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span> <span class=o>||</span> mkdir <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>
<span class=nb>test</span> -d <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/new <span class=o>||</span> mkdir <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/new
<span class=nb>test</span> -d <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/tmp <span class=o>||</span> mkdir <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/tmp

<span class=c1># ie: 1609171573.deb626c88c2da87f.laptop</span>
<span class=nv>FILENAME</span><span class=o>=</span><span class=sb>`</span>date +%s<span class=sb>`</span>.<span class=sb>`</span>openssl rand -hex 8<span class=sb>`</span>.<span class=sb>`</span>hostname<span class=sb>`</span>

cat &gt; <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/tmp/<span class=si>${</span><span class=nv>FILENAME</span><span class=si>}</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>	mv <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/tmp/<span class=si>${</span><span class=nv>FILENAME</span><span class=si>}</span> <span class=si>${</span><span class=nv>MAILDIR</span><span class=si>}</span>/new/<span class=si>${</span><span class=nv>FILENAME</span><span class=si>}</span>

<span class=nb>exit</span> <span class=nv>$?</span>
</code></pre></div><p>We can test that it works by running the command outside the SMTP server:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>gilles@mba ~ % ls -l ~/Maildir  
ls: /Users/gilles/Maildir: No such file or directory
gilles@mba ~ % sh mda.sh             
HOLA !
gilles@mba ~ % ls -l ~/Maildir/new 
total <span class=m>8</span>
-rw-------  <span class=m>1</span> gilles  staff  <span class=m>7</span> Dec <span class=m>29</span> 00:52 1609199557.db7be737b9423c87.mba
gilles@mba ~ % cat ~/Maildir/new/1609199557.db7be737b9423c87.mba
HOLA !
gilles@mba ~ % 
</code></pre></div><p>This MDA does not perform any check on the mail content and copies the stream as is but nothing prevents your MDA from doing arbitrary work.</p><p>The MDA could parse the headers to extract information, collect statistics, store the content in a database, or do anything including apply stupid rules like not allowing a delivery on rainy days.</p><p>As much as the SMTP server knows, this is a blackbox that will acknowledge having delivered, but how it did is left to the MDA.</p><h1 id=conclusion>Conclusion</h1><p>I wrote this because many people have had questions regarding custom MDA, how to write one and what they do.</p><p>I might have missed stuff, if you have questions feel free to ask and I will expand this article.</p><hr><p>Comments: <a href=https://github.com/poolpOrg/poolp.org/issues/83>https://github.com/poolpOrg/poolp.org/issues/83</a></p></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2021-01-31/january-2021-opensmtpd-libtls-conversion-and-unix-domain-sockets-support-noosmtpd/>&#171; January 2021: OpenSMTPD libtls conversion and UNIX-domain sockets support, nooSMTPD</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2020-12-24/december-2020-opensmtpd-6.8.0p1-released-fixed-several-bugs-proposed-several-diffs-book-is-on-github/>December 2020: OpenSMTPD 6.8.0p1 released, fixed several bugs, proposed several diffs, book is on Github &#187;</a><div class=clearfix></div></div></div></div></div></div><div class=alertbar><div class="container text-center"><span><img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)</span></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright poolp.org - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script><script src=/js/mediumish.js></script></body></html>