<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.107.0"><link rel=icon href=/images/poolp_org.png><title>OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support | poolp.org</title><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support"><meta name=twitter:description content="OHAI,
This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.
As you may have guessed, this week has not been too productive&mldr; Oh wait, yes it has ! It&rsquo;s actually been incredibly productive :-)
Just as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github."><meta property="og:title" content="OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support"><meta property="og:description" content="OHAI,
This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.
As you may have guessed, this week has not been too productive&mldr; Oh wait, yes it has ! It&rsquo;s actually been incredibly productive :-)
Just as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2012-12-07/opensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-12-07T21:17:57+00:00"><meta property="article:modified_time" content="2012-12-07T21:17:57+00:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet><link rel=alternate type=application/rss+xml title="subscribe to feed" href=/index.xml></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://discord.gg/YC6j4rbvSk>Discord</a></li><li class=nav-item><a class=nav-link href=https://www.youtube.com/channel/UCU-1Rn7gWhessHWwC3_EsEg>Youtube</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li><li class=nav-item><a class=nav-link href=/authors/gilles-chehade>About Me</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=OpenSMTPD%3a%20fully%20virtual%20setups%2c%20updated%20DNS%20%26%20MTA%20code%2c%20SQLite%20support&url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1'><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f" onclick='return window.open(this.href,"xing-share","width=550,height=435"),!1'><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade / جيل شحادة"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade / جيل شحادة</a><br><span class=author-description>foobarbaz-ing since 1981<br></span><br><span class=author-description><i class="far fa-star"></i>
Dec 7, 2012
<i class="far fa-clock clock"></i>
7 min read</span></div></div><div class=after-post-tags><ul class=tags></ul></div><h1 class=posttitle>OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support</h1><b><a class="far fa-comment" href=#comments>go to comments</a></b><br><br></div><div class=article-post><p>OHAI,</p><p>This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.</p><p>As you may have guessed, this week has not been too productive&mldr; Oh wait, yes it has ! It&rsquo;s actually been incredibly productive :-)</p><p>Just as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github.</p><p>K_SOURCEADDR table service</p><p>OpenSMTPD has been taught how to fetch a source address from a table, but does not make use of it yet. This will, for example, allow users to force a source address for their outgoing mail when they get blacklisted by the monkeys at spamhaus.</p><p>The K_SOURCEADDR service performs a cyclic lookup returning each address of a table one after the other so that a table holding multiple addresses will cycle through them.</p><p>Improved DNS API</p><p>Eric has cleaned and improved the DNS API: dnsquery*() functions now have a more logical ordering of their arguments; struct dns has been killed and we now use two small imsg-specific structures; dns_query_mx_preference() has been introduced to retrieve the preference level of a specific MX for a domain; and finally all MX addresses are looked up in parallel instead of sequentially.</p><p>MTA improvements</p><p>Eric has also improved the MTA internal operations so that it uses better abstractions for relay domains, hosts, sources and routes. A MTA session now operates on a given route and reports errors on that route only.</p><p>The relay tries to open as many routes as possible, within various limits, and drains all mails dispatching them. Oh and it is ready to use the K_SOURCEADDR lookup service but doesn&rsquo;t do it yet, this will probably be part of next week&rsquo;s milestone.</p><p>Table API improvements and new SQLite backend</p><p>The table API now provides a simple mechanism for backends to support a configuration file without having to deal with the parsing. The backend can be declared in smtpd.conf using:</p><p>table foobar mybackend:/etc/mail/mybackend.conf</p><p>Then the backend may simply do:</p><p>static int table_mybackend_config(struct table *t, const char *configfile) { void *cf;</p><p>cf = table_config_create();
if (! table_config_parse(cf, configfile, T_HASH)) {
table_config_destroy(cf);
return 0;
}</p><p>table_set_configuration(t, cfg);
return 1;
}</p><p>To have the /etc/mail/mybackend.conf file parsed into a key/value table. It can then fetch the values from any other handler using:</p><p>static void * table_mybackend_open(struct table *t) { void *cf = table_get_configuration(t);</p><p>if (table_config_get(cf, &ldquo;key&rdquo;) == NULL) {
log_warnx(&ldquo;table_mybackend: open: missing key from config file&rdquo;);
return NULL;
}</p><p>return t;
}</p><p>Since I needed a use case, I added support for SQLite as a table backend allowing the use of SQLite for any kind of lookup. I had already done it in the past as a proof of concept when we were still using the map API for lookups, but this time it&rsquo;s the real deal.</p><p>SQLite support is achieved using the same approach as that of Postfix where the schema is not imposed but rather the user provides the queries themselves to allow as much flexibiliy as possible.</p><p>To show you how it can be setup, here&rsquo;s a sample smtpd.conf:</p><p>smtpd.conf</p><p>table mytbl sqlite:/etc/mail/sqlite.conf</p><p>i could have another one configured differently</p><p>table mytbl2 sqlite:/etc/mail/sqlite-other.conf</p><p>and i can have the same one serve different kinds of lookups ;-)</p><p>accept for domain alias deliver to mbox</p><p>and here&rsquo;s the sample sqlite.conf that goes with it</p><p>Path to database</p><p>dbpath /tmp/sqlite.db</p><p>Alias lookup query</p><p>rows >= 0</p><p>fields == 1 (user varchar)</p><p>query_alias select value from aliases where key=?;</p><p>Domain lookup query</p><p>rows == 1</p><p>fields == 1 (domain varchar)</p><p>query_domain select value from domains where key=?;</p><p>Of course, you may have multiple smtpd tables using sqlite backends, they may use different configuration files, you can have two aliases databases for two different domains or use the same database table to hold all information for all lookups. It&rsquo;s as flexible as it gets &mldr; ALL lookup services are supported by the SQLite backend so it can be used to store anything used by OpenSMTPD.</p><p>K_USERINFO lookup service</p><p>OpenSMTPD uses the table API for every lookups but there was still one kind of lookups that were performed using a different API: users informations.</p><p>The table API expects lookups to be done asynchronously but OpenSMTPD had some code that looked up users synchronously, like right before a delivery or to find the home directory of a user for a ~/.forward check.</p><p>I introduced a new lookup service, K_USERINFO, which allows processes to lookup for informations regarding a username, such as its uid, gid and home directory. I then reworked the ~/.forward check and the delivery code to ensure the user information lookup is performed asynchronously through the K_USERINFO service rather than through the user_lookup() API which was synchronous.</p><p>The only backend to implement K_USERINFO was table_getpwnam which was essentially doing the same as before, just asynchronously, and at that point, user_lookup() bit the dust.</p><p>REALLY VIRTUAL users</p><p>A feature that has been requested for a long time and which was very heard to implement was support for virtual users.</p><p>OpenSMTPD required that the end user be a real system-user that could be looked up using getpwnam(). The K_USERINFO lookup service changed this slightly by having OpenSMTPD require that the end user be a user that could be looked up using table_lookup().</p><p>And since we can write lookup services using any backend, I wrote K_USERINFO handlers for table_static, table_db and table_sqlite. I then added a new keyword to smtpd.conf to allow rules to specify a user table:</p><p>table bleh1 { vuser => vuser:10:100:/tmp/vuser } table bleh2 { vuser => vuser:20:200:/tmp2/vuser }</p><p>accept for domain poolp.org users deliver to maildir accept for domain opensmtpd.org users deliver to maildir accept for domain pool.ps deliver to maildir</p><p>With this, OpenSMTPD will accept mail for domain poolp.org but will only find users if they are part of the table bleh1. The domain opensmtpd.org has a different users database, that shares a username but does not share the uid, gid and homedir. In this example, I used static tables, but it could really be sqlite, db or whatever ;-)</p><p>The domain pool.ps has no users table and defaults to the system database which is what most users will expect.</p><p>Relay URL update and K_CREDENTIALS lookup service</p><p>Since several months, smtpd.conf supports a &ldquo;relay URL&rdquo; format to define relays we want to route via:</p><p>table creds { mail.poolp.org => gilles:mypasswd } accept for any relay via tls+auth://mail.poolp.org:31337 auth</p><p>When sending mail, the creds table will search for an entry matching the domain name of the relay and find the credentials there. This has annoyed me for a while because it meant that it was not possible to share credentials between multiple relays, it was not possible to have different credentials for two relays operating under the same name, etc, etc &mldr;</p><p>Also, it annoyed me that outgoing authentication would use K_CREDENTIALS while incoming authentication would not use the table API but the auth_backend API instead.</p><p>I convinced Eric that it would be nice to provide a new mechanism in relay URL so that we could have a label, like tls+auth://label@mail.poolp.org:31337 and it would be used as the key for the credentials lookup.</p><p>This would allow multiple relays to refer to the same label, or different relays under the same hostname to refer to different labels. It would also allow two nice tricks: first, since the labels are looked up in a different service then we can update the creds table live and MTA will pick up the change; then, if for incoming authentication we assume the username to be the label, then K_CREDENTIALS can be use as THE mechanism to authenticate both in and out sessions and we can kill the auth_backend API.</p><p>So &mldr; I wrote it and we can now do:</p><p>table in_auth { gilles => gilles:encryptedpasswd } table out_auth { bleh => gilles:cleartextpasswd }</p><p>listen on all tls auth</p><p>accept for domain poolp.org deliver to maildir accept for any relay via tls+auth://bleh@mail.poolp.org auth</p><p>And this closes the last issue with regard to assuming any locality of the users for any purpose. An OpenSMTPD instance no longer assumes users to be local, or to really exists, for any purpose whatsoever.</p><p>Next week should see a long awaited feature, I will not say much and leave it as a surprise. Meanwhile, you guys have a nice week-end, I need a zZzZ ;-)</p></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2012-12-14/opensmtpd-ldap-support-selectable-source-dkim-and-goodies/>&#171; OpenSMTPD: LDAP support, selectable source, DKIM and Goodies</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2012-11-30/opensmtpd-more-features-more-cleanup-more-more/>OpenSMTPD: more features, more cleanup, more more &#187;</a><div class=clearfix></div></div></div></div></div><div class=container><div id=comments class="row justify-content-center mb-5"><div class=col-md-8><script src=https://giscus.app/client.js data-repo=poolpOrg/poolp.org data-repo-id="MDEwOlJlcG9zaXRvcnkxMjYxODk2MjA=" data-category=Articles data-category-id=DIC_kwDOB4WANM4B-Zf1 data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></div></div><div class=alertbar><div class="container text-center"><span><img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)</span></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright poolp.org - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script></body></html>