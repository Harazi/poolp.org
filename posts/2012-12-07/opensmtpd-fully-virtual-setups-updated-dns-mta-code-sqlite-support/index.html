<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support - poolp.org</title><meta property="og:title" content="OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support"><meta name=twitter:title content="OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite …"><meta name=description content="OHAI,
This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.
As you may have guessed, this week has not been too productive&mldr; Oh wait, yes it has ! It&rsquo;s actually been incredibly productive :-)
Just as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github."><meta property="og:description" content="OHAI,
This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.
As you may have guessed, this week has not been too productive&mldr; Oh wait, yes it has ! It&rsquo;s actually been incredibly productive :-)
Just as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github."><meta name=twitter:description content="OHAI,
This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to …"><meta name=author content="Gilles Chehade"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"poolp.org","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/poolp.org\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/poolp.org\/posts\/2012-12-07\/opensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support\/","name":"Open s m t p d fully virtual setups, updated d n s \u0026 m t a code, s q lite support"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Gilles Chehade"},"headline":"OpenSMTPD: fully virtual setups, updated DNS \u0026 MTA code, SQLite support","description":"OHAI,\nThis week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.\nAs you may have guessed, this week has not been too productive\u0026hellip; Oh wait, yes it has ! It\u0026rsquo;s actually been incredibly productive :-)\nJust as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github.","inLanguage":"en","wordCount":1419,"datePublished":"2012-12-07T21:17:57","dateModified":"2012-12-07T21:17:57","image":"https:\/\/poolp.org\/","keywords":[""],"mainEntityOfPage":"https:\/\/poolp.org\/posts\/2012-12-07\/opensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support\/","publisher":{"@type":"Organization","name":"https:\/\/poolp.org\/","logo":{"@type":"ImageObject","url":"https:\/\/poolp.org\/","height":60,"width":60}}}</script><meta property="og:title" content="OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support"><meta property="og:description" content="OHAI,
This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.
As you may have guessed, this week has not been too productive&mldr; Oh wait, yes it has ! It&rsquo;s actually been incredibly productive :-)
Just as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github."><meta property="og:url" content="https://poolp.org/posts/2012-12-07/opensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=twitter:title content="OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite …"><meta name=twitter:description content="OHAI,
This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to …"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta property="og:url" content="https://poolp.org/posts/2012-12-07/opensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=generator content="Hugo 0.78.1"><link rel=alternate href=https://poolp.org/index.xml type=application/rss+xml title=poolp.org><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://poolp.org/css/main.css><link rel=stylesheet href=https://poolp.org/css/highlight.min.css><link rel=stylesheet href=https://poolp.org/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=/css/latex.style.css></head><body><div class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://poolp.org/ target=_blank><img src=/images/poolp_org.png alt=poolp.org height=55px></a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li class=navlinks-container><a class=navlinks-parent>Freelance</a><div class=navlinks-children><a href=/en/contracting/>[en] Hire me !</a>
<a href=/fr/contracting/>[fr] Recrutez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Sponsorship</a><div class=navlinks-children><a href=/en/sponsorship/>[en] Sponsor me !</a>
<a href=/fr/sponsorship/>[fr] Sponsorisez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Social</a><div class=navlinks-children><a href=https://patreon.com/gilles>Patreon</a>
<a href=https://www.linkedin.com/in/gilleschehade>LinkedIn</a>
<a href=https://github.com/poolpOrg>Github</a>
<a href=https://twitter.com/poolpOrg>Twitter</a></div></li><li class=navlinks-container><a class=navlinks-parent>Curriculum</a><div class=navlinks-children><a href=https://github.com/poolpOrg/resume/blob/master/resume.en.pdf>EN</a>
<a href=https://github.com/poolpOrg/resume/blob/master/resume.fr.pdf>FR</a></div></li><li><a title=Hypnose href=https://hypno.cat>Hypnose</a></li></ul></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1 style=text-align:left>OpenSMTPD: fully virtual setups, updated DNS & MTA code, SQLite support</h1></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>OHAI,</p><p>This week I had intended to work on filters. After 3 days of pain and swearing, even though it did move forward, I finally decided to step back for a few days and work on something else to preserve my sanity.</p><p>As you may have guessed, this week has not been too productive&mldr; Oh wait, yes it has ! It&rsquo;s actually been incredibly productive :-)</p><p>Just as usual, I will only write a summary for this week, the complete changelog can be retrieved from our mirror on Github.</p><p>K_SOURCEADDR table service</p><p>OpenSMTPD has been taught how to fetch a source address from a table, but does not make use of it yet. This will, for example, allow users to force a source address for their outgoing mail when they get blacklisted by the monkeys at spamhaus.</p><p>The K_SOURCEADDR service performs a cyclic lookup returning each address of a table one after the other so that a table holding multiple addresses will cycle through them.</p><p>Improved DNS API</p><p>Eric has cleaned and improved the DNS API: dnsquery*() functions now have a more logical ordering of their arguments; struct dns has been killed and we now use two small imsg-specific structures; dns_query_mx_preference() has been introduced to retrieve the preference level of a specific MX for a domain; and finally all MX addresses are looked up in parallel instead of sequentially.</p><p>MTA improvements</p><p>Eric has also improved the MTA internal operations so that it uses better abstractions for relay domains, hosts, sources and routes. A MTA session now operates on a given route and reports errors on that route only.</p><p>The relay tries to open as many routes as possible, within various limits, and drains all mails dispatching them. Oh and it is ready to use the K_SOURCEADDR lookup service but doesn&rsquo;t do it yet, this will probably be part of next week&rsquo;s milestone.</p><p>Table API improvements and new SQLite backend</p><p>The table API now provides a simple mechanism for backends to support a configuration file without having to deal with the parsing. The backend can be declared in smtpd.conf using:</p><p>table foobar mybackend:/etc/mail/mybackend.conf</p><p>Then the backend may simply do:</p><p>static int table_mybackend_config(struct table *t, const char *configfile) { void *cf;</p><p>cf = table_config_create();
if (! table_config_parse(cf, configfile, T_HASH)) {
table_config_destroy(cf);
return 0;
}</p><p>table_set_configuration(t, cfg);
return 1;
}</p><p>To have the /etc/mail/mybackend.conf file parsed into a key/value table. It can then fetch the values from any other handler using:</p><p>static void * table_mybackend_open(struct table *t) { void *cf = table_get_configuration(t);</p><p>if (table_config_get(cf, &ldquo;key&rdquo;) == NULL) {
log_warnx(&ldquo;table_mybackend: open: missing key from config file&rdquo;);
return NULL;
}</p><p>return t;
}</p><p>Since I needed a use case, I added support for SQLite as a table backend allowing the use of SQLite for any kind of lookup. I had already done it in the past as a proof of concept when we were still using the map API for lookups, but this time it&rsquo;s the real deal.</p><p>SQLite support is achieved using the same approach as that of Postfix where the schema is not imposed but rather the user provides the queries themselves to allow as much flexibiliy as possible.</p><p>To show you how it can be setup, here&rsquo;s a sample smtpd.conf:</p><p>smtpd.conf</p><p>table mytbl sqlite:/etc/mail/sqlite.conf</p><p>i could have another one configured differently</p><p>table mytbl2 sqlite:/etc/mail/sqlite-other.conf</p><p>and i can have the same one serve different kinds of lookups ;-)</p><p>accept for domain alias deliver to mbox</p><p>and here&rsquo;s the sample sqlite.conf that goes with it</p><p>Path to database</p><p>dbpath /tmp/sqlite.db</p><p>Alias lookup query</p><p>rows >= 0</p><p>fields == 1 (user varchar)</p><p>query_alias select value from aliases where key=?;</p><p>Domain lookup query</p><p>rows == 1</p><p>fields == 1 (domain varchar)</p><p>query_domain select value from domains where key=?;</p><p>Of course, you may have multiple smtpd tables using sqlite backends, they may use different configuration files, you can have two aliases databases for two different domains or use the same database table to hold all information for all lookups. It&rsquo;s as flexible as it gets &mldr; ALL lookup services are supported by the SQLite backend so it can be used to store anything used by OpenSMTPD.</p><p>K_USERINFO lookup service</p><p>OpenSMTPD uses the table API for every lookups but there was still one kind of lookups that were performed using a different API: users informations.</p><p>The table API expects lookups to be done asynchronously but OpenSMTPD had some code that looked up users synchronously, like right before a delivery or to find the home directory of a user for a ~/.forward check.</p><p>I introduced a new lookup service, K_USERINFO, which allows processes to lookup for informations regarding a username, such as its uid, gid and home directory. I then reworked the ~/.forward check and the delivery code to ensure the user information lookup is performed asynchronously through the K_USERINFO service rather than through the user_lookup() API which was synchronous.</p><p>The only backend to implement K_USERINFO was table_getpwnam which was essentially doing the same as before, just asynchronously, and at that point, user_lookup() bit the dust.</p><p>REALLY VIRTUAL users</p><p>A feature that has been requested for a long time and which was very heard to implement was support for virtual users.</p><p>OpenSMTPD required that the end user be a real system-user that could be looked up using getpwnam(). The K_USERINFO lookup service changed this slightly by having OpenSMTPD require that the end user be a user that could be looked up using table_lookup().</p><p>And since we can write lookup services using any backend, I wrote K_USERINFO handlers for table_static, table_db and table_sqlite. I then added a new keyword to smtpd.conf to allow rules to specify a user table:</p><p>table bleh1 { vuser => vuser:10:100:/tmp/vuser } table bleh2 { vuser => vuser:20:200:/tmp2/vuser }</p><p>accept for domain poolp.org users deliver to maildir accept for domain opensmtpd.org users deliver to maildir accept for domain pool.ps deliver to maildir</p><p>With this, OpenSMTPD will accept mail for domain poolp.org but will only find users if they are part of the table bleh1. The domain opensmtpd.org has a different users database, that shares a username but does not share the uid, gid and homedir. In this example, I used static tables, but it could really be sqlite, db or whatever ;-)</p><p>The domain pool.ps has no users table and defaults to the system database which is what most users will expect.</p><p>Relay URL update and K_CREDENTIALS lookup service</p><p>Since several months, smtpd.conf supports a &ldquo;relay URL&rdquo; format to define relays we want to route via:</p><p>table creds { mail.poolp.org => gilles:mypasswd } accept for any relay via tls+auth://mail.poolp.org:31337 auth</p><p>When sending mail, the creds table will search for an entry matching the domain name of the relay and find the credentials there. This has annoyed me for a while because it meant that it was not possible to share credentials between multiple relays, it was not possible to have different credentials for two relays operating under the same name, etc, etc &mldr;</p><p>Also, it annoyed me that outgoing authentication would use K_CREDENTIALS while incoming authentication would not use the table API but the auth_backend API instead.</p><p>I convinced Eric that it would be nice to provide a new mechanism in relay URL so that we could have a label, like tls+auth://label@mail.poolp.org:31337 and it would be used as the key for the credentials lookup.</p><p>This would allow multiple relays to refer to the same label, or different relays under the same hostname to refer to different labels. It would also allow two nice tricks: first, since the labels are looked up in a different service then we can update the creds table live and MTA will pick up the change; then, if for incoming authentication we assume the username to be the label, then K_CREDENTIALS can be use as THE mechanism to authenticate both in and out sessions and we can kill the auth_backend API.</p><p>So &mldr; I wrote it and we can now do:</p><p>table in_auth { gilles => gilles:encryptedpasswd } table out_auth { bleh => gilles:cleartextpasswd }</p><p>listen on all tls auth</p><p>accept for domain poolp.org deliver to maildir accept for any relay via tls+auth://bleh@mail.poolp.org auth</p><p>And this closes the last issue with regard to assuming any locality of the users for any purpose. An OpenSMTPD instance no longer assumes users to be local, or to really exists, for any purpose whatsoever.</p><p>Next week should see a long awaited feature, I will not say much and leave it as a surprise. Meanwhile, you guys have a nice week-end, I need a zZzZ ;-)</p><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f&text=OpenSMTPD%3a%20fully%20virtual%20setups%2c%20updated%20DNS%20%26%20MTA%20code%2c%20SQLite%20support&via=poolpOrg" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f&title=OpenSMTPD%3a%20fully%20virtual%20setups%2c%20updated%20DNS%20%26%20MTA%20code%2c%20SQLite%20support" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f&title=OpenSMTPD%3a%20fully%20virtual%20setups%2c%20updated%20DNS%20%26%20MTA%20code%2c%20SQLite%20support" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f&title=OpenSMTPD%3a%20fully%20virtual%20setups%2c%20updated%20DNS%20%26%20MTA%20code%2c%20SQLite%20support" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-07%2fopensmtpd-fully-virtual-setups-updated-dns-mta-code-sqlite-support%2f&description=OpenSMTPD%3a%20fully%20virtual%20setups%2c%20updated%20DNS%20%26%20MTA%20code%2c%20SQLite%20support" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://poolp.org/posts/2012-11-30/opensmtpd-more-features-more-cleanup-more-more/ data-toggle=tooltip data-placement=top title="OpenSMTPD: more features, more cleanup, more more">&larr; Previous Post</a></li><li class=next><a href=https://poolp.org/posts/2012-12-14/opensmtpd-ldap-support-selectable-source-dkim-and-goodies/ data-toggle=tooltip data-placement=top title="OpenSMTPD: LDAP support, selectable source, DKIM and Goodies">Next Post &rarr;</a></li></ul></div></div></div><footer style=text-align:justify><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><h2>Like my work and want to help me ?</h2><br><ul><li>Consider <b>tipping me</b> on <b><a target=_blank href=https://paypal.me/poolpOrg>PayPal</a></b>,
<b>supporting me</b> through one of the <b><a href=/en/sponsorship>sponsorship</a></b> platforms at <b><a href=https://github.com/sponsors/poolpOrg>Github</a></b>, <b><a href=https://patreon.com/gilles>Patreon</a></b> or
<b><a href=https://liberapay.com/poolpOrg>LiberaPay</a></b>,
or even <b>getting me something</b> from my wishlist on <b><a target=_blank href=http://amzn.eu/3MwH6CX>Amazon</a></b>
for positive <b><a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a></b> :-)<br><br></li><li>You can also help me by <b>commenting articles</b> to spark discussions,
and by <b>sharing them</b> so they reach a bigger audience,
they all contain a comment link and icons that will let you share to popular social networks.</li></ul><br></div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="credits copyright text-muted"><a href=https://poolp.org>Gilles Chehade</a>
-&nbsp;&copy;
2020
-
<a href=https://poolp.org/>poolp.org</a></p><p class="credits theme-by text-muted"><a href=http://gohugo.io>Hugo v0.78.1</a> powered - Theme adapted from <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://poolp.org/js/main.js></script><script src=https://poolp.org/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0");});</script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://poolp.org/js/load-photoswipe.js></script></body></html>