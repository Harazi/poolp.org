<!doctype html><html lang=en-us><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.4">
<link rel=icon href=/images/poolp_org.png>
<title>OpenSMTPD released and upcoming filters preview | poolp.org</title>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="OpenSMTPD released and upcoming filters preview">
<meta name=twitter:description content="TL;DR: Filters have been a (the most ?) long awaited feature in OpenSMTPD. I finally committed most of the filters code to OpenBSD. There is still a bit of work required but the trickiest parts are done. This article describes how filters are implemented and what to expect.  OpenSMTPD 6.4.0 was released ! We have released OpenSMTPD 6.4.0 last week without filters.
I won&rsquo;t expand on the features in the 6.">
<meta property="og:title" content="OpenSMTPD released and upcoming filters preview">
<meta property="og:description" content="TL;DR: Filters have been a (the most ?) long awaited feature in OpenSMTPD. I finally committed most of the filters code to OpenBSD. There is still a bit of work required but the trickiest parts are done. This article describes how filters are implemented and what to expect.  OpenSMTPD 6.4.0 was released ! We have released OpenSMTPD 6.4.0 last week without filters.
I won&rsquo;t expand on the features in the 6.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://poolp.org/posts/2018-11-03/opensmtpd-released-and-upcoming-filters-preview/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-11-03T17:27:00+00:00">
<meta property="article:modified_time" content="2018-11-03T17:27:00+00:00">
<link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous>
<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet>
<link href=/css/medium.css rel=stylesheet>
<link href=/css/additional.css rel=stylesheet>
<link href=/css/syntax.css rel=stylesheet>
<link href=/css/custom.css rel=stylesheet>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
<div class="container pr-0">
<a class=navbar-brand href=https://poolp.org/>
<img src=/images/poolp_org.png alt=logo>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarMediumish>
<ul class="navbar-nav ml-auto">
<li class=nav-item>
<a class=nav-link href=/fr/contracting/>Freelance</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://hypno.cat>Hypnose</a>
</li>
<li class=nav-item>
<a class=nav-link href=/authors/gilles-chehade>About Me</a>
</li>
</ul>
</div>
</div>
</nav>
<div class=site-content>
<div class=container>
<div class=mainheading>
</div><div class=main-content>
<div class=container>
<div class=row>
<div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset">
<p>Share</p>
<ul>
<li class="ml-1 mr-1">
<a target=_blank href="https://twitter.com/intent/tweet?text=OpenSMTPD%20released%20and%20upcoming%20filters%20preview&url=https%3a%2f%2fpoolp.org%2fposts%2f2018-11-03%2fopensmtpd-released-and-upcoming-filters-preview%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=435'),!1">
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="ml-1 mr-1">
<a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2018-11-03%2fopensmtpd-released-and-upcoming-filters-preview%2f" onclick="return window.open(this.href,'facebook-share','width=550,height=435'),!1">
<i class="fab fa-facebook-f"></i>
</a>
</li>
<li class="ml-1 mr-1">
<a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2018-11-03%2fopensmtpd-released-and-upcoming-filters-preview%2f" onclick="return window.open(this.href,'xing-share','width=550,height=435'),!1">
<i class="fab fa-xing"></i>
</a>
</li>
</ul>
</div>
</div>
<div class="col-md-9 flex-first flex-md-unordered">
<div class=mainheading>
<div class="row post-top-meta">
<div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right">
<img class=author-thumb src=/images/me.png alt="Gilles Chehade / حيل شحادة">
</div>
<div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left">
<a target=_blank class=link-dark>Gilles Chehade / حيل شحادة</a><br>
<span class=author-description>
foobarbaz-ing since 1981<br>
</span>
<br>
<span class=author-description>
<i class="far fa-star"></i>
Nov 3, 2018
<i class="far fa-clock clock"></i>
11 min read
</span>
</div>
</div>
<div class=after-post-tags>
<ul class=tags>
</ul>
</div>
<h1 class=posttitle>OpenSMTPD released and upcoming filters preview</h1>
</div>
<div class=article-post>
<pre><code>TL;DR:
Filters have been a (the most ?) long awaited feature in OpenSMTPD.
I finally committed most of the filters code to OpenBSD.
There is still a bit of work required but the trickiest parts are done.
This article describes how filters are implemented and what to expect.
</code></pre>
<p><img src=https://brillianceinsight.files.wordpress.com/2014/02/card-2-24-2014-1_thumb.jpg alt="Good news, everyone!"></p>
<h2 id=opensmtpd-640-was-released->OpenSMTPD 6.4.0 was released !</h2>
<p>We have <a href=https://opensmtpd.org/announces/release-6.4.0.txt>released OpenSMTPD 6.4.0 last week</a> <strong>without</strong> filters.</p>
<p>I won&rsquo;t expand on the features in the 6.4 release as I already wrote about the configuration file changes,
the issues that required it and the refactors involved,
this was the one true major feature of the release.</p>
<p>One notable aspect though is that we dropped our support for OpenSSL in favor of LibreSSL,
and THAT I should expand upon ;-)</p>
<h2 id=libressl-ftw->LibreSSL FTW !</h2>
<p>OpenSMTPD was started long before LibreSSL and from the very first portable version,
we had to include ifdefs to accomodate the differences between the different OpenSSL versions across Linux distros:
some had SNI, others don&rsquo;t, some had GCM, others don&rsquo;t.</p>
<p>When LibreSSL was forked from OpenSSL after a large cleanup of the code,
we thought we&rsquo;d just depend on that because it was cleaner and also we knew that this version had all the features we relied on.
Also, there was this plan for a libtls wrapper which would be much simpler to use and less error-prone than libssl.</p>
<p>It turned out that it wasn&rsquo;t possible because OpenSSL and LibreSSL couldn&rsquo;t coexist on many systems.
The fact that they shared the same library names (libssl, libcrypto),
and shared object versionning,
caused issues with the confused runtime link editor.
We decided to accomodate both,
keeping checks in the configure layer to detect what was being used, etc&mldr;
It was horrible.
It kept breaking every now and then due to either one making changes.
I had to deal with these breakages.
It was horrible.</p>
<p>Before the 6.4 release,
I did the portability build passes and yet again it broke on new OpenSSL conflicts with our grammar.
Three different people using different distros had sent me three different diffs which fixed the issues for them,
but which I couldn&rsquo;t merge without creating a delta with the native branch which was not acceptable for us.
The more I tried fixing and the more I was irritated by this OpenSSL/LibreSSL hacks.</p>
<p>I did a bit of investigation and it turns out the issues that prevented them from coexisting were no longer relevant.
I verified by building, linking and running OpenSMTPD against LibreSSL on FreeBSD, Ubuntu, Debian, CentOS, ArchLinux and Fedora.
It is technically possible to make OpenSMTPD depend on LibreSSL without forcing distros to switch from OpenSSL to LibreSSL,
so there&rsquo;s no reason for us not to depend on LibreSSL anymore.</p>
<p>This allowed me to start removing ifdefs from our code,
removing useless tests from the configure.ac and assume that we have the features we need for all systems.</p>
<p>This doesn&rsquo;t mean that people can&rsquo;t link OpenSMTPD against OpenSSL,
it just means that they get to handle the diffs to their own version,
the extra work of maintaining OpenSSL goes out of our hands.</p>
<h2 id=filters>Filters</h2>
<p>We started working on filters years ago,
I even <a href=https://poolp.org/posts/2014-12-12/the-state-of-filters/>wrote an article about them in 2014</a>.</p>
<p>A first implementation was written.
After a while, it became clear that the design was wrong and causing unfixable bugs in some filters.
I decided to pull the plug on that attempt and we removed all of the code.</p>
<p>A year ago,
<a href="https://youtu.be/wnhvn1rsXR8?t=3056">during EuroBSDCon 2017</a>,
I mentionned the filtering daemon we had worked on and which solved these limitations.
But as OpenBSD 6.4 release was getting closer,
I started to dislike that idea because I believed it was not addressing the proper problem:
we had came up with a working solution, not the best solution to the problem.
The more I spent thinking about this,
the more the problem looked different from what we initially modeled.</p>
<p>I discussed my concerns with Eric,
told him that I thought we had made a mistake in modeling filters,
that by thinking them differently we could come up with a much simpler solution,
and somehow managed to convince him I was right :-)</p>
<p>Given we took so much time already,
it made sense delaying for a release so we would be confident about our technical choice.</p>
<p>I worked on a proof of concept for the new model and a week later I had filters working on my laptop,
a convinced eric and&mldr;
many months to make it bright and shiny because it was obviously not going to make it into 6.4</p>
<h2 id=event-reports-and-filter-request>Event reports and filter request</h2>
<p>The new filters are modeled around the notions of event reports and filter requests.</p>
<p>During the lifetime of a session,
an SMTP engine will report various events such as the beginning of a new connection,
the negotiation of ciphers during the TLS handshake or even the beginning of an SMTP transaction with MAIL FROM.
These events help the SMTP engine build a state for a session and determine what is acceptable or not from a client at a given time.</p>
<p>Some filters may not need a state, they may operate on the parameter to a command and that&rsquo;s all.
Other filters however may need to build a state for a session,
not necessarily the same exact and complete state as the SMTP engine,
but a state that makes sense given the work the filter will do.</p>
<p>The event reports are <em>informative</em> messages,
which a filter may decide to process or not,
and that encompass ALL of the SMTP events a session goes through.
It is possible to replay an entire SMTP session based on these reports.</p>
<p>The filter requests however are not informative.
A filter will be configured to handle a particular filtering phase and will receive filter requests for that phase,
containing the phase and the parameter to filter,
it will then be REQUIRED to answer the request with an action to take.</p>
<p>Again,
simple filters may only deal with filter requests,
more complex filters may process the event reports to learn about sessions before dealing with filter requests.</p>
<h2 id=event-processors>Event processors</h2>
<p>Event processors are standalone executables which &mldr; process event reports and filter requests in an infinite loop.</p>
<p>OpenSMTPD executes them at startup and sets up an environment so they behave like traditional Unix-filters:
they read input from stdin and write output to stdout.</p>
<p>Both event reports and filter requests will consist of single lines,
each consisting of multiple fields separated by a pipe symbol <code>|</code>.
All lines will hold a generic set of fields such as event type and session identifier,
as well as a set of event-specific fields such as an ip address for connection event,
an email address for mail-from event, etc&mldr;</p>
<p>Event reports will expect no response,
meaning that for a line read on stdin there will be no line written on stdout,
whereas filter requests will expect a response,
meaning that for a line read on stdin there will be one line written to stdout.</p>
<p>The simplest processor to write is one reading events to log them:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span><span class=c1>#</span>

<span class=k>while</span> <span class=nb>read</span> line<span class=p>;</span>
<span class=k>do</span>
	<span class=nb>echo</span> <span class=nv>$line</span> &gt;&gt; /tmp/output.log
<span class=k>done</span>
</code></pre></div><p>If you have ever parsed OpenSMTPD logs to inject them into an ELK or similar,
you should now be in love with the events reporting feature.</p>
<p>Filters are not much more complex,
the only difference is that <code>$line</code> needs to be split to extract the session identifier,
and the processor needs to write back its decision.</p>
<p>The simplest filtering processor to write is one that accepts every filter-request:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=cp>#! /bin/sh
</span><span class=cp></span><span class=c1>#</span>

<span class=k>while</span> <span class=nb>read</span> line<span class=p>;</span>
<span class=k>do</span>
        <span class=k>if</span> <span class=nb>echo</span> <span class=nv>$line</span> <span class=p>|</span> grep <span class=s1>&#39;^filter-request|&#39;</span><span class=p>;</span> <span class=k>then</span>
		<span class=nv>SESSION</span><span class=o>=</span><span class=sb>`</span><span class=nb>echo</span> <span class=nv>$line</span> <span class=p>|</span> cut -d<span class=se>\|</span> -f4<span class=sb>`</span>
		<span class=nb>echo</span> <span class=s2>&#34;filter-response|</span><span class=si>${</span><span class=nv>SESSION</span><span class=si>}</span><span class=s2>|proceed&#34;</span>
	<span class=k>fi</span>
						
<span class=k>done</span>
</code></pre></div><p>Note that while this example shows a synchronous protocol where a filter-request gets an immediate answer,
the implementation does not impose that limitation.
There should be a filter-response for each filter-request,
but they do not need to happen right away and they do not need to happen in the same sequence order.</p>
<p>Now that you&rsquo;re all sold on this solution, here are the bonus advantages:</p>
<p>OpenSMTPD only knows that it has to execute the processor and write to its stdin.
There are no dependencies and no limitations to what language a processor is written in,
a postmaster does not have to learn C to write a filter but can effectively hack something fast with a few lines of shell or python.</p>
<p>The events processors are forked:
they do not share the same memory space as OpenSMTPD,
they do not share the same memory space as each other,
and on systems that provide randomized memory layout they do not even share the same memory layout.
On OpenBSD, each processor could benefit from its own <code>pledge()</code> and its own <code>unveil()</code>.
A compromise of either one does not imply the compromission of the others or of the daemon.</p>
<p>In addition, they can be executed with different privileges and including chrooted() to a particular directory:</p>
<pre tabindex=0><code>proc filter1 &quot;/tmp/filter1.sh&quot; user _filter1
proc filter2 &quot;/tmp/filter2.sh&quot; group _filter2
proc filter3 &quot;/tmp/filter3.sh&quot; user _filter3 group gilles
proc filter4 &quot;/filter4&quot; user _filter4 chroot &quot;/tmp&quot;
</code></pre><h2 id=event-proc>Event proc</h2>
<p>Event processors can receive event reports for each events generated by the SMTP engine (for now).</p>
<p>This allows two things.
First,
it allows fine-grained reporting to specialized software that can extract metrics,
generate fancy dashboards and such.</p>
<p>Until now,
people had to try and extract this information from our log files which were meant to be consumed by humans primarily.
The event logs provides all of the useful informations in a format that can be easily parsed by scripts.
Converting these entries to the proper format for injecting in a timeseries database or similar becomes trivial.</p>
<p>Then,
some filters may be able to work without any context by looking solely at the current command,
but in many cases a decision at a particular phase may be the consequence of decisions at earlier phases,
and filters can consume these event reports to build their own view of the state of sessions.</p>
<p>Here is a sample of event reports:</p>
<pre tabindex=0><code>report|smtp-in|link-connect|1541271219|3189ac6874354895|localhost|127.0.0.1:41564|127.0.0.1:25
report|smtp-in|protocol-server|1541271219|3189ac6874354895|220 poolp.org ESMTP OpenSMTPD
report|smtp-in|protocol-client|1541271222|3189ac6874354895|helo localhost
report|smtp-in|protocol-server|1541271222|3189ac6874354895|250 poolp.org Hello localhost [127.0.0.1], pleased to meet you
report|smtp-in|link-disconnect|1541271224|3189ac6874354895
</code></pre><p>And this is how you define an event proc in smtpd.conf:</p>
<pre tabindex=0><code>proc my_event_proc &quot;/usr/local/bin/script.sh&quot;

report smtp on my_event_proc

</code></pre><p>This gets OpenSMTPD to run the script at startup and to pipe the event reports to its stdin.</p>
<h2 id=filter-proc>Filter proc</h2>
<p>Filter processors are very similar to event processors in how they work,
excepted that they are registered for specific filtering phases:</p>
<pre tabindex=0><code>proc my_filter_proc &quot;/usr/local/bin/script.sh&quot;

# line below can be uncommented if filters needs event reports to build a state
# report smtp on my_filter_proc
filter smtp helo on my_filter_proc
filter smtp ehlo on my_filter_proc
filter smtp mail-from on my_filter_proc
filter smtp rcpt-to on my_filter_proc

</code></pre><p>The filters will receive phase-specific parameters:</p>
<pre tabindex=0><code>filter-request|smtp-in|ehlo|e68808ff61812a6f|laptop.home|localhost
filter-request|smtp-in|mail-from|e68808ff61812a6f|&lt;gilles@laptop.home&gt;
filter-request|smtp-in|rcpt-to|e68808ff61812a6f|&lt;gilles@laptop.home&gt;
filter-request|smtp-in|ehlo|e688090368c275a3|laptop.home|localhost
filter-request|smtp-in|mail-from|e688090368c275a3|&lt;gilles@laptop.home&gt;
filter-request|smtp-in|rcpt-to|e688090368c275a3|&lt;gilles@laptop.home&gt;

</code></pre><p>To which they will have to reply with a decision:</p>
<pre tabindex=0><code>filter-response|e68808ff61812a6f|proceed
filter-response|e68808ff61812a6f|rewrite|BLEH
filter-response|e68808ff61812a6f|reject|550 go away
filter-response|e68808ff61812a6f|disconnect|550 go away
</code></pre><p>The only possible decisions are <code>proceed</code>, <code>rewrite</code>, <code>reject</code> or <code>disconnect</code>.</p>
<h2 id=builtin-filters>Builtin filters</h2>
<p>Filter proc are very useful when a decision relies on anything else than the parameter to the command being filtered,
when it depends on information gathered from previous events,
or even when it depends on complex logic involving multiple lookups.</p>
<p>In many cases though,
a decision to filter may rely solely on the current command and a simple table lookup.
For instance,
one may want to reject a HELO hostname that&rsquo;s not part of a table,
or reject a MAIL FROM that matches a regular expression.</p>
<p>For these cases,
OpenSMTPD provides a small set of builtin filters which are fairly generic to be applied to all phases.</p>
<pre tabindex=0><code>table helo-reject { &quot;foobar&quot;, &quot;barbaz&quot;, &quot;bazqux&quot; }
table helo-reject-regex { &quot;^f[oO]o[bB]ar$&quot; }

filter smtp helo check-table &lt;helo-reject&gt; reject &quot;550 go away&quot;
filter smtp helo check-regex &quot;^go\-away$&quot; reject &quot;550 go away&quot;
filter smtp helo check-regex &lt;helo-reject-regex&gt; reject &quot;550 go away&quot;
</code></pre><p>We will also implement some very limited additional phase-specific builtin filters that cover common use-cases.
OpenSMTPD performs a reverse DNS lookup on connect,
both connect and helo/ehlo filter phases commonly check reverse DNS,
so we already provided a <code>check-rdns</code> for these phases:</p>
<pre tabindex=0><code>filter smtp connect check-rdns reject &quot;550 you need a reverse DNS&quot;
filter smtp ehlo check-rdns reject &quot;550 your HELO hostname and rDNS mismatch&quot;
</code></pre><p>There shouldn&rsquo;t be many builtin filters,
we don&rsquo;t expect more than a handful of them,
but they do exist so there&rsquo;s that ;-)</p>
<h2 id=what-next->What next ?</h2>
<p>This code has been committed to OpenBSD and will be available in OpenSMTPD 6.5.0,
which should happen sometime around April 2019.</p>
<p>I haven&rsquo;t documented anything yet because both configuration grammar and protocol are still going through lots of changes,
I would strongly suggest against playing with event reports and filter procs before March,
unless you&rsquo;re a developer and happy with having to make changes to your code every few days.</p>
<p>The only part that I have not committed yet is the filtering of DATA,
which still requires a bit of work but will be working and committed sometime in November.</p>
<p>Once I have this part done,
I&rsquo;ll implement a few filters for the use-cases I have such as filter-spf and filter-rspamd,
then it will be ok as far as I&rsquo;m concerned.</p>
<p>My main work for the release cycle to come is finishing and polishing filters,
fixing the portable layer which has grown a monster,
and ultimately doing a full release cycle of&mldr;
cosmethic cleanup so code is pleasing to read ;-)</p>
<hr>
<p>Comments: <a href=https://github.com/poolpOrg/poolp.org/discussions/95>https://github.com/poolpOrg/poolp.org/discussions/95</a></p>
</div>
<div class="row PageNavigation d-flex justify-content-between font-weight-bold">
<a class="d-block col-md-6" href=https://poolp.org/posts/2018-11-09/opensmtpd-reporting-update/> &#171; OpenSMTPD reporting update</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2018-05-21/switching-to-opensmtpd-new-config/>switching to OpenSMTPD new config &#187;</a>
<div class=clearfix></div>
</div>
</div>
</div>
</div>
</div>
<div class=alertbar>
<div class="container text-center">
<span>
<img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)
</span>
</div>
</div>
</div>
<footer class=footer>
<div class=container>
<div class=row>
<div class="col-md-6 col-sm-6 text-center text-lg-left">
&copy; Copyright poolp.org - All rights reserved
</div>
<div class="col-md-6 col-sm-6 text-center text-lg-right">
<a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net
</div>
</div>
</div>
</footer>
</div>
<script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script>
</body>
</html>