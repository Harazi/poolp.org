<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.109.0"><link rel=icon href=/images/poolp_org.png><title>fatigue et envie de vacances... | poolp.org</title><meta name=twitter:card content="summary"><meta name=twitter:title content="fatigue et envie de vacances..."><meta name=twitter:description content="Je sais pas pourquoi, mais je suis epuise alors que j&rsquo;ai dormi pres de 14h cette nuit. J&rsquo;ai envie de faire une pause, de me prendre une annee de vacances au bord de la plage les doigts de pieds dans le sable fin blanc pendant qu&rsquo;on me sert du sorbet a la noix de coco sur fond de Gojira alors que le soleil me rechauffe le visage mais juste un peu, pas trop, voila, comme ca, merci."><meta property="og:title" content="fatigue et envie de vacances..."><meta property="og:description" content="Je sais pas pourquoi, mais je suis epuise alors que j&rsquo;ai dormi pres de 14h cette nuit. J&rsquo;ai envie de faire une pause, de me prendre une annee de vacances au bord de la plage les doigts de pieds dans le sable fin blanc pendant qu&rsquo;on me sert du sorbet a la noix de coco sur fond de Gojira alors que le soleil me rechauffe le visage mais juste un peu, pas trop, voila, comme ca, merci."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2005-05-21/fatigue-et-envie-de-vacances.../"><meta property="article:section" content="posts"><meta property="article:published_time" content="2005-05-21T00:00:00+00:00"><meta property="article:modified_time" content="2005-05-21T00:00:00+00:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet><link rel=alternate type=application/rss+xml title="subscribe to feed" href=/index.xml></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://discord.gg/YC6j4rbvSk>Discord</a></li><li class=nav-item><a class=nav-link href=https://www.youtube.com/channel/UCU-1Rn7gWhessHWwC3_EsEg>Youtube</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li><li class=nav-item><a class=nav-link href=/authors/gilles-chehade>About Me</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=fatigue%20et%20envie%20de%20vacances...&url=https%3a%2f%2fpoolp.org%2fposts%2f2005-05-21%2ffatigue-et-envie-de-vacances...%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2005-05-21%2ffatigue-et-envie-de-vacances...%2f" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1'><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2005-05-21%2ffatigue-et-envie-de-vacances...%2f" onclick='return window.open(this.href,"xing-share","width=550,height=435"),!1'><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade / جيل شحادة"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade / جيل شحادة</a><br><span class=author-description>foobarbaz-ing since 1981<br></span><br><span class=author-description><i class="far fa-star"></i>
May 21, 2005
<i class="far fa-clock clock"></i>
4 min read</span></div></div><div class=after-post-tags><ul class=tags></ul></div><h1 class=posttitle>fatigue et envie de vacances...</h1><b><a class="far fa-comment" href=#comments>go to comments</a></b><br><br></div><div class=article-post><p>Je sais pas pourquoi, mais je suis epuise alors que j&rsquo;ai dormi pres de 14h cette nuit.
J&rsquo;ai envie de faire une pause,
de me prendre une annee de vacances au bord de la plage les doigts de pieds dans le sable fin blanc pendant qu&rsquo;on me sert du sorbet a la noix de coco sur fond de Gojira alors que le soleil me rechauffe le visage mais juste un peu, pas trop, voila, comme ca, merci.
L&rsquo;odeur des langoustes grilles me chatouille les narines et, alors que je sirote une pinte de Guinness(c) (la premire d&rsquo;une longue serie ?),
j&rsquo;entends le doux murmure des vagues <em>wuuuuuush &mldr;. wuuuuuuush &mldr;</em> couvert par le cri des mouettes <em>t&rsquo;as un syscall a finiiiiir &mldr; t&rsquo;as un syscall a finiiiiiiiiir &mldr;</em></p><p>En rouvrant les yeux, un peu triste et du, j&rsquo;entrevois deux lignes &mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cc -c -I/usr/src/sys -D_KERNEL sys_whore.c 
</span></span><span class=line><span class=cl>$ 
</span></span></code></pre></div><p>&mldr; qui me ramene la dure realite&mldr; j&rsquo;ai un syscall a terminer.</p><p>Meme dans mes songes, je passe vraiment des vacances de merde &mldr;</p><p>[Ajout]
Bon alors voila,
j&rsquo;ai perdu plusieurs heures dessus donc je vais donner une astuce qui va peut-etre epargner de nombreuses heures de recherche a mes camarades tech4 qui codent leur syscall pour BSD.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>sys_whore</span><span class=p>(</span><span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>v</span><span class=p>,</span> <span class=kt>register_t</span> <span class=o>*</span><span class=n>retval</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Mais a quoi peut bien servir retval alors qu&rsquo;on a un return() dans le code,
et comment faire pour faire retourner autre chose qu&rsquo;un entier a notre syscall ?</p><p>Apres m&rsquo;etre cogne pres d&rsquo;une dizaine de syscalls sans en voir un seul qui utilisait le retval,
j&rsquo;ai demande sur le channel #netbsd ou on m&rsquo;a dit de la merde.</p><p>Un peu plus tard sur #openbsd,
on m&rsquo;a conseill la lecture de /usr/src/sys/i386/i386/trap.c et la tout devient evident a la lecture de la fonction syscall().</p><p>En realite,
que se passe-t&rsquo;il lorsqu&rsquo;un programme demande l&rsquo;execution de notre syscall ?</p><ul><li>Les parametres sont places en ordre inverse dans la stack</li><li>Le numro de syscall est place dans le registre EAX</li><li>L&rsquo;interruption 0x80 fait passer en mode kernel qui execute&mldr; la fonction syscall() definie dans le trap.c</li></ul><p>Quand on regarde ce qu&rsquo;elle fait, on comprends mieux. Quelques morceaux choisis:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=kt>register_t</span> <span class=n>code</span><span class=p>,</span> <span class=n>args</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=n>rval</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>[...]</span>
</span></span><span class=line><span class=cl>    <span class=n>rval</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>  <span class=cm>/* valeur de retour de l&#39;appel systeme */</span>
</span></span><span class=line><span class=cl>    <span class=p>[...]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* appel; on stock le return */</span>
</span></span><span class=line><span class=cl>    <span class=n>orig_error</span> <span class=o>=</span> <span class=n>error</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>callp</span><span class=o>-&gt;</span><span class=n>sy_call</span><span class=p>)(</span><span class=n>p</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>rval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>[...]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[...]</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>  <span class=cm>/* return different de zero (et de cas particuliers) */</span>
</span></span><span class=line><span class=cl>    <span class=nl>bad</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>p_emul</span><span class=o>-&gt;</span><span class=n>e_errno</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>error</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>p_emul</span><span class=o>-&gt;</span><span class=n>e_errno</span><span class=p>[</span><span class=n>error</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>frame</span><span class=p>.</span><span class=n>tf_eax</span> <span class=o>=</span> <span class=n>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>frame</span><span class=p>.</span><span class=n>tf_eflags</span> <span class=o>|=</span> <span class=n>PSL_C</span><span class=p>;</span>       <span class=cm>/* carry bit */</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>Explications:
Le premier element de rval est la valeur de retour de notre syscall, a ne pas confondre avec le return.
En fait, le return dans le code de notre syscall sert <em>uniquement</em> a determiner s&rsquo;il s&rsquo;est bien deroule,
il renvoie 0 en cas de succes <em>quoi qu&rsquo;il arrive</em>,
et une valeur d&rsquo;errno dans le cas contraire.
Mais alors &mldr; c&rsquo;est pour ca que retval n&rsquo;est presque jamais utilise dans les syscalls !</p><p>En effet,
si le syscall rate son return sera un code errno et la fonction wrapper n&rsquo;aura pas besoin de verifier retval puisque la valeur qu&rsquo;elle devra renvoyer sera -1 ou NULL, donc pas besoin d&rsquo;y toucher. De meme, si syscall reussi, comme generalement il est sense renvoyer 0, il n&rsquo;a pas besoin d&rsquo;y toucher non plus puisque retval[0] est initialise a 0 avant le call. Le seul cas ou retval est modifie alors c&rsquo;est quand le syscall renvoie une valeur differente de 0 en cas de success&mldr;
la lecture de <code>getpid()</code> et de ses soeurs le confirme&mldr;
YOUPI !</p><p>Ca vous rappelle rien ?
Dans ktrace en tech3 on avait eu le meme probleme,
lorsqu&rsquo;un syscall ratait il renvoyait non pas -1 mais une valeur differente de 0 et il fallait ruser avec EAX pour determiner s&rsquo;il s&rsquo;agissait d&rsquo;un ratage ou pas pour afficher nous meme -1 comme etant la valeur de retour.</p><p>Un mystere qui m&rsquo;a occupe une partie de la journe est resolu ;)</p><p>[Ajout #2]
Si vous vous demandiez pourquoi retval est un tableau de deux entiers,
la reponse m&rsquo;est apparue tout a l&rsquo;heure, je sais pas, un clair de lucidite.
Comme son nom l&rsquo;indique, c&rsquo;est un tableau de registre (register_t),
et si le premier element correspond au registre EAX (bah oui puisque la valeur de retour est placee dans ce registre),
le fait que syscall() associe le registre EDX au second element peut sembler un peu bizarre.</p><p>Et bien nan,
en fait c&rsquo;est pour resoudre un cas bien particulier,
celui de sys_fork() puisqu&rsquo;il renvoie DEUX valeurs de retour en cas de succes.
Le pere recupere la valeur de retour; le pid, dans EAX et le fils recupere la valeur de retour, 0, dans EDX.
Magique non ?</p></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2012-05-09/some-opensmtpd-news/>&#171; Some OpenSMTPD news</a><div class=clearfix></div></div></div></div></div><div class=container><div id=comments class="row justify-content-center mb-5"><div class=col-md-8><script src=https://giscus.app/client.js data-repo=poolpOrg/poolp.org data-repo-id="MDEwOlJlcG9zaXRvcnkxMjYxODk2MjA=" data-category=Articles data-category-id=DIC_kwDOB4WANM4B-Zf1 data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></div></div><div class=alertbar><div class="container text-center"><span><img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)</span></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left"><a rel=me href=https://social.poolp.org/@gilles>Mastodon</a>
&copy; Copyright poolp.org - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script></body></html>