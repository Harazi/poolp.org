<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=icon href=/images/poolp_org.png><title>spfwalk | poolp.org</title><meta name=twitter:card content="summary"><meta name=twitter:title content="spfwalk"><meta name=twitter:description content="TL;DR: deraadt@ thought it would be nice to have a spf fetch utility in base. Aaron Poffenberger wrote a shell-based `spf_fetch` utility. I wrote a C-based `spfwalk` utility that's `pledge()`-ed. The `spfwalk` utility got merged to `smtpctl`.  What&rsquo;s SPF in a few words SPF is the Sender Policy Framework, a standard to verify the domain name of an e-mail sender.
Long story short, the SMTP protocol does not come with a way to authenticate a domain and, during an SMTP session, nothing really prevents a sender from pretending to come from any domain:"><meta property="og:title" content="spfwalk"><meta property="og:description" content="TL;DR: deraadt@ thought it would be nice to have a spf fetch utility in base. Aaron Poffenberger wrote a shell-based `spf_fetch` utility. I wrote a C-based `spfwalk` utility that's `pledge()`-ed. The `spfwalk` utility got merged to `smtpctl`.  What&rsquo;s SPF in a few words SPF is the Sender Policy Framework, a standard to verify the domain name of an e-mail sender.
Long story short, the SMTP protocol does not come with a way to authenticate a domain and, during an SMTP session, nothing really prevents a sender from pretending to come from any domain:"><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2018-01-08/spfwalk/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-08T17:19:00+00:00"><meta property="article:modified_time" content="2018-01-08T17:19:00+00:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/custom.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org//><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/posts>Articles</a></li><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=spfwalk&url=https%3a%2f%2fpoolp.org%2fposts%2f2018-01-08%2fspfwalk%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=435'),!1"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2018-01-08%2fspfwalk%2f" onclick="return window.open(this.href,'facebook-share','width=550,height=435'),!1"><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2018-01-08%2fspfwalk%2f" onclick="return window.open(this.href,'xing-share','width=550,height=435'),!1"><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade</a><br><span class=author-description><br><i class="far fa-star"></i>
Jan 8, 2018
<i class="far fa-clock clock"></i>
5 min read</span></div></div><h1 class=posttitle>spfwalk</h1></div><div class=article-post><pre><code>TL;DR:
deraadt@ thought it would be nice to have a spf fetch utility in base.
Aaron Poffenberger wrote a shell-based `spf_fetch` utility.
I wrote a C-based `spfwalk` utility that's `pledge()`-ed.
The `spfwalk` utility got merged to `smtpctl`.
</code></pre><h2 id=whats-spf-in-a-few-words>What&rsquo;s SPF in a few words</h2><p>SPF is the Sender Policy Framework, a standard to verify the domain name of an e-mail sender.</p><p>Long story short, the SMTP protocol does not come with a way to authenticate a domain and,
during an SMTP session,
nothing really prevents a sender from pretending to come from any domain:</p><pre><code>$ nc localhost 25 
220 poolp.org ESMTP OpenSMTPD
HELO pussycat
250 poolp.org Hello pussycat [127.0.0.1], pleased to meet you
MAIL FROM:&lt;gilles@systemd.lol&gt;
250 2.0.0: Ok
^C
$ 
</code></pre><p>Note that this is a feature of the SMTP protocol, not a bug.</p><p>It turns out that the internet is a hostile place and people started abusing this so&mldr;
the solution,
as usual when it comes to SMTP,
was to shove data inside DNS records \o/</p><p>SPF allows the owner of a DNS zone to declare which machines are allowed to send mail on behalf of the domain in a TXT record.
With this feature,
whenever a spammer attempts to send mail on behalf of @google.com,
the receiving MX can simply check that the client is allowed to send mail by the google.com zone.</p><p>This seems lovely,
however it&rsquo;s not a spam killer because it actually requires senders to create the record,
destination nodes to actually check the TXT record and match the client address against it,
and it doesn&rsquo;t prevent spammers from adding SPF records to their own domains.</p><p>What it does,
when everything is setup correctly on both ends,
is protect the destination node from spammers trying to impersonnate a sender domain&mldr;
as long as the spammer doesn&rsquo;t control a machine declared in the TXT record [ it&rsquo;s easy to whitelist a /16 ;) ].</p><h2 id=greylisting>Greylisting</h2><p>A technique that&rsquo;s been used widely to reduce spam is to rely on greylisting.</p><p>Basically,
when a MX you don&rsquo;t know connects to your node,
it gets bounced with a temporary failure requesting a retry.
All SMTP server know how to handle these retries,
however in a spamming economy based on sending volumes of messages it&rsquo;s often not worth it to retry on temporary failures.</p><p>Spammers will come from many source addresses,
keep being seen as new MX,
keep being bounced,
life is good.</p><p>Why am I talking about greylisting you ask ?</p><h2 id=when-big-mailers-made-it-easier-for-spammers-to-annoy-us>When BIG MAILERS made it easier for spammers to annoy us</h2><p>It&rsquo;s impolite to point fingers so I won&rsquo;t name them explicitely,
you know who they are.</p><p>Greylisting works lovely to waste spammers' time&mldr;
as long as you can assume legitimate hosts come from the same IP addresses.</p><p>At some point,
BIG MAILERS decided that:
nope, we&rsquo;ll send from this host,
then we&rsquo;ll retry from this one,
then another one,
and then since we have hundreds of IP addresses available,
well just fuck you, we&rsquo;ll make sure we never hit you twice with the same.</p><p>I don&rsquo;t know if these were the exact words,
but it essentially leads to that &ldquo;fuck you&rdquo; result so&mldr;</p><p>Since BIG MAILERS could not send from a small set of addresses and reuse the same ones upon retries,
they started advertising their MX in SPF records.
And by that I mean,
they started whitelisting full ranges in records requiring recursive and cross-domains lookups because WHY NOT ?</p><p>This way, greylisting became essentially unusable to many who turned it off because they can&rsquo;t easily whitelist BIG MAILERS.</p><h2 id=this-is-how-we-get-to-spfwalk>This is how we get to <code>spfwalk</code></h2><p>We don&rsquo;t want to NOT have greylisting,
so we want a tool to actually harvest records enabled in BIG MAILERS' SPF record.</p><p>deraadt@ ran into an issue with one of his MX which had BIG MAILERS unable to pass greylisting.
He asked me if I could write a utility to fetch SPF records and insert them into a PF table to whitelist MX for particular domains.</p><p>Coincidentally,
Aaron Poffenberger announced the next day that he had been working on a tool called <code>spf_fetch</code> <a href=https://github.com/akpoff/spf_fetch>https://github.com/akpoff/spf_fetch</a> to do just that. The idea was nice however it couldn&rsquo;t be committed to OpenBSD as is because it is written as a set of shell scripts and we wanted a piece of code that could be <code>pledge()</code>-ed.</p><p>I contacted Aaron and told him I was going to be working on a C version based on the asr asynchronous resolver,
and told him I would appreciate if he contributed since he had already started a similar project.
A few weeks later,
we had a work in progress <code>spfwalk</code> utility commited to my repository <a href=https://github.com/poolpOrg/spfwalk>https://github.com/poolpOrg/spfwalk</a>.</p><h2 id=smtpctl-spf-walk>smtpctl spf walk</h2><p>Instead of having a new utility committed to base,
we decided to make it a subcommand of the <code>smtpctl</code> utility.</p><p>The main idea is that <code>smtpctl spf walk</code> will read a list of domains from stdin and output a list of IP addresses and ranges to stdout,
allowing it to be used in scripts,
to generate file lists,
or to be piped directly into <code>pfctl</code> to feed a table.</p><p>This is still a work in progress,
but it allows you to <code>cat /etc/mail/BIGMAILERS.txt | smtpctl spf walk | pfctl -t spf-white -T add -f -</code>,
which is quite an improvement over having nothing to do it to start with :-)</p><h2 id=final-words>Final words</h2><p>sunil@ merged my utility to <code>smtpctl</code>,
I made sure it ran unprivileged,
so now we have an spf fetching utility that runs unprivileged and <code>pledge()</code>-ed in the base system.</p><p>This was committed a few days ago to OpenBSD -current,
it requires testing because I&rsquo;m pretty sure it has bugs still.</p><hr><p>Want to comment ? <a href=https://github.com/poolpOrg/poolpOrg.github.io/issues/>Open an issue on Github</a></p></div><div class=after-post-tags><ul class=tags></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2018-01-29/install-openbsd-on-dedibox-with-full-disk-encryption/>&#171; Install OpenBSD on dedibox with full-disk encryption</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2018-01-08/news-from-the-front/>News from the front ! &#187;</a><div class=clearfix></div></div></div></div></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright Gilles Chehade - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script><script src=/js/mediumish.js></script></body></html>