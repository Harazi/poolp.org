<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>OpenSMTPD: SSL & relay stuff - poolp.org</title><meta property="og:title" content="OpenSMTPD: SSL & relay stuff"><meta name=twitter:title content="OpenSMTPD: SSL & relay stuff"><meta name=description content="OHAI,
I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.
I still don&rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he&rsquo;ll write about it if he wants to or I&rsquo;ll do that next time."><meta property="og:description" content="OHAI,
I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.
I still don&rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he&rsquo;ll write about it if he wants to or I&rsquo;ll do that next time."><meta name=twitter:description content="OHAI,
I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.
I still don&rsquo;t have a desk so I will make this short by not …"><meta name=author content="Gilles Chehade"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"poolp.org","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/poolp.org\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/poolp.org\/posts\/2012-12-28\/opensmtpd-ssl-relay-stuff\/","name":"Open SMTP d ssl \u0026 relay stuff"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Gilles Chehade"},"headline":"OpenSMTPD: SSL \u0026 relay stuff","description":"OHAI,\nI was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.\nI still don\u0026rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he\u0026rsquo;ll write about it if he wants to or I\u0026rsquo;ll do that next time.","inLanguage":"en","wordCount":735,"datePublished":"2012-12-28T20:11:23","dateModified":"2012-12-28T20:11:23","image":"https:\/\/poolp.org\/","keywords":[""],"mainEntityOfPage":"https:\/\/poolp.org\/posts\/2012-12-28\/opensmtpd-ssl-relay-stuff\/","publisher":{"@type":"Organization","name":"https:\/\/poolp.org\/","logo":{"@type":"ImageObject","url":"https:\/\/poolp.org\/","height":60,"width":60}}}</script><meta property="og:title" content="OpenSMTPD: SSL & relay stuff"><meta property="og:description" content="OHAI,
I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.
I still don&rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he&rsquo;ll write about it if he wants to or I&rsquo;ll do that next time."><meta property="og:url" content="https://poolp.org/posts/2012-12-28/opensmtpd-ssl-relay-stuff/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=twitter:title content="OpenSMTPD: SSL & relay stuff"><meta name=twitter:description content="OHAI,
I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.
I still don&rsquo;t have a desk so I will make this short by not …"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta property="og:url" content="https://poolp.org/posts/2012-12-28/opensmtpd-ssl-relay-stuff/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=generator content="Hugo 0.83.0"><link rel=alternate href=https://poolp.org/index.xml type=application/rss+xml title=poolp.org><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://poolp.org/css/main.css><link rel=stylesheet href=https://poolp.org/css/highlight.min.css><link rel=stylesheet href=https://poolp.org/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=/css/poolp.css></head><body><div class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><a class=navbar-brand href=https://poolp.org/ target=_blank>p<font color=#ff0000>oo</font>lp.org</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li class=navlinks-container><a class=navlinks-parent>Freelance</a><div class=navlinks-children><a href=/en/contracting/>[en] Hire me !</a>
<a href=/fr/contracting/>[fr] Recrutez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Social</a><div class=navlinks-children><a href=https://patreon.com/gilles>Patreon</a>
<a href=https://www.linkedin.com/in/gilleschehade>LinkedIn</a>
<a href=https://github.com/poolpOrg>Github</a>
<a href=https://twitter.com/poolpOrg>Twitter</a></div></li><li class=navlinks-container><a class=navlinks-parent>Curriculum</a><div class=navlinks-children><a href=https://github.com/poolpOrg/resume/blob/master/resume.en.pdf>EN</a>
<a href=https://github.com/poolpOrg/resume/blob/master/resume.fr.pdf>FR</a></div></li><li><a title=Hypnose href=https://hypno.cat>Hypnose</a></li></ul></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div><div class=posts-heading><h1 style=text-align:left>OpenSMTPD: SSL & relay stuff</h1></div></div></div></div></div></header><div class=container-fluid role=main><div class=row><div class=col-lg-12><article role=main class=blog-post><p>OHAI,</p><p>I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.</p><p>I still don&rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he&rsquo;ll write about it if he wants to or I&rsquo;ll do that next time.</p><p>You guys enjoy New Year&rsquo;s Eve, don&rsquo;t get too drunk and remember to send tons of mails to those not around using an awesome piece of software :-p</p><p>SSL verification and separation</p><p>OpenSMTPD has had code to deal with establishing secure channels for a very long time now, however what it didn&rsquo;t do was to perform certificate chain verification in both server and client modes. In server mode, it would never request a client certificate and in client mode it would never check that the certificate handed by the server was valid.</p><p>So I started adding support and hit the first issue: access to the CA bundle from within the chroot. After a discussion with reyk@ over what was the best way to deal with it, he convinced me that we could really improve our design by moving certs and keys from network-facing processes to a separate process and performing on-demand requests.</p><p>Dealing with OpenSSL was as nice as usual, it almost seemed like sharing a tasty dinner with Richard Stallman, but I eventually saw the light and got it to work as expected. The good part is that the client and server modes have symmetric operations which means that the code is identical for the most part.</p><p>We now have the sensitive stuff isolated in the lookup process. The smtp and mta processes use the imsg framework to request them and to pass over chains for verifications. It all fits in a very few lines of code which is cool because the less OpenSSL code I have to deal with, the better.</p><p>For now, we don&rsquo;t do a full verification of the X509 attributes so OpenSMTPD lies about the verification and pretends it didn&rsquo;t do it in the Received lines, however the admin can see the verification take place in the logs. I&rsquo;ll fix the Received line to tell the truth when I&rsquo;m confident the verification is 100% accurate.</p><p>Now, before I switch subject, a couple related ideas for the future:</p><p>If we were to provide a K_CERT table service, we could fetch the certificates and chains from custom backends (ldap, sql, you name it, &mldr;), this would take approximately one hour of work. The only reason I&rsquo;m not doing it is that I don&rsquo;t have a need for that at the moment ;-)</p><p>Also, the certificate verification reply to mta and smtp is a simple status that is either success or failure. This means that implementing a certificate-based authentication is now trivial, probably an hour of work too. Guess why I didn&rsquo;t implement it yet ?</p><p>Fix relaying logic</p><p>While working on the SSL code, I spotted strange behaviour when relaying between my primary and secondary MX.</p><p>After some testing, I realized that we lost the &ldquo;backup&rdquo; flag somewhere. After a quick chat with eric@, I convinced him we should introduce the backup:// schema and get rid of the flag in the envelope. This way, we could make it obvious that mx2.poolp.org is a backup MX by having backup://mx2.poolp.org as a relay URL.</p><p>Then, I spotted some strange issues where I didn&rsquo;t request TLS and it would attempt it, or where I requested TLS but it would fallback to plaintext. It became obvious there was something fishy with the semantic of our relay URL schemas and that they needed to be more clearly defined.</p><p>After going through every possible schema, we defined them as follow:</p><p>smtp+tls:// -> attempt TLS, then fallback to plaintext, this is the default smtp:// -> plain text ONLY, no encryption tls:// -> STARTTLS only, encrypted channel guaranteed smtps:// -> SMTPS only, encrypted channel guaranteed ssl:// -> STARTTLS, fallback to SMTPS, encrypted channel guaranteed</p><p>With this, unless smtp+tls:// is specified, we never fallback to plaintext if an encrypted channel is requested and we never break the user assumption that a relaying will be secure by sending the data over a plaintext channel.</p><p>I guess that&rsquo;s all for this time, I really need to zZzZ</p><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f&text=OpenSMTPD%3a%20SSL%20%26%20relay%20stuff&via=poolpOrg" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f&title=OpenSMTPD%3a%20SSL%20%26%20relay%20stuff" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f&title=OpenSMTPD%3a%20SSL%20%26%20relay%20stuff" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f&title=OpenSMTPD%3a%20SSL%20%26%20relay%20stuff" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://poolp.org/posts/2012-12-14/opensmtpd-ldap-support-selectable-source-dkim-and-goodies/ data-toggle=tooltip data-placement=top title="OpenSMTPD: LDAP support, selectable source, DKIM and Goodies">&larr; Previous Post</a></li><li class=next><a href=https://poolp.org/posts/2013-01-08/welcome-to-you-2013/ data-toggle=tooltip data-placement=top title="Welcome to you, 2013">Next Post &rarr;</a></li></ul></div></div></div><footer><p><h2>Like my work and want to help me ?</h2><ul><li>Consider <b>tipping me</b> on <b><a target=_blank href=https://paypal.me/poolpOrg>PayPal</a></b>,
<b>supporting me</b> through one of the <b>sponsoring</b> platforms at <b><a href=https://github.com/sponsors/poolpOrg>Github</a></b>, <b><a href=https://patreon.com/gilles>Patreon</a></b> or
<b><a href=https://liberapay.com/poolpOrg>LiberaPay</a></b>,
or even <b>getting me something</b> from my wishlist on <b><a target=_blank href=http://amzn.eu/3MwH6CX>Amazon</a></b>
for positive <b><a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a></b> :-)<br></li><li>You can also help me by <b>commenting articles</b> to spark discussions,
and by <b>sharing them</b> so they reach a bigger audience,
they all contain a comment link and icons that will let you share to popular social networks.</li></ul></p><p class="credits copyright text-muted"><a href=https://poolp.org>Gilles Chehade</a>
-&nbsp;&copy;
2021
-
<a href=https://poolp.org/>poolp.org</a></p><p class="credits theme-by text-muted"><a href=http://gohugo.io>Hugo v0.83.0</a> powered - adapted from a weird mix of <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>, <a href=https://papercss-hugo-theme.netlify.app/>PaperCss</a> and some <a href=https://github.com/davidrzs/latexcss>LatexCSS</a></p></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://poolp.org/js/main.js></script><script src=https://poolp.org/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script></body></html>