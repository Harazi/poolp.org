<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.104.3"><link rel=icon href=/images/poolp_org.png><title>OpenSMTPD: SSL & relay stuff | poolp.org</title><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenSMTPD: SSL & relay stuff"><meta name=twitter:description content="OHAI,
I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.
I still don&rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he&rsquo;ll write about it if he wants to or I&rsquo;ll do that next time."><meta property="og:title" content="OpenSMTPD: SSL & relay stuff"><meta property="og:description" content="OHAI,
I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.
I still don&rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he&rsquo;ll write about it if he wants to or I&rsquo;ll do that next time."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2012-12-28/opensmtpd-ssl-relay-stuff/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-12-28T20:11:23+00:00"><meta property="article:modified_time" content="2012-12-28T20:11:23+00:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://discord.gg/YC6j4rbvSk>Discord</a></li><li class=nav-item><a class=nav-link href=https://www.youtube.com/channel/UCU-1Rn7gWhessHWwC3_EsEg>Youtube</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li><li class=nav-item><a class=nav-link href=/authors/gilles-chehade>About Me</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=OpenSMTPD%3a%20SSL%20%26%20relay%20stuff&url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1'><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-12-28%2fopensmtpd-ssl-relay-stuff%2f" onclick='return window.open(this.href,"xing-share","width=550,height=435"),!1'><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade / جيل شحادة"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade / جيل شحادة</a><br><span class=author-description>foobarbaz-ing since 1981<br></span><br><span class=author-description><i class="far fa-star"></i>
Dec 28, 2012
<i class="far fa-clock clock"></i>
4 min read</span></div></div><div class=after-post-tags><ul class=tags></ul></div><h1 class=posttitle>OpenSMTPD: SSL & relay stuff</h1><b><a class="far fa-comment" href=#comments>go to comments</a></b><br><br></div><div class=article-post><p>OHAI,</p><p>I was unable to write a story last week as my desk broke into pieces for no apparent reason but my foot hitting it accidentally.</p><p>I still don&rsquo;t have a desk so I will make this short by not telling about the queue profiling and SQL log conversion I wrote, and not even writing about the filter work done by Eric, he&rsquo;ll write about it if he wants to or I&rsquo;ll do that next time.</p><p>You guys enjoy New Year&rsquo;s Eve, don&rsquo;t get too drunk and remember to send tons of mails to those not around using an awesome piece of software :-p</p><p>SSL verification and separation</p><p>OpenSMTPD has had code to deal with establishing secure channels for a very long time now, however what it didn&rsquo;t do was to perform certificate chain verification in both server and client modes. In server mode, it would never request a client certificate and in client mode it would never check that the certificate handed by the server was valid.</p><p>So I started adding support and hit the first issue: access to the CA bundle from within the chroot. After a discussion with reyk@ over what was the best way to deal with it, he convinced me that we could really improve our design by moving certs and keys from network-facing processes to a separate process and performing on-demand requests.</p><p>Dealing with OpenSSL was as nice as usual, it almost seemed like sharing a tasty dinner with Richard Stallman, but I eventually saw the light and got it to work as expected. The good part is that the client and server modes have symmetric operations which means that the code is identical for the most part.</p><p>We now have the sensitive stuff isolated in the lookup process. The smtp and mta processes use the imsg framework to request them and to pass over chains for verifications. It all fits in a very few lines of code which is cool because the less OpenSSL code I have to deal with, the better.</p><p>For now, we don&rsquo;t do a full verification of the X509 attributes so OpenSMTPD lies about the verification and pretends it didn&rsquo;t do it in the Received lines, however the admin can see the verification take place in the logs. I&rsquo;ll fix the Received line to tell the truth when I&rsquo;m confident the verification is 100% accurate.</p><p>Now, before I switch subject, a couple related ideas for the future:</p><p>If we were to provide a K_CERT table service, we could fetch the certificates and chains from custom backends (ldap, sql, you name it, &mldr;), this would take approximately one hour of work. The only reason I&rsquo;m not doing it is that I don&rsquo;t have a need for that at the moment ;-)</p><p>Also, the certificate verification reply to mta and smtp is a simple status that is either success or failure. This means that implementing a certificate-based authentication is now trivial, probably an hour of work too. Guess why I didn&rsquo;t implement it yet ?</p><p>Fix relaying logic</p><p>While working on the SSL code, I spotted strange behaviour when relaying between my primary and secondary MX.</p><p>After some testing, I realized that we lost the &ldquo;backup&rdquo; flag somewhere. After a quick chat with eric@, I convinced him we should introduce the backup:// schema and get rid of the flag in the envelope. This way, we could make it obvious that mx2.poolp.org is a backup MX by having backup://mx2.poolp.org as a relay URL.</p><p>Then, I spotted some strange issues where I didn&rsquo;t request TLS and it would attempt it, or where I requested TLS but it would fallback to plaintext. It became obvious there was something fishy with the semantic of our relay URL schemas and that they needed to be more clearly defined.</p><p>After going through every possible schema, we defined them as follow:</p><p>smtp+tls:// -> attempt TLS, then fallback to plaintext, this is the default smtp:// -> plain text ONLY, no encryption tls:// -> STARTTLS only, encrypted channel guaranteed smtps:// -> SMTPS only, encrypted channel guaranteed ssl:// -> STARTTLS, fallback to SMTPS, encrypted channel guaranteed</p><p>With this, unless smtp+tls:// is specified, we never fallback to plaintext if an encrypted channel is requested and we never break the user assumption that a relaying will be secure by sending the data over a plaintext channel.</p><p>I guess that&rsquo;s all for this time, I really need to zZzZ</p></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2013-01-08/welcome-to-you-2013/>&#171; Welcome to you, 2013</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2012-12-14/opensmtpd-ldap-support-selectable-source-dkim-and-goodies/>OpenSMTPD: LDAP support, selectable source, DKIM and Goodies &#187;</a><div class=clearfix></div></div></div></div></div><div class=container><div id=comments class="row justify-content-center mb-5"><div class=col-md-8><script src=https://giscus.app/client.js data-repo=poolpOrg/poolp.org data-repo-id="MDEwOlJlcG9zaXRvcnkxMjYxODk2MjA=" data-category=Articles data-category-id=DIC_kwDOB4WANM4B-Zf1 data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></div></div><div class=alertbar><div class="container text-center"><span><img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)</span></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright poolp.org - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script></body></html>