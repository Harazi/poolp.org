<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>OpenSMTPD proc filters & fc-rDNS - poolp.org</title><meta property="og:title" content="OpenSMTPD proc filters & fc-rDNS"><meta name=twitter:title content="OpenSMTPD proc filters & fc-rDNS"><meta name=description content="TL;DR: I *FINALFUCKINGLY* commited proc filters support allowing full filtering in OpenSMTPD. eric@ implemented fc-rDNS lookups.  fc-rDNS fc-rDNS, or forward-confirmed reverse DNS, consists in performing a reverse DNS lookup to determine the hostname associated to an IP address&mldr; then performing a DNS lookup on that hostname to check if it resolves back to the IP address.
On my request, eric@ implemented fc-rDNS lookups in our SMTP engine, causing OpenSMTPD to perform the double lookup upon clients connections."><meta property="og:description" content="TL;DR: I *FINALFUCKINGLY* commited proc filters support allowing full filtering in OpenSMTPD. eric@ implemented fc-rDNS lookups.  fc-rDNS fc-rDNS, or forward-confirmed reverse DNS, consists in performing a reverse DNS lookup to determine the hostname associated to an IP address&mldr; then performing a DNS lookup on that hostname to check if it resolves back to the IP address.
On my request, eric@ implemented fc-rDNS lookups in our SMTP engine, causing OpenSMTPD to perform the double lookup upon clients connections."><meta name=twitter:description content="TL;DR: I *FINALFUCKINGLY* commited proc filters support allowing full filtering in OpenSMTPD. eric@ implemented fc-rDNS lookups.  fc-rDNS fc-rDNS, or forward-confirmed reverse DNS, consists in …"><meta name=author content="Gilles Chehade"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"poolp.org","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/poolp.org\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/poolp.org\/posts\/2018-12-06\/opensmtpd-proc-filters-fc-rdns\/","name":"Open SMTP d proc filters \u0026 fc r DNS"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Gilles Chehade"},"headline":"OpenSMTPD proc filters \u0026 fc-rDNS","description":"TL;DR: I *FINALFUCKINGLY* commited proc filters support allowing full filtering in OpenSMTPD. eric@ implemented fc-rDNS lookups.  fc-rDNS fc-rDNS, or forward-confirmed reverse DNS, consists in performing a reverse DNS lookup to determine the hostname associated to an IP address\u0026hellip; then performing a DNS lookup on that hostname to check if it resolves back to the IP address.\nOn my request, eric@ implemented fc-rDNS lookups in our SMTP engine, causing OpenSMTPD to perform the double lookup upon clients connections.","inLanguage":"en","wordCount":652,"datePublished":"2018-12-06T21:31:00","dateModified":"2018-12-06T21:31:00","image":"https:\/\/poolp.org\/","keywords":[""],"mainEntityOfPage":"https:\/\/poolp.org\/posts\/2018-12-06\/opensmtpd-proc-filters-fc-rdns\/","publisher":{"@type":"Organization","name":"https:\/\/poolp.org\/","logo":{"@type":"ImageObject","url":"https:\/\/poolp.org\/","height":60,"width":60}}}</script><meta property="og:title" content="OpenSMTPD proc filters & fc-rDNS"><meta property="og:description" content="TL;DR: I *FINALFUCKINGLY* commited proc filters support allowing full filtering in OpenSMTPD. eric@ implemented fc-rDNS lookups.  fc-rDNS fc-rDNS, or forward-confirmed reverse DNS, consists in performing a reverse DNS lookup to determine the hostname associated to an IP address&mldr; then performing a DNS lookup on that hostname to check if it resolves back to the IP address.
On my request, eric@ implemented fc-rDNS lookups in our SMTP engine, causing OpenSMTPD to perform the double lookup upon clients connections."><meta property="og:url" content="https://poolp.org/posts/2018-12-06/opensmtpd-proc-filters-fc-rdns/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=twitter:title content="OpenSMTPD proc filters & fc-rDNS"><meta name=twitter:description content="TL;DR: I *FINALFUCKINGLY* commited proc filters support allowing full filtering in OpenSMTPD. eric@ implemented fc-rDNS lookups.  fc-rDNS fc-rDNS, or forward-confirmed reverse DNS, consists in …"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta property="og:url" content="https://poolp.org/posts/2018-12-06/opensmtpd-proc-filters-fc-rdns/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=generator content="Hugo 0.82.1"><link rel=alternate href=https://poolp.org/index.xml type=application/rss+xml title=poolp.org><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://poolp.org/css/main.css><link rel=stylesheet href=https://poolp.org/css/highlight.min.css><link rel=stylesheet href=https://poolp.org/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=/css/poolp.css></head><body><div class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#main-navbar aria-controls=main-navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=https://poolp.org/ target=_blank>p<font color=#ff0000>oo</font>lp.org</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li class=navlinks-container><a class=navlinks-parent>Freelance</a><div class=navlinks-children><a href=/en/contracting/>[en] Hire me !</a>
<a href=/fr/contracting/>[fr] Recrutez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Social</a><div class=navlinks-children><a href=https://patreon.com/gilles>Patreon</a>
<a href=https://www.linkedin.com/in/gilleschehade>LinkedIn</a>
<a href=https://github.com/poolpOrg>Github</a>
<a href=https://twitter.com/poolpOrg>Twitter</a></div></li><li class=navlinks-container><a class=navlinks-parent>Curriculum</a><div class=navlinks-children><a href=https://github.com/poolpOrg/resume/blob/master/resume.en.pdf>EN</a>
<a href=https://github.com/poolpOrg/resume/blob/master/resume.fr.pdf>FR</a></div></li><li><a title=Hypnose href=https://hypno.cat>Hypnose</a></li></ul></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div><div class=posts-heading><h1 style=text-align:left>OpenSMTPD proc filters & fc-rDNS</h1></div></div></div></div></div></header><div class=container role=main><div class=row><div class=col-lg-12><article role=main class=blog-post><pre><code>TL;DR:
I *FINALFUCKINGLY* commited proc filters support allowing full filtering in OpenSMTPD.
eric@ implemented fc-rDNS lookups.
</code></pre><h2 id=fc-rdns>fc-rDNS</h2><p>fc-rDNS,
or forward-confirmed reverse DNS,
consists in performing a reverse DNS lookup to determine the hostname associated to an IP address&mldr;
then performing a DNS lookup on that hostname to check if it resolves back to the IP address.</p><p>On my request,
eric@ implemented fc-rDNS lookups in our SMTP engine,
causing OpenSMTPD to perform the double lookup upon clients connections.</p><p>Right now,
the fc-rDNS result is only passed to the reporting API but the idea is to allow using it in a builtin filter,
something along the lines of <code>filter smtp-in connect check-fcrdns disconnect "550 go away punk"</code>.</p><p>Note that this is <em>particularly</em> efficient at cutting spam,
it essentially means that a spammer must control both the DNS and reverse DNS zone to pass the test,
killing the bulk of zombified spam proxies living on infected home computers.</p><p>There is still some refining to do and the plugging of a builtin-filter,
but the code is here and -current users will be able to test it soon</p><h2 id=tx-mail-and-tx-rcpt-events>tx-mail and tx-rcpt events</h2><p>I have added two new reporting events for smtp-in and smtp-out: <code>tx-mail</code> and <code>tx-rcpt</code>.</p><p>They are generated whenever <code>MAIL FROM</code> or <code>RCPT TO</code> have received a result from the server:</p><pre><code>report|1|1544130229|smtp-in|tx-mail|0f3004c08c82d33e|fc08ce7d|&lt;owner-hackers+M85937=gilles=poolp.org@openbsd.org&gt;|ok
report|1|1544130229|smtp-in|tx-rcpt|0f3004c08c82d33e|fc08ce7d|&lt;gilles@poolp.org&gt;|ok
</code></pre><p>A filter may listen for these events to determine which sender and recipients have been accepted in a transaction,
something that would otherwise require keeping track of protocol-client and protocol-server events.</p><h2 id=proc-filtering-finally-in>proc filtering finally in</h2><p>I have committed full proc filtering support today,
allowing a standalone filter to perform all kind of filtering on every single phase of an SMTP session.</p><p>This means that with the code in -current,
it is now possible to write a filter that talks to rspamd or that computes dkim signatures,
something that was not doable until today without resorting to tricky setups.</p><p>The code is still a work in progress,
we have things to clean up, improve and there are some known minor issues that we are working on.
We will likely hit corner cases that will cause new issues&mldr;
but this is a fully working implementation, the real deal, not a PoC.
Consider it as &ldquo;in a process of stabilization to be production ready by April&rdquo;.</p><p>When we have stabilized the API,
I&rsquo;ll take time to write about how it works internally,
for now let&rsquo;s just celebrate because I FINALLY FUCKING COMMITED FILTERS.</p><h2 id=python-bridge-proof-of-concept>python bridge, proof of concept</h2><p>As I wrote in a previous post,
proc filters are programs reading on stdin and writing to stdout,
making it possible write them in any language.</p><p>I put my code where my mouth is:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>opensmtpd</span>

<span class=k>def</span> <span class=nf>link_connect</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>rdns</span><span class=p>,</span> <span class=n>fcrdns</span><span class=p>,</span> <span class=n>laddr</span><span class=p>,</span> <span class=n>raddr</span> <span class=o>=</span> <span class=n>args</span>

<span class=k>def</span> <span class=nf>link_disconnect</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>_</span> <span class=o>=</span> <span class=n>args</span>

<span class=k>def</span> <span class=nf>tx_begin</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>tx_id</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

<span class=k>def</span> <span class=nf>tx_mail</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>tx_id</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>status</span> <span class=o>=</span> <span class=n>args</span>

<span class=k>def</span> <span class=nf>tx_rcpt</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>tx_id</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>status</span> <span class=o>=</span> <span class=n>args</span>

<span class=k>def</span> <span class=nf>tx_envelope</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>tx_id</span><span class=p>,</span> <span class=n>evp_id</span> <span class=o>=</span> <span class=n>args</span>
    
<span class=k>def</span> <span class=nf>tx_rollback</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>tx_id</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

<span class=k>def</span> <span class=nf>tx_commit</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>tx_id</span><span class=p>,</span> <span class=n>nbytes</span> <span class=o>=</span> <span class=n>args</span>

<span class=k>def</span> <span class=nf>protocol_client</span><span class=p>(</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>session_id</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
    <span class=n>line</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span>
    <span class=n>o</span> <span class=o>=</span> <span class=n>opensmtpd</span><span class=o>.</span><span class=n>SMTP_IN</span><span class=p>()</span>

    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;link-connect&#39;</span><span class=p>,</span> <span class=n>link_connect</span><span class=p>)</span>
    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;link-disconnect&#39;</span><span class=p>,</span> <span class=n>link_disconnect</span><span class=p>)</span>

    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;tx-begin&#39;</span><span class=p>,</span> <span class=n>tx_begin</span><span class=p>)</span>
    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;tx-mail&#39;</span><span class=p>,</span> <span class=n>tx_mail</span><span class=p>)</span>
    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;tx-rcpt&#39;</span><span class=p>,</span> <span class=n>tx_rcpt</span><span class=p>)</span>
    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;tx-envelope&#39;</span><span class=p>,</span> <span class=n>tx_envelope</span><span class=p>)</span>
    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;tx-commit&#39;</span><span class=p>,</span> <span class=n>tx_commit</span><span class=p>)</span>
    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;tx-rollback&#39;</span><span class=p>,</span> <span class=n>tx_rollback</span><span class=p>)</span>

    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;protocol-client&#39;</span><span class=p>,</span> <span class=n>protocol_client</span><span class=p>)</span>
    <span class=n>o</span><span class=o>.</span><span class=n>on_report</span><span class=p>(</span><span class=s1>&#39;protocol-server&#39;</span><span class=p>,</span> <span class=n>protocol_server</span><span class=p>)</span>

    <span class=n>o</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</code></pre></div><p>This only covers the callback API for &ldquo;report&rdquo; events,
but it does so thanks to an opensmtpd package that consists of less than 100 lines of code.</p><p>I will be implementing the <code>on_filter</code> callback API probably next week,
so I can start writing the filters I need in python.</p><p>If you want to discuss how to write an interface for the language of your choice,
feel free to jump to our IRC channel, #opensmtpd @ freenode ;-)</p><h2 id=what-next->What next ?</h2><p>Essentially code cleanup and simplification,
API stabilization and writing filters to spot improvements required in the API.</p><p>Stay tuned !</p><hr><p>Comments: <a href=https://github.com/poolpOrg/poolp.org/issues/53>https://github.com/poolpOrg/poolp.org/issues/53</a></p><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpoolp.org%2fposts%2f2018-12-06%2fopensmtpd-proc-filters-fc-rdns%2f&text=OpenSMTPD%20proc%20filters%20%26%20fc-rDNS&via=poolpOrg" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2018-12-06%2fopensmtpd-proc-filters-fc-rdns%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2018-12-06%2fopensmtpd-proc-filters-fc-rdns%2f&title=OpenSMTPD%20proc%20filters%20%26%20fc-rDNS" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpoolp.org%2fposts%2f2018-12-06%2fopensmtpd-proc-filters-fc-rdns%2f&title=OpenSMTPD%20proc%20filters%20%26%20fc-rDNS" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2018-12-06%2fopensmtpd-proc-filters-fc-rdns%2f&title=OpenSMTPD%20proc%20filters%20%26%20fc-rDNS" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://poolp.org/posts/2018-11-09/opensmtpd-reporting-update/ data-toggle=tooltip data-placement=top title="OpenSMTPD reporting update">&larr; Previous Post</a></li><li class=next><a href=https://poolp.org/posts/2018-12-19/more-on-opensmtpd-filters/ data-toggle=tooltip data-placement=top title="more on OpenSMTPD filters">Next Post &rarr;</a></li></ul></div></div></div><footer><p><h2>Like my work and want to help me ?</h2><ul><li>Consider <b>tipping me</b> on <b><a target=_blank href=https://paypal.me/poolpOrg>PayPal</a></b>,
<b>supporting me</b> through one of the <b>sponsoring</b> platforms at <b><a href=https://github.com/sponsors/poolpOrg>Github</a></b>, <b><a href=https://patreon.com/gilles>Patreon</a></b> or
<b><a href=https://liberapay.com/poolpOrg>LiberaPay</a></b>,
or even <b>getting me something</b> from my wishlist on <b><a target=_blank href=http://amzn.eu/3MwH6CX>Amazon</a></b>
for positive <b><a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a></b> :-)<br></li><li>You can also help me by <b>commenting articles</b> to spark discussions,
and by <b>sharing them</b> so they reach a bigger audience,
they all contain a comment link and icons that will let you share to popular social networks.</li></ul></p><p class="credits copyright text-muted"><a href=https://poolp.org>Gilles Chehade</a>
-&nbsp;&copy;
2021
-
<a href=https://poolp.org/>poolp.org</a></p><p class="credits theme-by text-muted"><a href=http://gohugo.io>Hugo v0.82.1</a> powered - adapted from a weird mix of <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>, <a href=https://papercss-hugo-theme.netlify.app/>PaperCss</a> and some <a href=https://github.com/davidrzs/latexcss>LatexCSS</a></p></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://poolp.org/js/main.js></script><script src=https://poolp.org/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script></body></html>