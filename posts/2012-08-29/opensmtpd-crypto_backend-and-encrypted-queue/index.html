<!doctype html><html lang=en-us><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.4">
<link rel=icon href=/images/poolp_org.png>
<title>OpenSMTPD: crypto_backend and encrypted queue | poolp.org</title>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="OpenSMTPD: crypto_backend and encrypted queue">
<meta name=twitter:description content="A few days ago, Charles committed the compress_backend API which allowed transparent deflation/inflation of envelopes and messages as they hit the queue.
The compression code is executed before the queue_backend gets the data so that any queue_backend can benefit transparently from compression without having to add any code to handle it. Due to our design, this also means that if the queue_backend stores envelopes and messages remotely, then the compression will take place before sending and after fetching, the remote end only ever sees compressed data.">
<meta property="og:title" content="OpenSMTPD: crypto_backend and encrypted queue">
<meta property="og:description" content="A few days ago, Charles committed the compress_backend API which allowed transparent deflation/inflation of envelopes and messages as they hit the queue.
The compression code is executed before the queue_backend gets the data so that any queue_backend can benefit transparently from compression without having to add any code to handle it. Due to our design, this also means that if the queue_backend stores envelopes and messages remotely, then the compression will take place before sending and after fetching, the remote end only ever sees compressed data.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://poolp.org/posts/2012-08-29/opensmtpd-crypto_backend-and-encrypted-queue/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2012-08-29T10:21:59+00:00">
<meta property="article:modified_time" content="2012-08-29T10:21:59+00:00">
<link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous>
<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet>
<link href=/css/medium.css rel=stylesheet>
<link href=/css/additional.css rel=stylesheet>
<link href=/css/syntax.css rel=stylesheet>
<link href=/css/custom.css rel=stylesheet>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
<div class="container pr-0">
<a class=navbar-brand href=https://poolp.org/>
<img src=/images/poolp_org.png alt=logo>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarMediumish>
<ul class="navbar-nav ml-auto">
<li class=nav-item>
<a class=nav-link href=/fr/contracting/>Freelance</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://hypno.cat>Hypnose</a>
</li>
<li class=nav-item>
<a class=nav-link href=/authors/gilles-chehade>About Me</a>
</li>
</ul>
</div>
</div>
</nav>
<div class=site-content>
<div class=container>
<div class=mainheading>
</div><div class=main-content>
<div class=container>
<div class=row>
<div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset">
<p>Share</p>
<ul>
<li class="ml-1 mr-1">
<a target=_blank href="https://twitter.com/intent/tweet?text=OpenSMTPD%3a%20crypto_backend%20and%20encrypted%20queue&url=https%3a%2f%2fpoolp.org%2fposts%2f2012-08-29%2fopensmtpd-crypto_backend-and-encrypted-queue%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=435'),!1">
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="ml-1 mr-1">
<a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2012-08-29%2fopensmtpd-crypto_backend-and-encrypted-queue%2f" onclick="return window.open(this.href,'facebook-share','width=550,height=435'),!1">
<i class="fab fa-facebook-f"></i>
</a>
</li>
<li class="ml-1 mr-1">
<a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-08-29%2fopensmtpd-crypto_backend-and-encrypted-queue%2f" onclick="return window.open(this.href,'xing-share','width=550,height=435'),!1">
<i class="fab fa-xing"></i>
</a>
</li>
</ul>
</div>
</div>
<div class="col-md-9 flex-first flex-md-unordered">
<div class=mainheading>
<div class="row post-top-meta">
<div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right">
<img class=author-thumb src=/images/me.png alt="Gilles Chehade / حيل شحادة">
</div>
<div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left">
<a target=_blank class=link-dark>Gilles Chehade / حيل شحادة</a><br>
<span class=author-description>
foobarbaz-ing since 1981<br>
</span>
<br>
<span class=author-description>
<i class="far fa-star"></i>
Aug 29, 2012
<i class="far fa-clock clock"></i>
2 min read
</span>
</div>
</div>
<div class=after-post-tags>
<ul class=tags>
</ul>
</div>
<h1 class=posttitle>OpenSMTPD: crypto_backend and encrypted queue</h1>
</div>
<div class=article-post>
<p>A few days ago, Charles committed the compress_backend API which allowed transparent deflation/inflation of envelopes and messages as they hit the queue.</p>
<p>The compression code is executed before the queue_backend gets the data so that any queue_backend can benefit transparently from compression without having to add any code to handle it. Due to our design, this also means that if the queue_backend stores envelopes and messages remotely, then the compression will take place before sending and after fetching, the remote end only ever sees compressed data.</p>
<p>The idea with the compress_backend was to not only to save disk-space on the queue, which is a very worthy improvement for hosts that deal with very large queues; but also to prove a point: the queue_backends can be made agnostic of the envelopes and messages content, effectively handling blobs.</p>
<p>And a side-effect of that is that since queue_backends don&rsquo;t need to inspect envelopes and messages, and since they can store data remotely, we could provide full queue encryption and ensure that the remote end only ever sees encrypted data.</p>
<p>The crypto_backend provides a transparent encryption/decryption service that can be used in any part of OpenSMTPD. As of now, the queue is the only consumer but we already have other use-cases and probably some ideas we haven&rsquo;t come up with yet will pop-up months from now ;-)</p>
<p>Of course, encryption is tricky so the configuration is hard &mldr; NOT !</p>
<p><b>queue encryption key &ldquo;foobar&rdquo;</b>
This will enable transparent encryption of the queue using Blowfish in CBC mode with a random IV and will internally expand the key &ldquo;foobar&rdquo; using sha256. This is just to provide sane defaults, one could override the cipher and digest using the following:</p>
<p><b>queue encryption key &ldquo;foobar&rdquo; cipher aes-128-cbc digest sha512</b>
The IV is randomly chosen for every envelope and message, it is then encrypted and prepended to the message. This ensures that the same key used to encrypt the same envelope will produce different output.</p>
<p>Things will still be improved further but in my opinion it is already covering the use-cases of many who would need an encrypted queue, and to be honest with a quick look on the intertubez I couldn&rsquo;t find a competitor to compare to on that particular feature so we&rsquo;ll move it forward as we hit use-cases.</p>
<p>Oh&mldr; and of course this does work along the compression support so you can have both encryption and compression enabled.</p>
<p>This should hit the OpenBSD tree pretty shortly, this evening for sure.</p>
</div>
<div class="row PageNavigation d-flex justify-content-between font-weight-bold">
<a class="d-block col-md-6" href=https://poolp.org/posts/2012-08-31/opensmtpd-crypto/compress-fixes-and-import-initial-stab-at-ldap/> &#171; OpenSMTPD: crypto/compress fixes and import initial stab at LDAP</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2012-08-26/opensmtpd-i-have-no-idea-for-that-title-sorry/>OpenSMTPD: I have no idea for that title, sorry &#187;</a>
<div class=clearfix></div>
</div>
</div>
</div>
</div>
</div>
<div class=alertbar>
<div class="container text-center">
<span>
<img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)
</span>
</div>
</div>
</div>
<footer class=footer>
<div class=container>
<div class=row>
<div class="col-md-6 col-sm-6 text-center text-lg-left">
&copy; Copyright poolp.org - All rights reserved
</div>
<div class="col-md-6 col-sm-6 text-center text-lg-right">
<a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net
</div>
</div>
</div>
</footer>
</div>
<script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script>
</body>
</html>