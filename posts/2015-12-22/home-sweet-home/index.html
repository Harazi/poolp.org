<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Home, sweet home - poolp.org</title><meta property="og:title" content="Home, sweet home"><meta name=twitter:title content="Home, sweet home"><meta name=description content="TL;DR: OpenSMTPD on github no longer diverges from OpenBSD.  Since last episode Sometime this year, we released OpenSMTPD 5.7.1 which was the first version that shipped with the long-awaited experimental filters support. The result of over a year and a half of very very deep refactor in our IO layer and the addition of a very elegant but also very tricky new API.
This refactor took place outside the OpenBSD tree because it required breaking a lot of code for extended period of times, which spanned over 3 OpenBSD releases."><meta property="og:description" content="TL;DR: OpenSMTPD on github no longer diverges from OpenBSD.  Since last episode Sometime this year, we released OpenSMTPD 5.7.1 which was the first version that shipped with the long-awaited experimental filters support. The result of over a year and a half of very very deep refactor in our IO layer and the addition of a very elegant but also very tricky new API.
This refactor took place outside the OpenBSD tree because it required breaking a lot of code for extended period of times, which spanned over 3 OpenBSD releases."><meta name=twitter:description content="TL;DR: OpenSMTPD on github no longer diverges from OpenBSD.  Since last episode Sometime this year, we released OpenSMTPD 5.7.1 which was the first version that shipped with the long-awaited …"><meta name=author content="Gilles Chehade"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"poolp.org","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/poolp.org\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/poolp.org\/posts\/2015-12-22\/home-sweet-home\/","name":"Home, sweet home"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Gilles Chehade"},"headline":"Home, sweet home","description":"TL;DR: OpenSMTPD on github no longer diverges from OpenBSD.  Since last episode Sometime this year, we released OpenSMTPD 5.7.1 which was the first version that shipped with the long-awaited experimental filters support. The result of over a year and a half of very very deep refactor in our IO layer and the addition of a very elegant but also very tricky new API.\nThis refactor took place outside the OpenBSD tree because it required breaking a lot of code for extended period of times, which spanned over 3 OpenBSD releases.","inLanguage":"en","wordCount":1242,"datePublished":"2015-12-22T09:53:01","dateModified":"2015-12-22T09:53:01","image":"https:\/\/poolp.org\/","keywords":[""],"mainEntityOfPage":"https:\/\/poolp.org\/posts\/2015-12-22\/home-sweet-home\/","publisher":{"@type":"Organization","name":"https:\/\/poolp.org\/","logo":{"@type":"ImageObject","url":"https:\/\/poolp.org\/","height":60,"width":60}}}</script><meta property="og:title" content="Home, sweet home"><meta property="og:description" content="TL;DR: OpenSMTPD on github no longer diverges from OpenBSD.  Since last episode Sometime this year, we released OpenSMTPD 5.7.1 which was the first version that shipped with the long-awaited experimental filters support. The result of over a year and a half of very very deep refactor in our IO layer and the addition of a very elegant but also very tricky new API.
This refactor took place outside the OpenBSD tree because it required breaking a lot of code for extended period of times, which spanned over 3 OpenBSD releases."><meta property="og:url" content="https://poolp.org/posts/2015-12-22/home-sweet-home/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=twitter:title content="Home, sweet home"><meta name=twitter:description content="TL;DR: OpenSMTPD on github no longer diverges from OpenBSD.  Since last episode Sometime this year, we released OpenSMTPD 5.7.1 which was the first version that shipped with the long-awaited …"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta property="og:url" content="https://poolp.org/posts/2015-12-22/home-sweet-home/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=generator content="Hugo 0.79.0"><link rel=alternate href=https://poolp.org/index.xml type=application/rss+xml title=poolp.org><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://poolp.org/css/main.css><link rel=stylesheet href=https://poolp.org/css/highlight.min.css><link rel=stylesheet href=https://poolp.org/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=/css/latex.style.css></head><body><div class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://poolp.org/ target=_blank><img src=/images/poolp_org.png alt=poolp.org height=55px></a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li class=navlinks-container><a class=navlinks-parent>Freelance</a><div class=navlinks-children><a href=/en/contracting/>[en] Hire me !</a>
<a href=/fr/contracting/>[fr] Recrutez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Sponsorship</a><div class=navlinks-children><a href=/en/sponsorship/>[en] Sponsor me !</a>
<a href=/fr/sponsorship/>[fr] Sponsorisez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Social</a><div class=navlinks-children><a href=https://patreon.com/gilles>Patreon</a>
<a href=https://www.linkedin.com/in/gilleschehade>LinkedIn</a>
<a href=https://github.com/poolpOrg>Github</a>
<a href=https://twitter.com/poolpOrg>Twitter</a></div></li><li class=navlinks-container><a class=navlinks-parent>Curriculum</a><div class=navlinks-children><a href=https://github.com/poolpOrg/resume/blob/master/resume.en.pdf>EN</a>
<a href=https://github.com/poolpOrg/resume/blob/master/resume.fr.pdf>FR</a></div></li><li><a title=Hypnose href=https://hypno.cat>Hypnose</a></li></ul></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1 style=text-align:left>Home, sweet home</h1></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><pre><code>TL;DR:
OpenSMTPD on github no longer diverges from OpenBSD.
</code></pre><h2 id=since-last-episode>Since last episode</h2><p>Sometime this year, we released OpenSMTPD 5.7.1 which was the first version that
shipped with the long-awaited experimental filters support. The result of over a
year and a half of very very deep refactor in our IO layer and the addition of a
very elegant but also very tricky new API.</p><p>This refactor took place outside the OpenBSD tree because it required breaking a
lot of code for extended period of times, which spanned over 3 OpenBSD releases.
It was near impossible to work in tree as we could not break the base daemon and
leave it in a weird state for too long, and the changes were so invasive that it
was also impossible to backout parts of it when a regression was spotted.</p><p>We eventually reached a point where it was very stable but also diverged greatly
from the daemon in base. We made a &ldquo;checkpoint&rdquo; by releasing 5.7.1 separately of
OpenBSD and the goal was now to bring the daemon in tree up to date.</p><p>The release was quickly followed by 5.7.2 and 5.7.3, fixing security issues that
were uncovered by Qualys during a coordinated audit and an issue spotted by an
independant user.</p><h2 id=bringing-back-opensmtpd-to-the-openbsd-tree>Bringing back OpenSMTPD to the OpenBSD tree</h2><p>Working off-tree came with a lot of burden, first because it cut us off from the
other OpenBSD hackers but also because it came with extra work.</p><p>For instance, during an internal audit we spotted a way to trigger a denial with
our control socket. This applied to both the version in OpenBSD and Github. Both
versions diverged quite a lot so the fix to one would not apply to the other and
of course it took place at worst point in time, when OpenBSD was so close to its
new release that 3 stable versions were tagged forcing us to test the fix on all
stable branches + current branch + github&rsquo;s master + github&rsquo;s portable.</p><p>Not to mention that every time someone submitted a pull request on Github we had
to adapt it to apply on the older version, and every time an OpenBSD hacker made
a cleanup to the older version, we had to adapt and apply to Github. This was no
fun at all, many of the contributions not applying cleanly and increasing a gap.</p><p>On another hand, it was very difficult to bring the changes back to OpenBSD as a
HUGE part of it was a refactor that could not be split into reviewable minidiffs
for other to look at it. Many small features could be split, but given that they
were written on top of the refactor, this implied that even taken independantly,
they had to be adapted to apply to the old code. This was considerable work that
caused us to defer, defer, defer, &mldr;</p><p>Finally, we reached a point where it was no longer possible to defer and I dived
back into this with help from sunil@, jung@ and millert@. I took a few days off,
spent full-time on this, and we managed to make huge progress that allowed us to
fully bring OpenBSD&rsquo;s smtpd up-to-date after a two-months effort of spliting the
delta into small reviewable chunks.</p><p>I owe all of them a very large amount of beer.</p><h2 id=openbsds-pledge>OpenBSD&rsquo;s <code>pledge()</code></h2><p>One of the most notable change that has taken place in the last months is that
we fully integrated the new OpenBSD <code>pledge()</code> system-call.</p><p>But what is <code>pledge()</code> ?</p><p><code>pledge()</code> is a new system call that will appear with OpenBSD 5.9.
What it does is allow a program to promise it will only use certain features and
allow the system to terminate the process if it doesn&rsquo;t stick to them.</p><p>For example, let&rsquo;s imagine the following program which creates a directory:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span>
<span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
	<span class=n>mkdir</span><span class=p>(</span><span class=s>&#34;/tmp/test&#34;</span><span class=p>,</span> <span class=mo>0700</span><span class=p>);</span>
	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>If you execute it, the process creates the directory as expected:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ cc test.c
$ ./a.out
$ ls -l /tmp<span class=p>|</span>grep <span class=nb>test</span>
drwx------  <span class=m>2</span> gilles    wheel    <span class=m>512</span> Dec <span class=m>22</span> 10:44 <span class=nb>test</span>
$
</code></pre></div><p>But now, let&rsquo;s imagine that the program actually makes a promise that it will
only use <code>stdio</code> features, essentially IO on previously allocated descriptors
and memory allocation so the libc basic stuff works:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span>
<span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
	<span class=n>pledge</span><span class=p>(</span><span class=s>&#34;stdio&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
	<span class=n>mkdir</span><span class=p>(</span><span class=s>&#34;/tmp/test&#34;</span><span class=p>,</span> <span class=mo>0700</span><span class=p>);</span>
	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>We run the program again:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ cc test.c
$ ./a.out
Abort <span class=nb>trap</span> <span class=o>(</span>core dumped<span class=o>)</span>
$
</code></pre></div><p>But this time, when the process calls <code>mkdir()</code> the kernel detects that it has
violated the promises made in the program and aborts execution.</p><h2 id=so-pledge-is-a-security-feature->So <code>pledge()</code> is a security feature ?</h2><p>At first it looks like <code>pledge()</code> is just a security feature to mitigate risks
and it DOES bring a very effective mitigation mechanism: an attacker who wants
to run arbitrary code in a compromised process still needs to respect promises
made by the program&mldr; in that arbitrary code&mldr;</p><p>In practice, it&rsquo;s far from being JUST a security feature, it is also a quality
feature.</p><p>When a developer converts a program to <code>pledge()</code>, he needs to understand what
features are being used, why they are being used, when they are being used and
where they are being used. If there&rsquo;s a wrong assumption, the process dies. In
addition, the promises can be shortened at runtime to restrict further.</p><p>In a project like OpenSMTPD, this is particularly interesting because it comes
with a multi-process design where different processes do specific things, each
being able to declare its own list of very reduced promises.</p><p>The daemon starts with a huge promise list to be able to setup its sockets and
processes, chroot, change privileges, do some filesystem stuff, then processes
rapidly reduce their promises down to what they will really use at runtime: in
many cases <code>stdio</code>.</p><p>Intuitively, having worked on this code base for so long, I had a pretty clear
idea of what the processes were doing at runtime so I thought it would be very
straightforward and would &ldquo;just work (c)&rdquo;.</p><p>In practice, <code>pledge()</code> pinpointed a few cases where my promises were not held
and had me investigate WHY a component needed a particular feature at runtime,
when it was not part of the promises I intuitively thought off.</p><p>Most cases were really simple to solve and a matter of doing a call just a bit
too late in the code path, but in some cases it really helped refactor code to
get rid of a feature that wasn&rsquo;t really needed.</p><p><code>pledge()</code> helps you write better code by getting a very clear feedback that a
piece of code is doing more than you think it does.</p><h2 id=whats-next->What&rsquo;s next ?</h2><p>The code in Github is now a clone of the OpenBSD CVS tree and the only delta
is a version check so that it can build on OpenBSD releases that do not have
the <code>pledge()</code> system call.</p><p>The portable branch has been sync-ed with the CVS tree but it currently does
not build as it requires a bit of plumbing. We are currently working on this
so we can resume publishing snapshots.</p><p>We&rsquo;re going to synchronize our releases with OpenBSD again so you can expect
OpenSMTPD 5.9.1 to be released when OpenBSD 5.9 is released, though there is
a chance we release an intermediate version so people can run a version that
benefits from all the cleanups, improvements and safer &ldquo;enqueuer&rdquo; before the
5.9.1 release in May.</p><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpoolp.org%2fposts%2f2015-12-22%2fhome-sweet-home%2f&text=Home%2c%20sweet%20home&via=poolpOrg" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2015-12-22%2fhome-sweet-home%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2015-12-22%2fhome-sweet-home%2f&title=Home%2c%20sweet%20home" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpoolp.org%2fposts%2f2015-12-22%2fhome-sweet-home%2f&title=Home%2c%20sweet%20home" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2015-12-22%2fhome-sweet-home%2f&title=Home%2c%20sweet%20home" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fpoolp.org%2fposts%2f2015-12-22%2fhome-sweet-home%2f&description=Home%2c%20sweet%20home" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://poolp.org/posts/2014-12-12/the-state-of-filters/ data-toggle=tooltip data-placement=top title="The state of filters">&larr; Previous Post</a></li><li class=next><a href=https://poolp.org/posts/2016-09-12/opensmtpd-6.0.0-is-released/ data-toggle=tooltip data-placement=top title="OpenSMTPD 6.0.0 is released !">Next Post &rarr;</a></li></ul></div></div></div><footer style=text-align:justify><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><h2>Like my work and want to help me ?</h2><br><ul><li>Consider <b>tipping me</b> on <b><a target=_blank href=https://paypal.me/poolpOrg>PayPal</a></b>,
<b>supporting me</b> through one of the <b><a href=/en/sponsorship>sponsorship</a></b> platforms at <b><a href=https://github.com/sponsors/poolpOrg>Github</a></b>, <b><a href=https://patreon.com/gilles>Patreon</a></b> or
<b><a href=https://liberapay.com/poolpOrg>LiberaPay</a></b>,
or even <b>getting me something</b> from my wishlist on <b><a target=_blank href=http://amzn.eu/3MwH6CX>Amazon</a></b>
for positive <b><a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a></b> :-)<br><br></li><li>You can also help me by <b>commenting articles</b> to spark discussions,
and by <b>sharing them</b> so they reach a bigger audience,
they all contain a comment link and icons that will let you share to popular social networks.</li></ul><br></div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="credits copyright text-muted"><a href=https://poolp.org>Gilles Chehade</a>
-&nbsp;&copy;
2020
-
<a href=https://poolp.org/>poolp.org</a></p><p class="credits theme-by text-muted"><a href=http://gohugo.io>Hugo v0.79.0</a> powered - Theme adapted from <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://poolp.org/js/main.js></script><script src=https://poolp.org/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0");});</script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://poolp.org/js/load-photoswipe.js></script></body></html>