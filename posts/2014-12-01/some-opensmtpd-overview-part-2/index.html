<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Some OpenSMTPD overview, part 2 - poolp.org</title><meta property="og:title" content="Some OpenSMTPD overview, part 2"><meta name=twitter:title content="Some OpenSMTPD overview, part 2"><meta name=description content="Why we killed the MFA (filter) process For as long as I can remember, a process called MFA was created by OpenSMTPD at start time.
MFA stood for &ldquo;Mail Filter Agent&rdquo; and the goal of that process was initially to take care of all filtering tasks ranging from filtering senders based on the ruleset matching to starting and controlling filters.
As time passed by, we figured the lookup process was better suited for ruleset matching and the MFA process became mostly idle, we renamed it to &ldquo;filter&rdquo; process since the only thing it had to do was take care of starting filters and making sure they had the proper environment."><meta property="og:description" content="Why we killed the MFA (filter) process For as long as I can remember, a process called MFA was created by OpenSMTPD at start time.
MFA stood for &ldquo;Mail Filter Agent&rdquo; and the goal of that process was initially to take care of all filtering tasks ranging from filtering senders based on the ruleset matching to starting and controlling filters.
As time passed by, we figured the lookup process was better suited for ruleset matching and the MFA process became mostly idle, we renamed it to &ldquo;filter&rdquo; process since the only thing it had to do was take care of starting filters and making sure they had the proper environment."><meta name=twitter:description content="Why we killed the MFA (filter) process For as long as I can remember, a process called MFA was created by OpenSMTPD at start time.
MFA stood for &ldquo;Mail Filter Agent&rdquo; and the goal of that …"><meta name=author content="Gilles Chehade"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"poolp.org","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/poolp.org\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/poolp.org\/posts\/2014-12-01\/some-opensmtpd-overview-part-2\/","name":"Some open s m t p d overview, part 2"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Gilles Chehade"},"headline":"Some OpenSMTPD overview, part 2","description":"Why we killed the MFA (filter) process For as long as I can remember, a process called MFA was created by OpenSMTPD at start time.\nMFA stood for \u0026ldquo;Mail Filter Agent\u0026rdquo; and the goal of that process was initially to take care of all filtering tasks ranging from filtering senders based on the ruleset matching to starting and controlling filters.\nAs time passed by, we figured the lookup process was better suited for ruleset matching and the MFA process became mostly idle, we renamed it to \u0026ldquo;filter\u0026rdquo; process since the only thing it had to do was take care of starting filters and making sure they had the proper environment.","inLanguage":"en","wordCount":1069,"datePublished":"2014-12-01T09:04:11","dateModified":"2014-12-01T09:04:11","image":"https:\/\/poolp.org\/","keywords":[""],"mainEntityOfPage":"https:\/\/poolp.org\/posts\/2014-12-01\/some-opensmtpd-overview-part-2\/","publisher":{"@type":"Organization","name":"https:\/\/poolp.org\/","logo":{"@type":"ImageObject","url":"https:\/\/poolp.org\/","height":60,"width":60}}}</script><meta property="og:title" content="Some OpenSMTPD overview, part 2"><meta property="og:description" content="Why we killed the MFA (filter) process For as long as I can remember, a process called MFA was created by OpenSMTPD at start time.
MFA stood for &ldquo;Mail Filter Agent&rdquo; and the goal of that process was initially to take care of all filtering tasks ranging from filtering senders based on the ruleset matching to starting and controlling filters.
As time passed by, we figured the lookup process was better suited for ruleset matching and the MFA process became mostly idle, we renamed it to &ldquo;filter&rdquo; process since the only thing it had to do was take care of starting filters and making sure they had the proper environment."><meta property="og:url" content="https://poolp.org/posts/2014-12-01/some-opensmtpd-overview-part-2/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=twitter:title content="Some OpenSMTPD overview, part 2"><meta name=twitter:description content="Why we killed the MFA (filter) process For as long as I can remember, a process called MFA was created by OpenSMTPD at start time.
MFA stood for &ldquo;Mail Filter Agent&rdquo; and the goal of that …"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta property="og:url" content="https://poolp.org/posts/2014-12-01/some-opensmtpd-overview-part-2/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=generator content="Hugo 0.78.1"><link rel=alternate href=https://poolp.org/index.xml type=application/rss+xml title=poolp.org><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://poolp.org/css/main.css><link rel=stylesheet href=https://poolp.org/css/highlight.min.css><link rel=stylesheet href=https://poolp.org/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=/css/latex.style.css></head><body><div class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=poolp.org height=55px></a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li class=navlinks-container><a class=navlinks-parent>Freelance</a><div class=navlinks-children><a href=/en/contracting/>[en] Hire me !</a>
<a href=/fr/contracting/>[fr] Recrutez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Sponsorship</a><div class=navlinks-children><a href=/en/sponsorship/>[en] Sponsor me !</a>
<a href=/fr/sponsorship/>[fr] Sponsorisez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Social</a><div class=navlinks-children><a href=https://patreon.com/gilles>Patreon</a>
<a href=https://www.linkedin.com/in/gilleschehade>LinkedIn</a>
<a href=https://github.com/poolpOrg>Github</a>
<a href=https://twitter.com/poolpOrg>Twitter</a></div></li><li class=navlinks-container><a class=navlinks-parent>Curriculum</a><div class=navlinks-children><a href=https://github.com/poolpOrg/resume/blob/master/resume.en.pdf>EN</a>
<a href=https://github.com/poolpOrg/resume/blob/master/resume.fr.pdf>FR</a></div></li><li><a title=Hypnose href=https://hypno.cat>Hypnose</a></li></ul></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1 style=text-align:left>Some OpenSMTPD overview, part 2</h1></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><h2 id=why-we-killed-the-mfa-filter-process>Why we killed the MFA (filter) process</h2><p>For as long as I can remember, a process called MFA was created by OpenSMTPD at start time.</p><p>MFA stood for &ldquo;Mail Filter Agent&rdquo; and the goal of that process was initially to take care of all filtering tasks ranging from filtering senders based on the ruleset matching to starting and controlling filters.</p><p>As time passed by, we figured the lookup process was better suited for ruleset matching and the MFA process became mostly idle, we renamed it to &ldquo;filter&rdquo; process since the only thing it had to do was take care of starting filters and making sure they had the proper environment.</p><p>At this point, we should have realized that this was unnecessary but this process had been with us for so long that it seemed just right. After all, we gave it a name, how do you kill something you named &mldr;</p><p>Anyways, as we improved the filter API design it became clear that the filter process kept getting in the way of us doing things in a simple way. We had all informations available at a place, yet we had to make an indirection and pass data back and forth just so the process could get a chance to acknowledge it didn&rsquo;t care. If the filter process is no longer needed after starting the filters, why not have them started by another process which actually does something useful afterwards instead of staying idle ?</p><p>Eric offered to take the process down and while it was heart-breaking, I encouraged him to kill it with fire.</p><h2 id=the-pony-process>The pony process</h2><p>There&rsquo;s been complaints that the daemon was starting too many processes and that probably some could be merged.</p><p>After a bit of brainstorming, we figured that the smtp process in charge of accepting incoming sessions, the mta process in charge of starting outgoing sessions and the delivery process in charge of delivering mail locally were a bit related: they were all unprivileged, running as _smtpd, chrooted to /var/empty and far from being busy even in scenarios where the server was busy itself.</p><p>In addition, they all shared a common design, they all had a notion of sessions following the same pattern and we figured that without too much efforts we could merge them into a single process.</p><p>I did the initial work to merge them three into a single process and eric@ did another pass to cleanup the names of the IMSG we were passing to improve further.</p><p>Pretty neat, hu ? Indeed. However we faced another challenge: this change proved to be controversial.</p><p>While pretty much everyone agrees that this was the way to go (actually I have no idea, I didn&rsquo;t run a poll), some people were not too receptive to the name we gave that process: &ldquo;pony&rdquo;. It is apparently unprofessional and should we leave it that way, gosh so much $$$ are we going to lose.</p><p>Actually &ldquo;pony&rdquo; was not meant to stay, it had nothing to do with the pony trend on internet and the name was chosen because we couldn&rsquo;t agree on a proper name for that process which did smtp, mta and delivery. Instead of spending two hours trying to find a name, I suggested we name it &ldquo;pony express&rdquo; as an hommage to the courageous messengers of the far west. If someone came up with a better name, we could just switch, I just didn&rsquo;t want to be stuck on that meaningless task. Until now, the challenge remains unsolved.</p><p>Also, I promised blambert@ a pony during a hackathon in Budapest so &mldr; one stone, two birds.</p><h2 id=the-klondike-process>The klondike process</h2><p>As you may have seen, this year was a terrible shot for the OpenSSL project. The Heartbleed vulnerability has shaken the internet and it even came out with a logo.</p><p>A few months earlier, for unrelated reasons I had started working on reducing the amount of time a key is exposed in the memory-space of a network facing process. I didn&rsquo;t solve the issue completely but tried to improve it slightly. My improvements would have helped in some cases but not with Heartbleed.</p><p>In the wake of the catastrophe, reyk@ implemented a privilege-separated RSA engine which allowed the RSA private parts (huhu) to remain COMPLETELY isolated from the network facing processes. His solution wasn&rsquo;t a fix to Heartbleed but a proper design which would have made it inoperant.</p><p>Of course, I immediately asked him if he could help integrate in OpenSMTPD which he did&mldr; in a process named &ldquo;klondike&rdquo;&mldr; because we&rsquo;re all &ldquo;pony express&rdquo; and unprofesionnal :-p</p><h2 id=the-opensmtpd-extras>The OpenSMTPD-extras</h2><p>For a long time, we shipped countless pieces of code that didn&rsquo;t really belong in our repository.</p><p>Not because they&rsquo;re not related to OpenSMTPD but because they are not really useful in the stock daemon, they came with some dependencies that we didn&rsquo;t want to have or because too few people use them that we want to maintain them as part of the official release.</p><p>So I lobbied and lobbied and lobbied to convince eric@ and chl@ that we needed an OpenSMTPD-extras repository where we could move table_ldap, table_mysql, table_postgres, table_redis and table_whateverwecomeupwith to avoid keeping too many things in our main repository.</p><p>Some work was done to split the code between these two repositories and make sure that the content of OpenSMTPD-extras would build by itself. This work was mainly done by chl@ and myself, and turned out not to be too painful, it only took us a couple hours to finish the split.</p><p>The idea behind this repository is that the OpenSMTPD repository is essentially read-only, only developers can commit and the commits must follow strict rules with regard to dependencies and what they bring to the server. We don&rsquo;t want to ship mysql or posgres support with the daemon bringing their dependencies, and that&rsquo;s even more relevant now that they can be standalone backends that can be packaged separately.</p><p>By providing a separate repository, we can remove these restrictions: the OpenSMTPD repository remains strict, the OpenSMTPD-extras repository is a set of unrequired plugins that can ship with whatever dependencies they need and we won&rsquo;t be strict about that. Of course that doesn&rsquo;t mean we will allow bad code to creep in, but we will be less strict as these will be optional user contributions, kind of what &ldquo;ports&rdquo; are for the BSD.</p><p>The OpenSMTPD-extras repository is now packaged in OpenBSD ports at least.</p><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpoolp.org%2fposts%2f2014-12-01%2fsome-opensmtpd-overview-part-2%2f&text=Some%20OpenSMTPD%20overview%2c%20part%202&via=poolpOrg" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2014-12-01%2fsome-opensmtpd-overview-part-2%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2014-12-01%2fsome-opensmtpd-overview-part-2%2f&title=Some%20OpenSMTPD%20overview%2c%20part%202" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpoolp.org%2fposts%2f2014-12-01%2fsome-opensmtpd-overview-part-2%2f&title=Some%20OpenSMTPD%20overview%2c%20part%202" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2014-12-01%2fsome-opensmtpd-overview-part-2%2f&title=Some%20OpenSMTPD%20overview%2c%20part%202" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fpoolp.org%2fposts%2f2014-12-01%2fsome-opensmtpd-overview-part-2%2f&description=Some%20OpenSMTPD%20overview%2c%20part%202" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://poolp.org/posts/2014-11-26/some-opensmtpd-overview-part-1/ data-toggle=tooltip data-placement=top title="Some OpenSMTPD overview, part 1">&larr; Previous Post</a></li><li class=next><a href=https://poolp.org/posts/2014-12-10/some-opensmtpd-overview-part-3/ data-toggle=tooltip data-placement=top title="Some OpenSMTPD overview, part 3">Next Post &rarr;</a></li></ul></div></div></div><footer style=text-align:justify><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><h2>Like my work and want to help me ?</h2><br><ul><li>Consider <b>tipping me</b> on <b><a target=_blank href=https://paypal.me/poolpOrg>PayPal</a></b>,
<b>supporting me</b> through one of the <b><a href=/en/sponsorship>sponsorship</a></b> platforms at <b><a href=https://github.com/sponsors/poolpOrg>Github</a></b>, <b><a href=https://patreon.com/gilles>Patreon</a></b> or
<b><a href=https://liberapay.com/poolpOrg>LiberaPay</a></b>,
or even <b>getting me something</b> from my wishlist on <b><a target=_blank href=http://amzn.eu/3MwH6CX>Amazon</a></b>
for positive <b><a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a></b> :-)<br><br></li><li>You can also help me by <b>commenting articles</b> to spark discussions,
and by <b>sharing them</b> so they reach a bigger audience,
they all contain a comment link and icons that will let you share to popular social networks.</li></ul><br></div></div><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="credits copyright text-muted"><a href=https://poolp.org>Gilles Chehade</a>
-&nbsp;&copy;
2020
-
<a href=https://poolp.org/>poolp.org</a></p><p class="credits theme-by text-muted"><a href=http://gohugo.io>Hugo v0.78.1</a> powered - Theme adapted from <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://poolp.org/js/main.js></script><script src=https://poolp.org/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0");});</script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://poolp.org/js/load-photoswipe.js></script></body></html>