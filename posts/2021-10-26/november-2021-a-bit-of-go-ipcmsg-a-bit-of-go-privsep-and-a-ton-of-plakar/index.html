<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar &#183; poolp.org</title><meta name=title content="November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar &#183; poolp.org"><link rel=canonical href=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/><link type=text/css rel=stylesheet href=/css/main.bundle.min.c6116b9ed1c907a8c0eb015f377d3eecc07e448d75729e31fc3de5881465c6c172ba9fa9a6800c030116caf2a110d92242bb816639484ca791f7cd107a8d49b5.css integrity="sha512-xhFrntHJB6jA6wFfN30+7MB+RI11cp4x/D3liBRlxsFyup+ppoAMAwEWyvKhENkiQruBZjlITKeR980Qeo1JtQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.3ddcf04f5b0d4c32f72e726d3c12eebccd8c3c9f9daa9a13414808895de0ae1e1cdddda6849680d5bd96dbb60d0b1e0b24c29f5c83e5631e55e7e6bc02015490.js integrity="sha512-PdzwT1sNTDL3LnJtPBLuvM2MPJ+dqpoTQUgIiV3grh4c3d2mhJaA1b2W27YNCx4LJMKfXIPlYx5V5+a8AgFUkA==" data-copy data-copied></script>
<script src=/js/zoom.min.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar"><meta property="og:description" content="TL;DR: I still have a discord, [https://discord.gg/YC6j4rbvSk](https://discord.gg/YC6j4rbvSk), feel free to join. I worked on go-ipcmsg to make it nicer, go-privsep to make it more useable, and A LOT on plakar to make it plakar."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/"><meta property="og:image" content="https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/feature.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-26T07:40:00+02:00"><meta property="article:modified_time" content="2021-10-26T07:40:00+02:00"><meta property="og:site_name" content="poolp.org"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/feature.png"><meta name=twitter:title content="November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar"><meta name=twitter:description content="TL;DR: I still have a discord, [https://discord.gg/YC6j4rbvSk](https://discord.gg/YC6j4rbvSk), feel free to join. I worked on go-ipcmsg to make it nicer, go-privsep to make it more useable, and A LOT on plakar to make it plakar."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar","headline":"November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar","abstract":"TL;DR: I still have a discord, [https:\/\/discord.gg\/YC6j4rbvSk](https:\/\/discord.gg\/YC6j4rbvSk), feel free to join. I worked on go-ipcmsg to make it nicer, go-privsep to make it more useable, and A LOT on plakar to make it plakar.","inLanguage":"en","url":"https:\/\/poolp.org\/posts\/2021-10-26\/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar\/","author":{"@type":"Person","name":""},"copyrightYear":"2021","dateCreated":"2021-10-26T07:40:00\u002b02:00","datePublished":"2021-10-26T07:40:00\u002b02:00","dateModified":"2021-10-26T07:40:00\u002b02:00","mainEntityOfPage":"true","wordCount":"4106"}]</script><script src=/lib/jquery/jquery.slim.min.js integrity></script>
<link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/custom.css><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom bg-neutral dark:bg-neutral-800"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>poolp.org</span>
<img src=/img/poolp_org.png width=150 height=51 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=poolp.org></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">poolp.org</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher aria-label="Dark mode switcher" type=button><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button style=margin-right:5px><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-auto overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li></ul><hr><ul class="flex mt-4 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li class=mb-1><a href=/categories/technology/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title=technology>Technology</p></a></li><li class=mb-1><a href class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title>Music</p></a></li><li class=mb-1><a href=/categories/personal/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title=personal>Personal</p></a></li></ul></div></label></div></div><div class="main-menu flex pb-3 flex-col items-end justify-between md:justify-start space-x-3" style=margin-top:-15px><div class="hidden md:flex items-center space-x-5"><a href=/categories/technology/ class="flex items-center"><p class="text-xs font-light text-gray-500 hover:text-gray-900" title=technology>Technology</p></a><a href class="flex items-center"><p class="text-xs font-light text-gray-500 hover:text-gray-900" title>Music</p></a><a href=/categories/personal/ class="flex items-center"><p class="text-xs font-light text-gray-500 hover:text-gray-900" title=personal>Personal</p></a></div></div></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="w-full h-36 md:h-56 lg:h-72 single_hero_basic nozoom" style=background-image:url(/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/feature_hu07aa2ed5d0e21bf5a0bbdf5d11e5253a_533447_1200x0_resize_box_3.png)></div><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>poolp.org</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/>November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">November 2021: a bit of go-ipcmsg, a bit of go-privsep and a ton of plakar</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-10-26 07:40:00 +0200 +0200">26 October 2021</time><span class="px-2 text-primary-500">&#183;</span><span>4106 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">20 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/poolpOrg/poolp.org/tree/master/content/posts/2021-11-01/index.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title="Edit content"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M490.3 40.4c21.9 21.87 21.9 57.33.0 79.2l-30 30.1-98-97.98 30.1-30.06C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7 339.7 74.34l98 97.96L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2l-88.8 29.6C150.1 385.6 141.5 383.4 135 376.1 128.6 370.5 126.4 361 129.2 352.4l29.6-88.8C161.6 255.3 166.2 247.8 172.4 241.7v0zM192 63.1c17.7.0 32 15.23 32 32 0 18.6-14.3 32-32 32H96c-17.67.0-32 15.2-32 32V416c0 17.7 14.33 32 32 32H352c17.7.0 32-14.3 32-32V319.1c0-16.8 14.3-32 32-32s32 15.2 32 32V416c0 53-43 96-96 96H96c-53.02.0-96-43-96-96V159.1c0-53 42.98-96 96-96h96z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"><div style=cursor:pointer onclick='window.open("/authors/gilles/","_self")'>Gilles Chehade</div></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/technology/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">technology</span></span></span></div></div><div class=flex><div class=place-self-center><div class="text-2xl sm:text-lg"></div></div></div><div class="flex mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 src=/img/gilles_hu897fc9ad11a292e594efc0b9f1eaea51_1273455_192x192_fill_q75_box_center.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://poolp.org//authors/gilles class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Gilles Chehade</a><div class="text-sm text-neutral-700 dark:text-neutral-400">I&rsquo;m not a cat.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:gilles@poolp.org target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://discord.gg/YC6j4rbvSk target=_blank aria-label=Discord rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M524.531 69.836a1.5 1.5.0 00-.764-.7A485.065 485.065.0 00404.081 32.03a1.816 1.816.0 00-1.923.91 337.461 337.461.0 00-14.9 30.6 447.848 447.848.0 00-134.426.0 309.541 309.541.0 00-15.135-30.6 1.89 1.89.0 00-1.924-.91A483.689 483.689.0 00116.085 69.137a1.712 1.712.0 00-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016.0 00.765 1.375A487.666 487.666.0 00176.02 479.918a1.9 1.9.0 002.063-.676A348.2 348.2.0 00208.12 430.4a1.86 1.86.0 00-1.019-2.588 321.173 321.173.0 01-45.868-21.853 1.885 1.885.0 01-.185-3.126c3.082-2.309 6.166-4.711 9.109-7.137a1.819 1.819.0 011.9-.256c96.229 43.917 200.41 43.917 295.5.0a1.812 1.812.0 011.924.233c2.944 2.426 6.027 4.851 9.132 7.16a1.884 1.884.0 01-.162 3.126 301.407 301.407.0 01-45.89 21.83 1.875 1.875.0 00-1 2.611 391.055 391.055.0 0030.014 48.815 1.864 1.864.0 002.063.7A486.048 486.048.0 00610.7 405.729a1.882 1.882.0 00.765-1.352C623.729 277.594 590.933 167.465 524.531 69.836zM222.491 337.58c-28.972.0-52.844-26.587-52.844-59.239S193.056 219.1 222.491 219.1c29.665.0 53.306 26.82 52.843 59.239.0 32.654-23.41 59.241-52.843 59.241zm195.38.0c-28.971.0-52.843-26.587-52.843-59.239S388.437 219.1 417.871 219.1c29.667.0 53.307 26.82 52.844 59.239.0 32.654-23.177 59.241-52.844 59.241z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/poolpOrg target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/gilleschehade target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://social.poolp.org/@gilles target=_blank aria-label=Mastodon rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.patreon.com/gilles target=_blank aria-label=Patreon rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M512 194.8c0 101.3-82.4 183.8-183.8 183.8-101.7.0-184.4-82.4-184.4-183.8.0-101.6 82.7-184.3 184.4-184.3C429.6 10.5 512 93.2 512 194.8zM0 501.5h90v-491H0v491z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://reddit.com/user/poolpOrg target=_blank aria-label=Reddit rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://twitter.com/poolpOrg target=_blank aria-label=Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.youtube.com/gilleschehade target=_blank aria-label=Youtube rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first sm:max-w-prose lg:ml-auto px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#shout-out-to-my-sponsors-x2764xfe0f>Shout out to my sponsors ❤️</a></li><li><a href=#go-ipcmsg>Go-ipcmsg</a></li><li><a href=#go-privsep>Go-privsep</a></li><li><a href=#go-parsey>Go-parsey</a></li><li><a href=#plakar>Plakar</a><ul><li><a href=#tried-failed-to-fix-fuse-support-build-on-openbsd>Tried (failed) to fix <code>fuse</code> support build on OpenBSD&mldr;</a></li><li><a href=#rewrote-the-network-code>Rewrote the network code</a></li><li><a href=#reworked-the-storage-interface>Reworked the storage interface</a></li><li><a href=#added-support-for-an-sqlite-storage-backend>Added support for an SQLite storage backend</a></li><li><a href=#optimized-local-cache-logic-and-replaced-with-an-sqlite-implementation>Optimized local cache logic and replaced with an SQLite implementation</a></li><li><a href=#implemented-a-small-plakar-shell>Implemented a small plakar shell</a></li><li><a href=#implemented-a-filesystem-view>Implemented a filesystem view</a></li><li><a href=#implement-cpu-throttling>Implement CPU throttling</a></li><li><a href=#simplify-and-optimize-plakar-push>Simplify and optimize <code>plakar push</code></a></li><li><a href=#parallelized-plakar-keep-plakar-rm-plakar-ls>Parallelized <code>plakar keep</code>, <code>plakar rm</code>, <code>plakar ls</code></a></li><li><a href=#fixed-ui>Fixed UI</a></li><li><a href=#implemented-plakar-clone>Implemented <code>plakar clone</code></a></li><li><a href=#implemented-plakar-check-and-fast-checking>Implemented <code>plakar check</code> and fast checking</a></li></ul></li><li><a href=#assorted-other-work>Assorted other work</a></li></ul></nav></div></details><details class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#shout-out-to-my-sponsors-x2764xfe0f>Shout out to my sponsors ❤️</a></li><li><a href=#go-ipcmsg>Go-ipcmsg</a></li><li><a href=#go-privsep>Go-privsep</a></li><li><a href=#go-parsey>Go-parsey</a></li><li><a href=#plakar>Plakar</a><ul><li><a href=#tried-failed-to-fix-fuse-support-build-on-openbsd>Tried (failed) to fix <code>fuse</code> support build on OpenBSD&mldr;</a></li><li><a href=#rewrote-the-network-code>Rewrote the network code</a></li><li><a href=#reworked-the-storage-interface>Reworked the storage interface</a></li><li><a href=#added-support-for-an-sqlite-storage-backend>Added support for an SQLite storage backend</a></li><li><a href=#optimized-local-cache-logic-and-replaced-with-an-sqlite-implementation>Optimized local cache logic and replaced with an SQLite implementation</a></li><li><a href=#implemented-a-small-plakar-shell>Implemented a small plakar shell</a></li><li><a href=#implemented-a-filesystem-view>Implemented a filesystem view</a></li><li><a href=#implement-cpu-throttling>Implement CPU throttling</a></li><li><a href=#simplify-and-optimize-plakar-push>Simplify and optimize <code>plakar push</code></a></li><li><a href=#parallelized-plakar-keep-plakar-rm-plakar-ls>Parallelized <code>plakar keep</code>, <code>plakar rm</code>, <code>plakar ls</code></a></li><li><a href=#fixed-ui>Fixed UI</a></li><li><a href=#implemented-plakar-clone>Implemented <code>plakar clone</code></a></li><li><a href=#implemented-plakar-check-and-fast-checking>Implemented <code>plakar check</code> and fast checking</a></li></ul></li><li><a href=#assorted-other-work>Assorted other work</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><blockquote><b>TL;DR:</b>
I still have a discord, [https://discord.gg/YC6j4rbvSk](https://discord.gg/YC6j4rbvSk), feel free to join.
I worked on go-ipcmsg to make it nicer, go-privsep to make it more useable, and A LOT on plakar to make it plakar.</blockquote><div id=shout-out-to-my-sponsors-x2764xfe0f class=anchor></div><h1 class="relative group">Shout out to my sponsors ❤️
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#shout-out-to-my-sponsors-x2764xfe0f aria-label=Anchor>#</a></span></h1><p>A <strong>HUGE thanks</strong> goes to my sponsors on <a href=https://github.com/sponsors/poolpOrg target=_blank>github</a>
and <a href=https://www.patreon.com/gilles target=_blank>patreon</a>:
your continuous support is very much appreciated !</p><p>I created a Discord where I hang out and discuss my projects or screencast as I work on them.
Feel free to hop in if you want,
and feel free to do just like me and share thoughts as you work on your own projects there:
<strong>this is a virtual hack room for anyone to join</strong>: <a href=https://discord.gg/YC6j4rbvSk target=_blank>https://discord.gg/YC6j4rbvSk</a></p><div id=go-ipcmsg class=anchor></div><h1 class="relative group">Go-ipcmsg
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#go-ipcmsg aria-label=Anchor>#</a></span></h1><p><a href=/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/#go-ipcmsg>In April</a>,
I wrote about <a href=https://github.com/poolpOrg/go-ipcmsg target=_blank><code>go-ipcmsg</code></a>,
a package to bring an <a href=https://man.openbsd.org/imsg_init.3 target=_blank><code>imsg(3)</code></a>-like API to Golang and help me write code involving <strong>message and fd-passing between processes</strong>.</p><p>It took me a couple days of work and I was happy with the result so I left it there,
letting it rest in its Github repository,
until earlier this month when I figured the API could be simplified by a great deal&mldr;
so I decided to revisit and make some changes..</p><p>Back then,
each peer of an IPCMSG channel <strong>received two Golang channels</strong>,
and could simply read or write to the other process through them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>parent</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// just a basic function that sets up a socketpair, forks a child,
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// and returns the child&#39;s pid and the parent&#39;s side of the socketpair.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    pid, fd <span style=color:#ff79c6>:=</span> <span style=color:#50fa7b>fork_child</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// read &amp; write channels obtained here
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    child_r, child_w <span style=color:#ff79c6>:=</span> ipcmsg.<span style=color:#50fa7b>Channel</span>(pid, fd)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// write to child, last parameter == fd to pass to the other process
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    child_w <span style=color:#ff79c6>&lt;-</span> ipcmsg.<span style=color:#50fa7b>MessageWithFD</span>(IPCMSG_PING, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;foobar&#34;</span>), <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// read from child
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    msg <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&lt;-</span> child_r
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>child</span>() {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// read &amp; write channels obtained here,
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// fd=3 is the fork-inherited side of the socketpair.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    parent_r, parent_w <span style=color:#ff79c6>:=</span> ipcmsg.<span style=color:#50fa7b>Channel</span>(os.<span style=color:#50fa7b>Getppid</span>(), <span style=color:#bd93f9>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// read from parent
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    msg <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&lt;-</span> parent_r
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// write to parent
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    parent_w <span style=color:#ff79c6>&lt;-</span> ipcmsg.<span style=color:#50fa7b>Message</span>(IPCMSG_PONG, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;barbaz&#34;</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In practice,
instead of inlining calls like this,
you&rsquo;d declare <strong>a handler function</strong> which would process all messages on the read channel and reply through the write channel as such:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>dispatcher</span>(r <span style=color:#8be9fd;font-style:italic>chan</span> ipcmsg.IPCMessage, w <span style=color:#8be9fd;font-style:italic>chan</span> ipcmsg.IPCMessage) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> msg <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> r {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>switch</span> msg.Hdr.Type {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>case</span> IPCMSG_PING:
</span></span><span style=display:flex><span>            w <span style=color:#ff79c6>&lt;-</span> ipcmsg.<span style=color:#50fa7b>MessageWithFD</span>(IPCMSG_PONG, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;barbaz&#34;</span>), <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>child</span>() {
</span></span><span style=display:flex><span>    parent_r, parent_w <span style=color:#ff79c6>:=</span> ipcmsg.<span style=color:#50fa7b>Channel</span>(os.<span style=color:#50fa7b>Getppid</span>(), <span style=color:#bd93f9>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>dispatcher</span>(parent_r, parent_w)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>However,
I realized that pretty much every single use of the package would require writing that <strong>very similar dispatcher function</strong> looping over the read channel,
and I also disliked the pattern of letting the user access the Golang channels directly as it made it easier to introduce mistakes in code for no benefit whatsoever.</p><p>I decided to rewrite the <code>ipcmsg.Channel()</code> function to return an opaque structure <strong>hiding the underlying channels</strong>,
and to provide a <code>channel.Dispatch()</code> function to start reading from the channel.
With this change,
the sample of code above now looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>handlePING</span>(channel <span style=color:#ff79c6>*</span>ipcmsg.Channel, msg ipcmsg.IPCMessage) {
</span></span><span style=display:flex><span>	channel.<span style=color:#50fa7b>Message</span>(IPCMSG_PONG, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;barbaz&#34;</span>), <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>child</span>() {
</span></span><span style=display:flex><span>	channel <span style=color:#ff79c6>:=</span> ipcmsg.<span style=color:#50fa7b>NewChannel</span>(<span style=color:#f1fa8c>&#34;child&lt;-&gt;parent&#34;</span>, os.<span style=color:#50fa7b>Getppid</span>(), <span style=color:#bd93f9>3</span>)
</span></span><span style=display:flex><span>	channel.<span style=color:#50fa7b>Handler</span>(IPCMSG_PING, handlePING)
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;-</span>channel.<span style=color:#50fa7b>Dispatch</span>() <span style=color:#6272a4>// Run() and wait until it returns due to peer close
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>}
</span></span></code></pre></div><p>As you can see,
the message handling function receives an IPCMessage when one is available,
without having to loop on the read channel,
and the function setting up the channel can declare handlers for specific message types before calling the dispatcher.</p><p>In addition to this simplification,
I introduced a new mechanism:
<strong>synchronized messages</strong>.</p><p>In the <a href=https://man.openbsd.org/imsg_init.3 target=_blank><code>imsg(3)</code></a> API,
because it is written in C which doesn&rsquo;t provide coroutines,
messages are sent and <strong>code can&rsquo;t wait for an answer</strong> as it would <strong>block the entire process</strong> meanwhile.
To avoid this,
code to emit a message and code to handle answers are <strong>decoupled</strong>:
a function sends and stops caring about the message&mldr; until another function gets an answer and resumes what the first intended to do if it could have waited for an answer.
Splitting code like this is always doable,
but it can be <strong>more or less tricky with some patterns</strong> where you&rsquo;d benefit from having a very sequential read.</p><p>Because I can use Goroutines here and have them interrupt their execution in place without blocking the entire process,
I introduced two additional calls:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#6272a4>// channel.Query() blocks the goroutine and resumes execution
</span></span></span><span style=display:flex><span><span style=color:#6272a4>// only when the other end has used channel.Reply()
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>msgtype, data, fd <span style=color:#ff79c6>:=</span> channel.<span style=color:#50fa7b>Query</span>(IPCMSG_PING, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;data&#34;</span>), <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> msgtype <span style=color:#ff79c6>!=</span> IPCMSG_PONG {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>panic</span>(<span style=color:#f1fa8c>&#34;THE WORLD IS COMING TO AN END.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>fmt.<span style=color:#50fa7b>Println</span>(<span style=color:#f1fa8c>&#34;got appropriate response to my query&#34;</span>)
</span></span></code></pre></div><p>This pattern is not necessarily better than the split pattern,
they both have their use-cases which is why <code>go-ipcmsg</code> provides both,
but in some situations it <strong>really makes code much less complex than interrupting execution to resume in another function</strong>.</p><p>The code is already available <a href=https://github.com/poolpOrg/go-ipcmsg target=_blank>in a Github repository</a>,
and it works enough that I use it in various proof of concepts I write,
but it still isn&rsquo;t ready to use in production and was only tested by me.</p><p>Feel free to test and report issues ;-)</p><div id=go-privsep class=anchor></div><h1 class="relative group">Go-privsep
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#go-privsep aria-label=Anchor>#</a></span></h1><p><a href=/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/#go-privsep>In April</a>,
I also wrote about <a href=https://github.com/poolpOrg/go-privsep target=_blank><code>go-privsep</code></a>,
a package to ease the writing of OpenBSD-style daemons in Golang.</p><p>The idea behind it is that most OpenBSD-style daemons use the same multi-process design,
yet every project has to have <strong>a different setup logic</strong> because they differ in the number of processes,
which processes communicate with each other,
and which messages they sent one to another.</p><p>I disliked having to bootstrap a new daemon but at least <strong>I could copy</strong> chunks from a previous one and adapt,
but this doesn&rsquo;t work with Golang as I have not found any OpenBSD-like daemon to copy from.
So I thought maybe I should solve the main issue which is making the part that annoys me&mldr; less annoying,
this way I don&rsquo;t have to bother much setting up a new daemon architecture and I don&rsquo;t have to copy code from another daemon either.</p><p>The result is a package that allows to <strong>declare how the daemon is supposed to look like</strong> when it enters its event loop,
and the package takes care of creating the processes,
the communication channels between them,
dropping privileges and chrooting where appropriate,
before having each process enter its own entry point.</p><p>In the following example,
I have <strong>created a daemon with a design similar to OpenSMTPD</strong>&mldr;
except that all entry points are idle because it&rsquo;s not a real daemon 😁</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Init</span>()
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Parent</span>(<span style=color:#f1fa8c>&#34;parent&#34;</span>, parent.Run)
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;crypto&#34;</span>, crypto.Run)
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;control&#34;</span>, control.Run)
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;lookup&#34;</span>, lookup.Run)
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>, dispatcher.Run)
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;queue&#34;</span>, queue.Run)
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;scheduler&#34;</span>, scheduler.Run)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetParent</span>().Username = <span style=color:#f1fa8c>&#34;root&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetParent</span>().<span style=color:#50fa7b>TalksTo</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;crypto&#34;</span>).Username = <span style=color:#f1fa8c>&#34;_smtpd&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;crypto&#34;</span>).Chrootpath = <span style=color:#f1fa8c>&#34;/var/empty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;control&#34;</span>).Username = <span style=color:#f1fa8c>&#34;_smtpd&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;control&#34;</span>).Chrootpath = <span style=color:#f1fa8c>&#34;/var/empty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;lookup&#34;</span>).Username = <span style=color:#f1fa8c>&#34;_smtpd&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;lookup&#34;</span>).<span style=color:#50fa7b>TalksTo</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>, <span style=color:#f1fa8c>&#34;queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>).Username = <span style=color:#f1fa8c>&#34;_smtpd&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>).Chrootpath = <span style=color:#f1fa8c>&#34;/var/empty&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>).<span style=color:#50fa7b>TalksTo</span>(<span style=color:#f1fa8c>&#34;parent&#34;</span>, <span style=color:#f1fa8c>&#34;lookup&#34;</span>, <span style=color:#f1fa8c>&#34;queue&#34;</span>, <span style=color:#f1fa8c>&#34;scheduler&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;scheduler&#34;</span>).Username = <span style=color:#f1fa8c>&#34;_smtpd&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;scheduler&#34;</span>).Chrootpath = <span style=color:#f1fa8c>&#34;/var/empty&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;scheduler&#34;</span>).<span style=color:#50fa7b>TalksTo</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>, <span style=color:#f1fa8c>&#34;queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;queue&#34;</span>).Username = <span style=color:#f1fa8c>&#34;_smtpq&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;queue&#34;</span>).Chrootpath = <span style=color:#f1fa8c>&#34;/var/spool/smtpd&#34;</span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;queue&#34;</span>).<span style=color:#50fa7b>PreChrootHandler</span>(queue.PreChrootHandler)
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;queue&#34;</span>).<span style=color:#50fa7b>TalksTo</span>(<span style=color:#f1fa8c>&#34;dispatcher&#34;</span>, <span style=color:#f1fa8c>&#34;lookup&#34;</span>, <span style=color:#f1fa8c>&#34;scheduler&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> os.<span style=color:#50fa7b>Geteuid</span>() <span style=color:#ff79c6>!=</span> <span style=color:#bd93f9>0</span> {
</span></span><span style=display:flex><span>        log.<span style=color:#50fa7b>Fatal</span>(<span style=color:#f1fa8c>&#34;privileges separation requires root privileges&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privsep.<span style=color:#50fa7b>Start</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This should be self-explanatory but to summarize:
you declare a list of processes with their names and entry points,
then for each process you declare some properties such as the username it should run as or a chroot directory,
and the list of processes it is allowed to talk to.</p><p>When <code>privsep.Start()</code> is reached,
the daemon bootstraps itself from the declarations and you end up with all processes setup:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo ./smtpd
</span></span><span style=display:flex><span>$ ps au|grep smtpd
</span></span><span style=display:flex><span>_smtpd <span style=color:#bd93f9>70584</span>   0.0  0.0 <span style=color:#bd93f9>409218992</span>   <span style=color:#bd93f9>8112</span> s003  SN   12:17AM   0:00.01 ./smtpd: scheduler
</span></span><span style=display:flex><span>_smtpq <span style=color:#bd93f9>70583</span>   0.0  0.1 <span style=color:#bd93f9>409238336</span>   <span style=color:#bd93f9>9072</span> s003  SN   12:17AM   0:00.01 ./smtpd: queue
</span></span><span style=display:flex><span>_smtpd <span style=color:#bd93f9>70582</span>   0.0  0.1 <span style=color:#bd93f9>409233888</span>  <span style=color:#bd93f9>11120</span> s003  SN   12:17AM   0:00.02 ./smtpd: dispatcher
</span></span><span style=display:flex><span>_smtpd <span style=color:#bd93f9>70581</span>   0.0  0.0 <span style=color:#bd93f9>409218608</span>   <span style=color:#bd93f9>7264</span> s003  SN   12:17AM   0:00.01 ./smtpd: lookup
</span></span><span style=display:flex><span>_smtpd <span style=color:#bd93f9>70580</span>   0.0  0.0 <span style=color:#bd93f9>409217440</span>   <span style=color:#bd93f9>6304</span> s003  SN   12:17AM   0:00.00 ./smtpd: control
</span></span><span style=display:flex><span>_smtpd <span style=color:#bd93f9>70579</span>   0.0  0.0 <span style=color:#bd93f9>409225328</span>   <span style=color:#bd93f9>6320</span> s003  SN   12:17AM   0:00.01 ./smtpd: crypto
</span></span><span style=display:flex><span>root   <span style=color:#bd93f9>70578</span>   0.0  0.0 <span style=color:#bd93f9>409219376</span>   <span style=color:#bd93f9>7936</span> s003  SN   12:17AM   0:00.03 ./smtpd
</span></span><span style=display:flex><span>root   <span style=color:#bd93f9>70577</span>   0.0  0.0 <span style=color:#bd93f9>408638640</span>   <span style=color:#bd93f9>7296</span> s003  SN   12:17AM   0:00.03 sudo ./smtpd
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>The <code>go-privsep</code> package relies on <code>go-ipcmsg</code> so that each processes that have called <code>TalksTo()</code> in the declaration have IPCMSG channels setup between them,
and can declare message handlers or rely on <code>Message()</code> and <code>Query()</code> to communicate one with another.</p><p>Here&rsquo;s an example of <strong>a small daemon forking two children exchanging PING/PONG messages</strong> over and over:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#ff79c6>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;github.com/poolpOrg/go-ipcmsg&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;github.com/poolpOrg/go-privsep&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>const</span> (
</span></span><span style=display:flex><span>	IPCMSG_PING ipcmsg.IPCMsgType = <span style=color:#ff79c6>iota</span>
</span></span><span style=display:flex><span>	IPCMSG_PONG ipcmsg.IPCMsgType = <span style=color:#ff79c6>iota</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>parent_main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;-</span><span style=color:#8be9fd;font-style:italic>make</span>(<span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd>bool</span>) <span style=color:#6272a4>// sleep forever
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>main_foobar</span>() {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;-</span><span style=color:#8be9fd;font-style:italic>make</span>(<span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd>bool</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>main_barbaz</span>() {
</span></span><span style=display:flex><span>	foobar <span style=color:#ff79c6>:=</span> privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;foobar&#34;</span>)
</span></span><span style=display:flex><span>	foobar.<span style=color:#50fa7b>Message</span>(IPCMSG_PING, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;test&#34;</span>), <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;-</span><span style=color:#8be9fd;font-style:italic>make</span>(<span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd>bool</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>ping_handler</span>(channel <span style=color:#ff79c6>*</span>ipcmsg.Channel, msg ipcmsg.IPCMessage) {
</span></span><span style=display:flex><span>	log.<span style=color:#50fa7b>Printf</span>(<span style=color:#f1fa8c>&#34;[%s] received PING\n&#34;</span>, privsep.<span style=color:#50fa7b>GetCurrentProcess</span>().<span style=color:#50fa7b>Name</span>())
</span></span><span style=display:flex><span>	time.<span style=color:#50fa7b>Sleep</span>(<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>*</span> time.Second)
</span></span><span style=display:flex><span>	channel.<span style=color:#50fa7b>Reply</span>(msg, IPCMSG_PONG, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;test&#34;</span>), <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>pong_handler</span>(channel <span style=color:#ff79c6>*</span>ipcmsg.Channel, msg ipcmsg.IPCMessage) {
</span></span><span style=display:flex><span>	log.<span style=color:#50fa7b>Printf</span>(<span style=color:#f1fa8c>&#34;[%s] received PONG\n&#34;</span>, privsep.<span style=color:#50fa7b>GetCurrentProcess</span>().<span style=color:#50fa7b>Name</span>())
</span></span><span style=display:flex><span>	time.<span style=color:#50fa7b>Sleep</span>(<span style=color:#bd93f9>1</span> <span style=color:#ff79c6>*</span> time.Second)
</span></span><span style=display:flex><span>	channel.<span style=color:#50fa7b>Reply</span>(msg, IPCMSG_PING, []<span style=color:#8be9fd;font-style:italic>byte</span>(<span style=color:#f1fa8c>&#34;test&#34;</span>), <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span>	privsep.<span style=color:#50fa7b>Init</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	privsep.<span style=color:#50fa7b>Parent</span>(<span style=color:#f1fa8c>&#34;parent&#34;</span>, parent_main)
</span></span><span style=display:flex><span>	privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;foobar&#34;</span>, main_foobar).<span style=color:#50fa7b>TalksTo</span>(<span style=color:#f1fa8c>&#34;barbaz&#34;</span>)
</span></span><span style=display:flex><span>	privsep.<span style=color:#50fa7b>Child</span>(<span style=color:#f1fa8c>&#34;barbaz&#34;</span>, main_barbaz).<span style=color:#50fa7b>TalksTo</span>(<span style=color:#f1fa8c>&#34;foobar&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;foobar&#34;</span>).<span style=color:#50fa7b>PreStartHandler</span>(<span style=color:#8be9fd;font-style:italic>func</span>() <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span>		barbaz <span style=color:#ff79c6>:=</span> privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;barbaz&#34;</span>)
</span></span><span style=display:flex><span>		barbaz.<span style=color:#50fa7b>SetHandler</span>(IPCMSG_PING, ping_handler)
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;barbaz&#34;</span>).<span style=color:#50fa7b>PreStartHandler</span>(<span style=color:#8be9fd;font-style:italic>func</span>() <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span>		foobar <span style=color:#ff79c6>:=</span> privsep.<span style=color:#50fa7b>GetProcess</span>(<span style=color:#f1fa8c>&#34;foobar&#34;</span>)
</span></span><span style=display:flex><span>		foobar.<span style=color:#50fa7b>SetHandler</span>(IPCMSG_PONG, pong_handler)
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	privsep.<span style=color:#50fa7b>Start</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The code is also already available <a href=https://github.com/poolpOrg/go-privsep target=_blank>in a Github repository</a>,
and it works enough that I use it in various proof of concepts,
though the API still evolves and I would discourage you from using it for anything but experimenting at this point.</p><p>Feel free to test and report issues ;-)</p><div id=go-parsey class=anchor></div><h1 class="relative group">Go-parsey
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#go-parsey aria-label=Anchor>#</a></span></h1><p>The last bit that I really miss in Golang when writing stuff is the <strong>OpenBSD-style configuration</strong> handling.</p><p>In OpenBSD,
all daemons share a <code>parse.y</code> file containing their specific (yet very similar) grammar built on top of the same lexer.
After a few years of making changes in it,
I grew to enjoy <code>parse.y</code> and the simplicity of configuration files produced by that common piece of code.</p><p>It already took me a while to get used to <code>ini</code> files in Python but when I realized that Golang developers tend to use <code>json</code>, <code>toml</code> or <code>yaml</code>,
I just couldn&rsquo;t.</p><p>I have started working on <code>go-parsey</code>,
a small package that allows declaring a configuration grammar that more resembles what I like.
<strong>It&rsquo;s nowhere near done</strong>,
at this point I wrote the lexer and am playing with the API to find what is the most usable way to obtain what I want.</p><p>It&rsquo;s at a so early stage that I can&rsquo;t even show something, except maybe the following example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#6272a4>// instantiate a lexer and teach it how to recognize tokens
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>lexer <span style=color:#ff79c6>:=</span> parsey.<span style=color:#50fa7b>NewLexer</span>()
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterToken</span>(<span style=color:#f1fa8c>&#34;listen&#34;</span>)
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterToken</span>(<span style=color:#f1fa8c>&#34;on&#34;</span>)
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterToken</span>(<span style=color:#f1fa8c>&#34;match&#34;</span>)
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterToken</span>(<span style=color:#f1fa8c>&#34;=&gt;&#34;</span>)
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterTokenMatch</span>(<span style=color:#f1fa8c>&#34;FOOBAR&#34;</span>, <span style=color:#ff79c6>go</span> <span style=color:#8be9fd;font-style:italic>func</span>(v <span style=color:#8be9fd>string</span>) <span style=color:#8be9fd>bool</span> { v <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;foobar?&#34;</span> })
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterTokenMatch</span>(<span style=color:#f1fa8c>&#34;STRING&#34;</span>, lexer.IsString)
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterTokenMatch</span>(<span style=color:#f1fa8c>&#34;NUMBER&#34;</span>, lexer.IsNumber)
</span></span><span style=display:flex><span>lexer.<span style=color:#50fa7b>RegisterTokenMatch</span>(<span style=color:#f1fa8c>&#34;FLOAT&#34;</span>, lexer.IsFloat)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// instanciate a grammar and teach it how to recognize token sequences
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>grammar <span style=color:#ff79c6>:=</span> parsey.<span style=color:#50fa7b>NewGrammar</span>()
</span></span><span style=display:flex><span>grammar.<span style=color:#50fa7b>RegisterRule</span>(configBuilderRule1, <span style=color:#f1fa8c>&#34;listen&#34;</span>, <span style=color:#f1fa8c>&#34;on&#34;</span>, <span style=color:#f1fa8c>&#34;STRING&#34;</span>)
</span></span><span style=display:flex><span>grammar.<span style=color:#50fa7b>RegisterRule</span>(configBuilderRule2, <span style=color:#f1fa8c>&#34;match&#34;</span>, <span style=color:#f1fa8c>&#34;=&gt;&#34;</span>, <span style=color:#f1fa8c>&#34;STRING&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// instanciate a config parser using the configured lexer and grammar
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>config <span style=color:#ff79c6>:=</span> parsey.<span style=color:#50fa7b>NewConfiguration</span>(lexer, grammar)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// parse a file using that parser
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>success, err <span style=color:#ff79c6>:=</span> config.<span style=color:#50fa7b>ParseFile</span>(configFile)
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>	log.<span style=color:#50fa7b>Fatal</span>(err)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>which will parse the following format, supporting line breaks, comments, quoting and free whitespaces:</p><pre tabindex=0><code>listen on fxp0
match =&gt; fxp0

listen on \
  fxp0
match       =&gt;    fxp0
</code></pre><p>Of course the sample above isn&rsquo;t how this is going to work because <strong>recognizing token sequences is not enough</strong> to produce usable configuration files,
there needs to be support for <strong>expressions and conditionals</strong>,
both of which I already have code for on my laptop.
I&rsquo;m currently more focused on what the API should look like so it isn&rsquo;t too difficult to use.</p><p>OH, and <strong>why don&rsquo;t I use Goyacc</strong>, you ask ?</p><p>It boils down to three reasons:</p><ul><li><p>First, I&rsquo;d like to have a declarative setup similar to what I did in <code>go-privsep</code> and the ability to either freeze a config format or &ldquo;extend&rdquo; it dynamically if I wish.</p></li><li><p>Then, I haven&rsquo;t hand-written a parser from scratch since I was a student and this will remove some dust in my brain, even if I end up not using it&mldr; <strong>it&rsquo;s the journey, not the destination</strong>.</p></li><li><p>Finally, because it seems that I&rsquo;m not smart enough to get Goyacc to do what I want otherwise I would have used it to start with and not bother with this 😃</p></li></ul><p>Anyways,
<strong>don&rsquo;t hold your breath</strong>,
this isn&rsquo;t a serious project and I&rsquo;ll work on it on and off throughout 2022.</p><div id=plakar class=anchor></div><h1 class="relative group">Plakar
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#plakar aria-label=Anchor>#</a></span></h1><p>I did a TON of work on <code>plakar</code> with <strong>over 150 public commits</strong> and some more in a private branch.</p><p>The following subsections will describe the most interesting changes,
<strong>in no particular order</strong>,
though many more are interesting for the project but not so much for an article.</p><div id=tried-failed-to-fix-fuse-support-build-on-openbsd class=anchor></div><h2 class="relative group">Tried (failed) to fix <code>fuse</code> support build on OpenBSD&mldr;
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#tried-failed-to-fix-fuse-support-build-on-openbsd aria-label=Anchor>#</a></span></h2><p>But it turns out that after fixing my code,
then fixing the code in the dependency,
I hit a problem in Golang&rsquo;s runtime as the mount system call is not implemented for OpenBSD yet.
I have a diff but I haven&rsquo;t been able to test it yet as I don&rsquo;t feel like breaking my runtime right now.</p><p>The rabbit hole was deep and I fell in it.</p><div id=rewrote-the-network-code class=anchor></div><h2 class="relative group">Rewrote the network code
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#rewrote-the-network-code aria-label=Anchor>#</a></span></h2><p>I did a lot of work in both client and server code to clean them from the disgusting proof of concept to something decent,
and allowing more parallelism of operations.
I still have work to do in that area but the foundations are clean now.</p><p>The network code now uses <code>gob</code> to produce <strong>a binary protocol</strong> that I don&rsquo;t have to parse myself thanks to <code>gob</code> encoders/decoders working directly on a connection handler,
what a pleasure to not have to do that myself.</p><p>The server can now handle concurrent requests from the same client:
for example it is capable to process multiple requests at once contrarily to before,
speeding up considerably transfers.</p><p>The client also benefited from concurrency improvements.</p><div id=reworked-the-storage-interface class=anchor></div><h2 class="relative group">Reworked the storage interface
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#reworked-the-storage-interface aria-label=Anchor>#</a></span></h2><p>I reworked the storage interface to ease the writing of custom storage backends,
it is now relatively easy to write a backend and plug it in plakar without having to make changes outside of the implementation.</p><p>This sounds like nothing but interface implementation in Golang was puzzling me and I&rsquo;m happy I worked it out.</p><div id=added-support-for-an-sqlite-storage-backend class=anchor></div><h2 class="relative group">Added support for an SQLite storage backend
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#added-support-for-an-sqlite-storage-backend aria-label=Anchor>#</a></span></h2><p>With the storage layer reworked,
I implemented an SQLite storage allowing <code>plakar</code> to use an SQLite database instead of the filesystem:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ plakar on sqlite:///tmp/plakar.db create -no-encryption
</span></span><span style=display:flex><span>$ plakar on sqlite:///tmp/plakar.db push /bin            
</span></span><span style=display:flex><span>$ plakar on sqlite:///tmp/plakar.db ls       
</span></span><span style=display:flex><span>2021-11-27T00:12:04Z  99e53a9c-e503-4c32-8622-924bf966f15b     <span style=color:#bd93f9>11</span> MB /bin
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p><strike>This has advantages and disadvantages.</strike></p><p>SQLite backend is <strong>MUCH faster</strong> than using the filesystem on a <code>plakar push</code> / <code>plakar pull</code>,
mainly because <strong>operations are reduced to reads & writes</strong> in SQLite when the FS has to <strong>open / close</strong> files too for each chunk and object accesses.
The <strong>commit of a snapshot in SQLite is very efficient and fast</strong>,
whereas on the FS it can take a long while due to <strong>a lot of hard links tricks</strong>.
<strike>But&mldr; on the other end,
I trust my filesystem more than SQLite and I don&rsquo;t have to worry about <strong>multiple concurrent writers</strong> there.</strike></p><blockquote><p>Edit:
After thinking more about it, my irrational fear of storing backups in a single structured binary file doesn&rsquo;t hold:
I already do it with tarballs.</p><p>I also had a concern with concurrent writes because, many years ago, a writer would lock the entire database.
This would for instance prevent plakar from pushing a small snapshot while a very big one was holding a transaction for an extended period of time.
But I was stuck in the past, as SQLite introduced a WAL &mldr; 11 years ago.</p><p>Thanks to Glandos @ Github for questionning my SQLite fear which had me revisit the concurrent writers concern and realize it no longer held ground,
this will be very useful as even the SQLite code I wrote still assumed this old behaviour:</p><p>For example, the local cache opens the database in read-only and keeps track of all writes it wants to do,
then when a snapshot is committed, it reopens the database in write mode to flush changes and reduce the time it had to retain the database open.
This whole contorted way of working is no longer relevant and code can be simplified a lot.</p></blockquote><p>What&rsquo;s interesting is that SQLite support uses a generic SQL database connector,
so I will be able to implement support for any SQL database by rewriting some queries&mldr;
and obviously I have in mind databases that allow replication.</p><div id=optimized-local-cache-logic-and-replaced-with-an-sqlite-implementation class=anchor></div><h2 class="relative group">Optimized local cache logic and replaced with an SQLite implementation
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#optimized-local-cache-logic-and-replaced-with-an-sqlite-implementation aria-label=Anchor>#</a></span></h2><p>The local cache implementation was suboptimal,
only useful to test the logic but not really to improve performances,
partly because it&rsquo;s way of working was <strong>stepping in the way of the push algorithm</strong>&mldr;
so I reworked it to improve the situation.</p><p>While at it,
<strong>I switched from the previous FS-based local cache to an SQLite local cache</strong>,
mainly to avoid the cost of multiple system calls whenever checking if something was in cache.</p><div id=implemented-a-small-plakar-shell class=anchor></div><h2 class="relative group">Implemented a small plakar shell
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implemented-a-small-plakar-shell aria-label=Anchor>#</a></span></h2><p>Nothing too fancy,
I just needed to be able to run multiple commands on the same plakar session,
the shell just accepts commands and applies them to the same opened plakar.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ plakar on sqlite:///tmp/plakar.db shell
</span></span><span style=display:flex><span>plakar@sqlite:///tmp/plakar.db&gt; ls
</span></span><span style=display:flex><span>2021-11-27T00:12:04Z  99e53a9c-e503-4c32-8622-924bf966f15b     <span style=color:#bd93f9>11</span> MB /bin
</span></span><span style=display:flex><span>plakar@sqlite:///tmp/plakar.db&gt; ls
</span></span><span style=display:flex><span>2021-11-27T00:12:04Z  99e53a9c-e503-4c32-8622-924bf966f15b     <span style=color:#bd93f9>11</span> MB /bin
</span></span><span style=display:flex><span>plakar@sqlite:///tmp/plakar.db&gt; ^C
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>That doesn&rsquo;t look too useful but that&rsquo;s because in my articles I mainly provide examples on an <code>-no-encryption</code> plakar,
so you don&rsquo;t see me prompted for a passphrase every command I type.
When you have to type multiple commands,
using the <code>plakar shell</code> will only prompt at opening saving sanity.</p><div id=implemented-a-filesystem-view class=anchor></div><h2 class="relative group">Implemented a filesystem view
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implemented-a-filesystem-view aria-label=Anchor>#</a></span></h2><p>The snapshot indexes consisted mainly of maps mapping checksums to pathnames or pathnames to file informations, etc&mldr;</p><p>This was efficient for <strong>direct access to a resource by its name</strong>,
like searching what&rsquo;s the file informations for <code>/etc/passwd</code>,
but not so much for operations involving <strong>partial pathnames</strong>,
such as finding what files are in a directory.
Unfortunately such operations are numerous as <code>plakar</code> supports a <code>ls</code> command to browse the snapshot,
but also <code>cat</code>-ing, <code>pull</code>-ing or even creating tarballs from subdirectories within a snapshot.</p><p>To work around,
I had implemented helpers that would do things like comparing full pathnames and determining if a path was within another,
but this was confusing and inefficient as it required looking at the entire set of entries in the snapshot,
and playing games with string prefixes.</p><p>I <strong>implemented a filesystem within the index in the form a tree of file informations</strong>,
as well as a set of functions to lookup pathnames in that tree.
This has considerably simplified a lot of code and allows to lookup resources in the index similarly to how I would on the real filesystem.</p><p>I kept the maps as indexes for direct lookups so that whenever searching for a precise resource,
there is no need to go through the filesystem and traverse nodes,
but so that whenever searching for a set of resources or trying to discover what&rsquo;s in a directory hierarchy,
the tree can be used instead.</p><div id=implement-cpu-throttling class=anchor></div><h2 class="relative group">Implement CPU throttling
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implement-cpu-throttling aria-label=Anchor>#</a></span></h2><p>Until now,
<code>plakar</code> would <strong>use all of the available resources</strong> to perform operations as fast as possible.</p><center><img src=cpu-nothrottling.jpeg height=300px></center><p>While I think the default should be to <strong>run as close as possible to max limit</strong> and let the machine throttle,
it&rsquo;s also not a good idea to not leave at least one core for the OS to work correctly.</p><p>I implemented CPU throttling so that <code>plakar</code> can be told to limit itself to a certain number of cores with the <code>-cpu</code> option,
and I set the default to be between <code>1</code> and <code>cpus-1</code> cpus, whichever is the most.
On a 1 core VPS,
it will consume up to a full CPU,
while on my 8 core laptop it will consume 7 by default.</p><p>The effect of passing a <code>-cpu</code> option are quite visible as you can see with this <code>plakar -cpu 4 push ...</code></p><center><img src=cpu-throttling.jpeg height=300px></center><div id=simplify-and-optimize-plakar-push class=anchor></div><h2 class="relative group">Simplify and optimize <code>plakar push</code>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#simplify-and-optimize-plakar-push aria-label=Anchor>#</a></span></h2><p>I reworked the <code>push</code> logic to simplify and optimize the strategy,
leading to <strong>less store calls</strong> and much improved performances with much more readable code.</p><p>With the help of discord user Spire,
improvements were made leading to performances boosts due to <strong>code patterns that caused too many allocations</strong>.</p><p>There are still improvements to make but things are looking bright 😃</p><div id=parallelized-plakar-keep-plakar-rm-plakar-ls class=anchor></div><h2 class="relative group">Parallelized <code>plakar keep</code>, <code>plakar rm</code>, <code>plakar ls</code>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#parallelized-plakar-keep-plakar-rm-plakar-ls aria-label=Anchor>#</a></span></h2><p>Both <code>plakar keep</code> and <code>plakar rm</code> worked by <strong>removing snapshots sequentially</strong> from the store,
I updated them so that they could run the <strong>removals in concurrency</strong>,
allowing for faster execution.</p><p>The <code>plakar ls</code> case was similar in that to display the snapshots listing,
it had to fetch the snapshot indexes,
and it did that sequentially.
When multiple big snapshot indexes were in the store,
this could lead to a delay before the listing was displayed as <strong>each snapshot index would be fetched and deserialized sequentially</strong>,
not exploiting the availability of multiple cores.
I converted <code>plakar ls</code> to use concurrency for the fetch and deserialize,
synchronizing the routines before the sorting and display.</p><div id=fixed-ui class=anchor></div><h2 class="relative group">Fixed UI
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#fixed-ui aria-label=Anchor>#</a></span></h2><p>The UI was badly broken due to the many changes I made in the API,
so I spent a while fixing it and <strong>taking advantage of the new snapshot filesystem view</strong> to provide directory browsing:</p><center><img src=feature.png></center><p>I also improved slightly the view for individual resources,
added the ability to <strong>download file</strong>s or <strong>tarballs</strong>.</p><div id=implemented-plakar-clone class=anchor></div><h2 class="relative group">Implemented <code>plakar clone</code>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implemented-plakar-clone aria-label=Anchor>#</a></span></h2><p>I wrote a <code>plakar clone</code> command to fully replicate a repository:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ plakar on sqlite:///tmp/plakar.db clone /tmp/cloned
</span></span><span style=display:flex><span>$ plakar on /tmp/cloned ls
</span></span><span style=display:flex><span>2021-11-27T00:12:04Z  99e53a9c-e503-4c32-8622-924bf966f15b     <span style=color:#bd93f9>11</span> MB /bin
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>This allows creating an <strong>exact replica of an existing plakar repository</strong>,
regardless of where it&rsquo;s located (filesystem, network or database) into a local directory,
and respecting the internal structure of the original repository:
it is not just a dumb file copy but really the <strong>cloning of the internal state</strong>,
<strong>preserving reference counts and such</strong>.</p><p>The fact that it can only clone to a local directory is a temporary technical limitation that <strong>will be lifted in the future</strong> as my ultimate goal is to be able to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ plakar on plakar://192.168.1.2 clone plakar://192.168.1.1
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><p>&mldr; and have a plakar be reconstructed from a remote machine to another remote machine.</p><p>The idea is that you can clone an off-site plakar on a regular basis and know that if something happened to the main one,
you&rsquo;d still have a version of it that has a <strong>coherent internal state</strong>.
When the local filesystem technical limitation is lifted,
I&rsquo;ll working on a <strong>synchronization mechanism</strong> so that two remote plakar may exchange chunks, objects and snapshots in an efficient way,
without having to clone the entire repository.</p><div id=implemented-plakar-check-and-fast-checking class=anchor></div><h2 class="relative group">Implemented <code>plakar check</code> and fast checking
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#implemented-plakar-check-and-fast-checking aria-label=Anchor>#</a></span></h2><p>The <code>plakar check &lt;snapshot></code> command already existed to <strong>check the integrity of a snapshot</strong> by requesting the store to return each of its chunks and objects,
allowing <code>plakar</code> to both validate that it could perform a full restore if needed and that checksums matched.</p><p>After a discussion on Discord,
I implemented <strong>fast checking</strong> which is a relaxed check requesting only that the store acknowledges existence of chunks and objects.
This allows speeding up <strong>considerably</strong> the snapshot checks when you trust the store to respond honestly on the availability of resources.</p><p>I finally implemented <code>plakar check</code> (no snapshot parameter) to perform a <strong>full plakar repository coherency check</strong>,
validating that the store doesn&rsquo;t contain orphan chunks and objects,
but also that they have a reference count matching the number of snapshots relying on them,
and that no snapshot lacks a reference to a resource that&rsquo;s still in the store&mldr; only because it is held by another snapshot.</p><p>As long as a resource is available in the store,
even if the snapshot lost its reference somehow,
plakar will manage to restore the resource:
this is nice because you don&rsquo;t want to fail recovering something for which you do have the data,
but you also don&rsquo;t want that to hide the fact that there was a corruption in the store somehow.</p><p>In theory,
<strong>unless you poke in the store and remove resources yourself</strong>,
these checks are never meant to fail but I&rsquo;ll sleep better knowing that I can have daily snapshots fast checks,
weekly snapshot checks and monthly repository checks&mldr;
and that if something goes wrong,
I can pull a backup and investigate what went wrong.</p><p>A nice improvement would be to provide the ability to repair some corruptions when doable,
but since this is not supposed to happen in the first place,
it&rsquo;s not very high in my list 😁</p><div id=assorted-other-work class=anchor></div><h1 class="relative group">Assorted other work
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#assorted-other-work aria-label=Anchor>#</a></span></h1><p>After a month of learning,
I can now play <strong>Ode to Joy</strong>, <strong>Autumn Leaves</strong>, and <strong>And I love her</strong> on the piano, that required some assorted work.</p><hr><p>Comments: <a href=https://github.com/poolpOrg/poolp.org/discussions/140 target=_blank>https://github.com/poolpOrg/poolp.org/discussions/140</a></p></br></br></div><script>var oid="views_posts/2021-11-01/index.md",oid_likes="likes_posts/2021-11-01/index.md"</script><script type=text/javascript src=/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js integrity="sha512-DkmXO0rQo4LHxgEti/+CJjFmQtqrxPiiBHe9CGdPPabi+pk7wgrU9R58W7aOb5E6IHp8T+N+oOe4BolK/OCmTg=="></script></section><footer class="pt-8 max-w-prose print:hidden"><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;title=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;text=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title="Tweet on Twitter" aria-label="Tweet on Twitter"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;resubmit=true&amp;title=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title="Submit to Reddit" aria-label="Submit to Reddit"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;description=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title="Pin on Pinterest" aria-label="Pin on Pinterest"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;quote=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title="Share on Facebook" aria-label="Share on Facebook"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;subject=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title="Send via email" aria-label="Send via email"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;resubmit=true&amp;title=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title aria-label><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://poolp.org/posts/2021-10-26/november-2021-a-bit-of-go-ipcmsg-a-bit-of-go-privsep-and-a-ton-of-plakar/&amp;resubmit=true&amp;title=November%202021:%20a%20bit%20of%20go-ipcmsg,%20a%20bit%20of%20go-privsep%20and%20a%20ton%20of%20plakar" title aria-label><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a></section><h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><a href=/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/feature_hufc29ea1acb8d39c01e9e1abf42787b18_579873_600x0_resize_box_3.png)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/>April 2021: OpenSMTPD, plakar, ipcmsg, privsep and a small hypnosis talk</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-04-30 21:12:00 +0200 +0200">30 April 2021</time><span class="px-2 text-primary-500">&#183;</span><span>2700 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">13 mins</span></div><div class="flex flex-row flex-wrap items-center"><div style=cursor:pointer onclick='window.open("/authors/gilles/","_self")'>Gilles Chehade</div></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/technology/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">technology</span></span></span></div></div><div class="py-1 prose dark:prose-invert">TL;DR: I worked on OpenSMTPD-portable, did a lot of plakar, a lot of Go and gave a technical talk on hypnosis. Shout outs to my patrons !</div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/2021-10-26/october-2021-mostly-plakar/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/2021-10-26/october-2021-mostly-plakar/feature_huc948c70fe28be7ce376ed00d8321206e_38184_600x0_resize_q75_box.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/2021-10-26/october-2021-mostly-plakar/>October 2021: mostly Plakar</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-10-26 07:40:00 +0200 +0200">26 October 2021</time><span class="px-2 text-primary-500">&#183;</span><span>2715 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">13 mins</span></div><div class="flex flex-row flex-wrap items-center"><div style=cursor:pointer onclick='window.open("/authors/gilles/","_self")'>Gilles Chehade</div></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/technology/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">technology</span></span></span></div></div><div class="py-1 prose dark:prose-invert">TL;DR: I have a discord now, [https://discord.gg/YC6j4rbvSk](https://discord.gg/YC6j4rbvSk), feel free to join. I refactored plakar, implemented a local cache, improved parallelism, modified the push strategy, played with fuse and networking.</div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/2021-03-26/march-2021-backups-with-plakar/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/2021-03-26/march-2021-backups-with-plakar/feature_hu3228d61c2745a65e1489281cda383334_21562_600x0_resize_box_3.png)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/2021-03-26/march-2021-backups-with-plakar/>March 2021: backups with Plakar</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-03-26 16:52:00 +0200 +0200">26 March 2021</time><span class="px-2 text-primary-500">&#183;</span><span>4296 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">21 mins</span></div><div class="flex flex-row flex-wrap items-center"><div style=cursor:pointer onclick='window.open("/authors/gilles/","_self")'>Gilles Chehade</div></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/technology/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">technology</span></span></span></div></div><div class="py-1 prose dark:prose-invert">TL;DR: I wrote a backup utility called plakar. Shout outs to my patrons ! # As usual, a huge thanks goes to the people sponsoring me on patreon, github or liberaPay, the work in this post was made possible by my sponsorship.</div></div><div class="px-6 pt-4 pb-2"></div></div></a></section><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/2021-10-26/october-2021-mostly-plakar/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">October 2021: mostly Plakar</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-10-26 07:40:00 +0200 +0200">26 October 2021</time></span></span></a></span>
<span><a class="flex text-right group ml-3" href=/posts/2021-12-13/december-2021-a-bit-of-plakar-a-bit-of-go-fastcdc-and-some-useless-stuff/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">December 2021: a bit of plakar, a bit of go-fastcdc and some useless stuff</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-12-13 07:40:00 +0200 +0200">13 December 2021</time></span></span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=poolpOrg/poolp.org data-repo-id="MDEwOlJlcG9zaXRvcnkxMjYxODk2MjA=" data-category=Articles data-category-id=DIC_kwDOB4WANM4B-Zf1 data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">Copyright © Gilles Chehade - poolp.org</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.35c1113bcc16c5a59bf031082f9e63822aa95280423881a7847a7ff33a16e6299ce6a840d9ef4e10d947e030a18f3f20359afb2ec0f35967484b9a9360ac3145.js integrity="sha512-NcERO8wWxaWb8DEIL55jgiqpUoBCOIGnhHp/8zoW5imc5qhA2e9OENlH4DChjz8gNZr7LsDzWWdIS5qTYKwxRQ=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://poolp.org style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=poolporg data-description="Support me on Buy me a coffee!" data-message="Support me !" data-color=#FFDD00 data-position=Left data-x_margin=18 data-y_margin=18></script></html>