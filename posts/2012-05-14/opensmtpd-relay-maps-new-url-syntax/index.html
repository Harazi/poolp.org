<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>OpenSMTPD relay maps & new url syntax - poolp.org</title><meta property="og:title" content="OpenSMTPD relay maps & new url syntax"><meta name=twitter:title content="OpenSMTPD relay maps & new url syntax"><meta name=description content="When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.
Amongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:
Using the DNS system to find MX records: accept for [&mldr;] relay
Using the provided mail exchanger: accept for [&mldr;] relay via &ldquo;my-mx."><meta property="og:description" content="When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.
Amongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:
Using the DNS system to find MX records: accept for [&mldr;] relay
Using the provided mail exchanger: accept for [&mldr;] relay via &ldquo;my-mx."><meta name=twitter:description content="When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic …"><meta name=author content="Gilles Chehade"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"poolp.org","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/poolp.org\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/poolp.org\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/poolp.org\/posts\/2012-05-14\/opensmtpd-relay-maps-new-url-syntax\/","name":"Open SMTP d relay maps \u0026 new URL syntax"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Gilles Chehade"},"headline":"OpenSMTPD relay maps \u0026 new url syntax","description":"When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.\nAmongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:\nUsing the DNS system to find MX records: accept for [\u0026hellip;] relay\nUsing the provided mail exchanger: accept for [\u0026hellip;] relay via \u0026ldquo;my-mx.","inLanguage":"en","wordCount":462,"datePublished":"2012-05-14T09:55:52","dateModified":"2012-05-14T09:55:52","image":"https:\/\/poolp.org\/","keywords":[""],"mainEntityOfPage":"https:\/\/poolp.org\/posts\/2012-05-14\/opensmtpd-relay-maps-new-url-syntax\/","publisher":{"@type":"Organization","name":"https:\/\/poolp.org\/","logo":{"@type":"ImageObject","url":"https:\/\/poolp.org\/","height":60,"width":60}}}</script><meta property="og:title" content="OpenSMTPD relay maps & new url syntax"><meta property="og:description" content="When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.
Amongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:
Using the DNS system to find MX records: accept for [&mldr;] relay
Using the provided mail exchanger: accept for [&mldr;] relay via &ldquo;my-mx."><meta property="og:url" content="https://poolp.org/posts/2012-05-14/opensmtpd-relay-maps-new-url-syntax/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=twitter:title content="OpenSMTPD relay maps & new url syntax"><meta name=twitter:description content="When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic …"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@poolpOrg"><meta name=twitter:creator content="@poolpOrg"><meta property="og:url" content="https://poolp.org/posts/2012-05-14/opensmtpd-relay-maps-new-url-syntax/"><meta property="og:type" content="website"><meta property="og:site_name" content="poolp.org"><meta name=generator content="Hugo 0.82.1"><link rel=alternate href=https://poolp.org/index.xml type=application/rss+xml title=poolp.org><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://poolp.org/css/main.css><link rel=stylesheet href=https://poolp.org/css/highlight.min.css><link rel=stylesheet href=https://poolp.org/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><link rel=stylesheet href=/css/poolp.css></head><body><div class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><a class=navbar-brand href=https://poolp.org/ target=_blank>p<font color=#ff0000>oo</font>lp.org</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li class=navlinks-container><a class=navlinks-parent>Freelance</a><div class=navlinks-children><a href=/en/contracting/>[en] Hire me !</a>
<a href=/fr/contracting/>[fr] Recrutez moi !</a></div></li><li class=navlinks-container><a class=navlinks-parent>Social</a><div class=navlinks-children><a href=https://patreon.com/gilles>Patreon</a>
<a href=https://www.linkedin.com/in/gilleschehade>LinkedIn</a>
<a href=https://github.com/poolpOrg>Github</a>
<a href=https://twitter.com/poolpOrg>Twitter</a></div></li><li class=navlinks-container><a class=navlinks-parent>Curriculum</a><div class=navlinks-children><a href=https://github.com/poolpOrg/resume/blob/master/resume.en.pdf>EN</a>
<a href=https://github.com/poolpOrg/resume/blob/master/resume.fr.pdf>FR</a></div></li><li><a title=Hypnose href=https://hypno.cat>Hypnose</a></li></ul></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div><div class=posts-heading><h1 style=text-align:left>OpenSMTPD relay maps & new url syntax</h1></div></div></div></div></div></header><div class=container role=main><div class=row><div class=col-lg-12><article role=main class=blog-post><p>When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.</p><p>Amongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:</p><p>Using the DNS system to find MX records: accept for [&mldr;] relay</p><p>Using the provided mail exchanger: accept for [&mldr;] relay via &ldquo;my-mx.poolp.org&rdquo; [&mldr;]</p><p>The first method is straightforward, nothing can really be tweaked about it without tweaking the DNS system itself.</p><p>The second method is much more flexible as it allows providing a port, a transport method (plaintext ? starttls ? smtps ?), a credentials map for authentication to remote relays, a certificate, a SMTP-level FROM overriding, and possibly more as time passes.</p><p>In some situations, you can end up with a rule like: accept for all relay via &ldquo;my-mx.poolp.org&rdquo; tls port 25 certificate &ldquo;foobar&rdquo; auth &ldquo;mycredsmap&rdquo; as &ldquo;<a href=mailto:foo@bar.org>foo@bar.org</a>&rdquo;</p><p>Not too complicated, but not too nice either. It becomes annoying when we start considering implementation of mappings at the relay level:</p><p>map &ldquo;relaymap&rdquo; source plain &ldquo;/etc/mail/relaymap&rdquo;</p><p>accept for all relay via map &ldquo;relaymap&rdquo; tls port 25 certificate &ldquo;foobar&rdquo; auth &ldquo;mycredsmap&rdquo; as &ldquo;<a href=mailto:foo@bar.org>foo@bar.org</a>&rdquo;</p><p>How do you specifiy different ports, different ssl options and enable/disable auth on a specific MX ?</p><p>Well you can&rsquo;t because tls, port and auth is tied to the rule and not the MX referenced by the rule&mldr;</p><p>So I came up with a prototype for a new syntax:</p><p>accept for all relay via &ldquo;[schema://]host[:port]&rdquo;</p><p>Where schema can be smtp://, smtps://, tls://, ssl://, smtps+auth://, tls+auth:// or ssl+auth://.</p><p>As usual we default to the sanest behaviour so if you specify (or use the default) smtp://, like:</p><p>accept for all relay via &ldquo;mx.poolp.org&rdquo;</p><p>OpenSMTPD will attempt to use STARTTLS if possible before falling back to a plaintext session; whereas:</p><p>accept for all relay via &ldquo;tls://mx.poolp.org&rdquo;</p><p>OpenSMTPD will make it mandatory to use a STARTTLS session, refusing to deliver the message otherwise.</p><p>Since the MX options are now tied to the MX itself, it becomes possible to store them in a map:</p><p>% cat /etc/mail/mxmap.txt ssl://mx1.poolp.org ssl://mx2.poolp.org ssl://mx3.poolp.org</p><p>% cat /etc/mail/smtpd.conf map &ldquo;mxmap&rdquo; source plain &ldquo;/etc/mail/mxmap.txt&rdquo;</p><p>accept for all relay via map &ldquo;mxmap&rdquo;</p><p>Of course, this will become more interesting when the implementation for relay maps is done and allows looking policies (round-robin, random, ratio, &mldr;) and that you can use them from other backends like SQL or db, as this will allow changing exchangers at runtime, a feature that offers plennnnnnty of possibilities :-)</p><p>Anyways, I have it mostly working on my sandbox, it still needs a couple hours of work I think, I&rsquo;ll get to it by this week-end if time permits.</p><p>Stay tuned !</p><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f&text=OpenSMTPD%20relay%20maps%20%26%20new%20url%20syntax&via=poolpOrg" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f&title=OpenSMTPD%20relay%20maps%20%26%20new%20url%20syntax" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f&title=OpenSMTPD%20relay%20maps%20%26%20new%20url%20syntax" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f&title=OpenSMTPD%20relay%20maps%20%26%20new%20url%20syntax" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f&description=OpenSMTPD%20relay%20maps%20%26%20new%20url%20syntax" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://poolp.org/posts/2012-05-13/opensmtpd-map_compare-and-k_netaddr/ data-toggle=tooltip data-placement=top title="OpenSMTPD, map_compare() and K_NETADDR">&larr; Previous Post</a></li><li class=next><a href=https://poolp.org/posts/2012-05-17/opensmtpd-src-address-maps-and-spamhaus/ data-toggle=tooltip data-placement=top title="OpenSMTPD: src-address maps and spamhaus">Next Post &rarr;</a></li></ul></div></div></div><footer><p><h2>Like my work and want to help me ?</h2><ul><li>Consider <b>tipping me</b> on <b><a target=_blank href=https://paypal.me/poolpOrg>PayPal</a></b>,
<b>supporting me</b> through one of the <b>sponsoring</b> platforms at <b><a href=https://github.com/sponsors/poolpOrg>Github</a></b>, <b><a href=https://patreon.com/gilles>Patreon</a></b> or
<b><a href=https://liberapay.com/poolpOrg>LiberaPay</a></b>,
or even <b>getting me something</b> from my wishlist on <b><a target=_blank href=http://amzn.eu/3MwH6CX>Amazon</a></b>
for positive <b><a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a></b> :-)<br></li><li>You can also help me by <b>commenting articles</b> to spark discussions,
and by <b>sharing them</b> so they reach a bigger audience,
they all contain a comment link and icons that will let you share to popular social networks.</li></ul></p><p class="credits copyright text-muted"><a href=https://poolp.org>Gilles Chehade</a>
-&nbsp;&copy;
2021
-
<a href=https://poolp.org/>poolp.org</a></p><p class="credits theme-by text-muted"><a href=http://gohugo.io>Hugo v0.82.1</a> powered - adapted from a weird mix of <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>, <a href=https://papercss-hugo-theme.netlify.app/>PaperCss</a> and some <a href=https://github.com/davidrzs/latexcss>LatexCSS</a></p></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://poolp.org/js/main.js></script><script src=https://poolp.org/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script>renderMathInElement(document.body)</script></body></html>