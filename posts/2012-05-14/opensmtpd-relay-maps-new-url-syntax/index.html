<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.98.0"><link rel=icon href=/images/poolp_org.png><title>OpenSMTPD relay maps & new url syntax | poolp.org</title><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenSMTPD relay maps & new url syntax"><meta name=twitter:description content="When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.
Amongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:
Using the DNS system to find MX records: accept for [&mldr;] relay
Using the provided mail exchanger: accept for [&mldr;] relay via &ldquo;my-mx."><meta property="og:title" content="OpenSMTPD relay maps & new url syntax"><meta property="og:description" content="When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.
Amongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:
Using the DNS system to find MX records: accept for [&mldr;] relay
Using the provided mail exchanger: accept for [&mldr;] relay via &ldquo;my-mx."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2012-05-14/opensmtpd-relay-maps-new-url-syntax/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-05-14T09:55:52+00:00"><meta property="article:modified_time" content="2012-05-14T09:55:52+00:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li><li class=nav-item><a class=nav-link href=/authors/gilles-chehade>About Me</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=OpenSMTPD%20relay%20maps%20%26%20new%20url%20syntax&url=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1'><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2012-05-14%2fopensmtpd-relay-maps-new-url-syntax%2f" onclick='return window.open(this.href,"xing-share","width=550,height=435"),!1'><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade / جيل شحادة"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade / جيل شحادة</a><br><span class=author-description>foobarbaz-ing since 1981<br></span><br><span class=author-description><i class="far fa-star"></i>
May 14, 2012
<i class="far fa-clock clock"></i>
3 min read</span></div></div><div class=after-post-tags><ul class=tags></ul></div><h1 class=posttitle>OpenSMTPD relay maps & new url syntax</h1></div><div class=article-post><p>When we first started working on OpenSMTPD, we planned for future features but we did not necessarily start integrating them right away as the goal was to bootstrap the project first with basic features.</p><p>Amongst these features was the ability to use mappings for outgoing MX servers. Currently, OpenSMTPD knows two ways of going out:</p><p>Using the DNS system to find MX records: accept for [&mldr;] relay</p><p>Using the provided mail exchanger: accept for [&mldr;] relay via &ldquo;my-mx.poolp.org&rdquo; [&mldr;]</p><p>The first method is straightforward, nothing can really be tweaked about it without tweaking the DNS system itself.</p><p>The second method is much more flexible as it allows providing a port, a transport method (plaintext ? starttls ? smtps ?), a credentials map for authentication to remote relays, a certificate, a SMTP-level FROM overriding, and possibly more as time passes.</p><p>In some situations, you can end up with a rule like: accept for all relay via &ldquo;my-mx.poolp.org&rdquo; tls port 25 certificate &ldquo;foobar&rdquo; auth &ldquo;mycredsmap&rdquo; as &ldquo;<a href=mailto:foo@bar.org>foo@bar.org</a>&rdquo;</p><p>Not too complicated, but not too nice either. It becomes annoying when we start considering implementation of mappings at the relay level:</p><p>map &ldquo;relaymap&rdquo; source plain &ldquo;/etc/mail/relaymap&rdquo;</p><p>accept for all relay via map &ldquo;relaymap&rdquo; tls port 25 certificate &ldquo;foobar&rdquo; auth &ldquo;mycredsmap&rdquo; as &ldquo;<a href=mailto:foo@bar.org>foo@bar.org</a>&rdquo;</p><p>How do you specifiy different ports, different ssl options and enable/disable auth on a specific MX ?</p><p>Well you can&rsquo;t because tls, port and auth is tied to the rule and not the MX referenced by the rule&mldr;</p><p>So I came up with a prototype for a new syntax:</p><p>accept for all relay via &ldquo;[schema://]host[:port]&rdquo;</p><p>Where schema can be smtp://, smtps://, tls://, ssl://, smtps+auth://, tls+auth:// or ssl+auth://.</p><p>As usual we default to the sanest behaviour so if you specify (or use the default) smtp://, like:</p><p>accept for all relay via &ldquo;mx.poolp.org&rdquo;</p><p>OpenSMTPD will attempt to use STARTTLS if possible before falling back to a plaintext session; whereas:</p><p>accept for all relay via &ldquo;tls://mx.poolp.org&rdquo;</p><p>OpenSMTPD will make it mandatory to use a STARTTLS session, refusing to deliver the message otherwise.</p><p>Since the MX options are now tied to the MX itself, it becomes possible to store them in a map:</p><p>% cat /etc/mail/mxmap.txt ssl://mx1.poolp.org ssl://mx2.poolp.org ssl://mx3.poolp.org</p><p>% cat /etc/mail/smtpd.conf map &ldquo;mxmap&rdquo; source plain &ldquo;/etc/mail/mxmap.txt&rdquo;</p><p>accept for all relay via map &ldquo;mxmap&rdquo;</p><p>Of course, this will become more interesting when the implementation for relay maps is done and allows looking policies (round-robin, random, ratio, &mldr;) and that you can use them from other backends like SQL or db, as this will allow changing exchangers at runtime, a feature that offers plennnnnnty of possibilities :-)</p><p>Anyways, I have it mostly working on my sandbox, it still needs a couple hours of work I think, I&rsquo;ll get to it by this week-end if time permits.</p><p>Stay tuned !</p></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2012-05-17/opensmtpd-src-address-maps-and-spamhaus/>&#171; OpenSMTPD: src-address maps and spamhaus</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2012-05-13/opensmtpd-map_compare-and-k_netaddr/>OpenSMTPD, map_compare() and K_NETADDR &#187;</a><div class=clearfix></div></div></div></div></div></div><div class=alertbar><div class="container text-center"><span><img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)</span></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright poolp.org - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script></body></html>