<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.98.0"><link rel=icon href=/images/poolp_org.png><title>Install OpenBSD on dedibox with full-disk encryption | poolp.org</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Install OpenBSD on dedibox with full-disk encryption"><meta name=twitter:description content="TL;DR: I run several &#34;dedibox&#34; servers at online.net, all powered by OpenBSD. OpenBSD is not officially supported so you have to work-around. Running full-disk encrypted OpenBSD there is a piece of cake. As a bonus, my first steps within a brand new booted machine ;-)  Step #0: choosing your server OpenBSD is not officially supported, I can&rsquo;t guarantee that this will work for you on any kind of server online."><meta property="og:title" content="Install OpenBSD on dedibox with full-disk encryption"><meta property="og:description" content="TL;DR: I run several &#34;dedibox&#34; servers at online.net, all powered by OpenBSD. OpenBSD is not officially supported so you have to work-around. Running full-disk encrypted OpenBSD there is a piece of cake. As a bonus, my first steps within a brand new booted machine ;-)  Step #0: choosing your server OpenBSD is not officially supported, I can&rsquo;t guarantee that this will work for you on any kind of server online."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2018-01-29/install-openbsd-on-dedibox-with-full-disk-encryption/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-29T23:28:00+00:00"><meta property="article:modified_time" content="2018-01-29T23:28:00+00:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li><li class=nav-item><a class=nav-link href=/authors/gilles-chehade>About Me</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=Install%20OpenBSD%20on%20dedibox%20with%20full-disk%20encryption&url=https%3a%2f%2fpoolp.org%2fposts%2f2018-01-29%2finstall-openbsd-on-dedibox-with-full-disk-encryption%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2018-01-29%2finstall-openbsd-on-dedibox-with-full-disk-encryption%2f" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1'><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2018-01-29%2finstall-openbsd-on-dedibox-with-full-disk-encryption%2f" onclick='return window.open(this.href,"xing-share","width=550,height=435"),!1'><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade / جيل شحادة"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade / جيل شحادة</a><br><span class=author-description>foobarbaz-ing since 1981<br></span><br><span class=author-description><i class="far fa-star"></i>
Jan 29, 2018
<i class="far fa-clock clock"></i>
11 min read</span></div></div><div class=after-post-tags><ul class=tags></ul></div><h1 class=posttitle>Install OpenBSD on dedibox with full-disk encryption</h1></div><div class=article-post><pre><code>TL;DR:
I run several &quot;dedibox&quot; servers at online.net, all powered by OpenBSD.
OpenBSD is not officially supported so you have to work-around.
Running full-disk encrypted OpenBSD there is a piece of cake.
As a bonus, my first steps within a brand new booted machine ;-)
</code></pre><h2 id=step-0-choosing-your-server>Step #0: choosing your server</h2><p>OpenBSD is not officially supported,
I can&rsquo;t guarantee that this will work for you on any kind of server online.net provides,
however I&rsquo;ve been running <a href=https://poolp.org>https://poolp.org</a> on OpenBSD there since 2008,
only switching machines as they were getting a bit old and new offers came up.</p><p>Currently,
I&rsquo;m running two SC 2016 (SATA) and one XC 2016 (SSD) boxes,
all three running OpenBSD reliably ever since I installed them.</p><p>Recently I&rsquo;ve been willing to reinstall the XC one after I did some experiments that turned it into a FrankenBSD,
so this was the right occasion to document how I do it for future references.</p><p><a href=https://poolp.org/posts/2013-05-08/installer-openbsd-sur-une-dedibox-classic-gen2/>I wrote an article similar to this a few years ago relying on <code>qemu</code> to install to the disk</a>,
since then online.net provided access to a virtual serial console accessed within the browser,
making it much more convenient to install without the <code>qemu</code> indirection which hid the NIC devices and disks duid and required tricks.</p><p>The method I currently use is a mix and adaptation from the techniques described in
<a href=https://www.2f30.org/guides/openbsd-dedibox.html>https://www.2f30.org/guides/openbsd-dedibox.html</a>
to boot the installer,
and the technique described in
<a href=https://geekyschmidt.com/2011/01/19/configuring-openbsd-softraid-fo-encryption.html>https://geekyschmidt.com/2011/01/19/configuring-openbsd-softraid-fo-encryption.html</a>
to setup the crypto slice.</p><h2 id=step-1-boot-to-rescue-mode>Step #1: boot to rescue mode</h2><p>The web console has a rescue mode which will essentially boot the server on a system running in RAM.</p><p>This usually allows you to unfuck a broken system by booting a Linux or FreBSD system,
mounting disks,
making appropriate changes to the disk,
then rebooting back to the original system.</p><p>We will actually make use of this rescue mode to write an OpenBSD boot disk image at the beginning of the real disk,
allowing us to reboot the server right into the OpenBSD intaller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>laptop$ ssh gilles@163.172.61.249
</span></span><span class=line><span class=cl>[...]
</span></span><span class=line><span class=cl>gilles@163-172-61-249:~$ wget https://ftp.fr.openbsd.org/pub/OpenBSD/6.2/amd64/miniroot62.fs
</span></span><span class=line><span class=cl>[...]
</span></span><span class=line><span class=cl>gilles@163-172-61-249:~$ sudo dd if=miniroot62.fs of=/dev/sda
</span></span><span class=line><span class=cl>[sudo] password for gilles:
</span></span><span class=line><span class=cl>9600+0 records in
</span></span><span class=line><span class=cl>9600+0 records out
</span></span><span class=line><span class=cl>4915200 bytes (4,9 MB, 4,7 MiB) copied, 0,116668 s, 42,1 MB/s
</span></span><span class=line><span class=cl>gilles@163-172-61-249:~$
</span></span></code></pre></div><p>You can then reboot back to normal mode and activate the serial console from the web console.</p><h2 id=step-2-boot-to-the-installer>Step #2: boot to the installer</h2><p>On the serial console, you will be greeted by the bootloader prompt.
For some reason,
every couple seconds a keystroke gets triggered by the interface causing the &rsquo;n&rsquo; character to be inserted.
It takes a bit of synchronization but you should be able to set tty to com1,
getting rid of the keystroke and allowing proper output to the terminal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>boot&gt; set tty com1
</span></span><span class=line><span class=cl>&gt;&gt; OpenBSD/amd64 BOOT 3.33
</span></span><span class=line><span class=cl>boot&gt; boot
</span></span></code></pre></div><p>The bootloader will load a ramdisk kernel and drop you into the installer,
which is our next step.</p><h2 id=step-3-prepare-softraid>Step #3: prepare softraid</h2><p>Once the installer is started,
drop immediately into a shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Welcome to the OpenBSD/amd64 6.2 installation program.
</span></span><span class=line><span class=cl>(I)nstall, (U)pgrade, (A)utoinstall or (S)hell? s
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><p>First of all, we need to rewrite the MBR after we messed it up with our miniroot trick:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># fdisk -iy sd0
</span></span><span class=line><span class=cl>Writing MBR at offset 0.
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><p>Then, we can enter the disklabel to setup a RAID slice and a swap slice,
keeping in mind that swap is already encrypted by default on OpenBSD.
The RAID slice will be used to setup softraid with the crypto discipline.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># disklabel -E sd0
</span></span><span class=line><span class=cl>Label editor (enter &#39;?&#39; for help at any prompt)
</span></span><span class=line><span class=cl>&gt; p M
</span></span><span class=line><span class=cl>OpenBSD area: 64-500103450; size: 244191.1M; free: 244191.1M
</span></span><span class=line><span class=cl>#                size           offset  fstype [fsize bsize   cpg]
</span></span><span class=line><span class=cl>  c:        244198.3M                0  unused
</span></span><span class=line><span class=cl>&gt; a
</span></span><span class=line><span class=cl>partition: [a] 
</span></span><span class=line><span class=cl>offset: [64]
</span></span><span class=line><span class=cl>size: [500103386] 240000M
</span></span><span class=line><span class=cl>Rounding size to cylinder (16065 sectors): 491524676
</span></span><span class=line><span class=cl>FS type: [4.2BSD] RAID
</span></span><span class=line><span class=cl>&gt; a
</span></span><span class=line><span class=cl>partition: [b]
</span></span><span class=line><span class=cl>offset: [491524740]
</span></span><span class=line><span class=cl>size: [8578710]
</span></span><span class=line><span class=cl>FS type: [swap]
</span></span><span class=line><span class=cl>&gt; w
</span></span><span class=line><span class=cl>&gt; q
</span></span><span class=line><span class=cl>No label changes.
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><p>Once this is done, we can use bioctl to setup the encrypted slice:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># bioctl -c C -r auto -l /dev/sd0a softraid0
</span></span><span class=line><span class=cl>New passphrase:
</span></span><span class=line><span class=cl>Re-type passphrase:
</span></span><span class=line><span class=cl>sd1 at scsibus1 targ 1 lun 0: &lt;OPENBSD, SR CRYPTO, 006&gt; SCSI2 0/direct fixed
</span></span><span class=line><span class=cl>sd1: 240002MB, 512 bytes/sector, 491524148 sectors  
</span></span><span class=line><span class=cl>softraid0: CRYPTO volume attached as sd1
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><p>At this point, we&rsquo;re ready to perform a regular install&mldr; <strong>on sd1, not sd0, beware</strong>,:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># install
</span></span><span class=line><span class=cl>At any prompt except password prompts you can escape to a shell by
</span></span><span class=line><span class=cl>typing &#39;!&#39;. Default answers are shown in []&#39;s and are selected by
</span></span><span class=line><span class=cl>pressing RETURN.  You can exit this program at any time by pressing
</span></span><span class=line><span class=cl>Control-C, but this can leave your system in an inconsistent state.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Terminal type? [vt220]
</span></span><span class=line><span class=cl>System hostname? (short form, e.g. &#39;foo&#39;) pocs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Available network interfaces are: em0 em1 vlan0.
</span></span><span class=line><span class=cl>Which network interface do you wish to configure? (or &#39;done&#39;) [em0]
</span></span><span class=line><span class=cl>IPv4 address for em0? (or &#39;dhcp&#39; or &#39;none&#39;) [dhcp]
</span></span><span class=line><span class=cl>em0: DHCPDISCOVER - interval 1
</span></span><span class=line><span class=cl>em0: DHCPOFFER from 163.172.61.1 (00:81:c4:f6:e9:17)
</span></span><span class=line><span class=cl>em0: DHCPREQUEST to 255.255.255.255
</span></span><span class=line><span class=cl>em0: DHCPACK from 163.172.61.1 (00:81:c4:f6:e9:17)
</span></span><span class=line><span class=cl>em0: bound to 163.172.61.249 -- renewal in 2147483647 seconds
</span></span><span class=line><span class=cl>IPv6 address for em0? (or &#39;autoconf&#39; or &#39;none&#39;) [none]
</span></span><span class=line><span class=cl>Available network interfaces are: em0 em1 vlan0.
</span></span><span class=line><span class=cl>Which network interface do you wish to configure? (or &#39;done&#39;) [done]
</span></span><span class=line><span class=cl>Default IPv4 route? (IPv4 address or none) [163.172.61.1]
</span></span><span class=line><span class=cl>add net default: gateway 163.172.61.1
</span></span><span class=line><span class=cl>Using DNS domainname online.net
</span></span><span class=line><span class=cl>Using DNS nameservers at 62.210.16.6 62.210.16.7
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Password for root account? (will not echo)
</span></span><span class=line><span class=cl>Password for root account? (again)
</span></span><span class=line><span class=cl>Start sshd(8) by default? [yes]
</span></span><span class=line><span class=cl>Change the default console to com1? [yes]
</span></span><span class=line><span class=cl>Available speeds are: 9600 19200 38400 57600 115200.
</span></span><span class=line><span class=cl>Which speed should com1 use? (or &#39;done&#39;) [9600]
</span></span><span class=line><span class=cl>Setup a user? (enter a lower-case loginname, or &#39;no&#39;) [no] gilles
</span></span><span class=line><span class=cl>Full name for user gilles? [gilles]
</span></span><span class=line><span class=cl>Password for user gilles? (will not echo)
</span></span><span class=line><span class=cl>Password for user gilles? (again)
</span></span><span class=line><span class=cl>WARNING: root is targeted by password guessing attacks, pubkeys are safer.
</span></span><span class=line><span class=cl>Allow root ssh login? (yes, no, prohibit-password) [no]
</span></span><span class=line><span class=cl>What timezone are you in? (&#39;?&#39; for list) [Europe/Paris]
</span></span></code></pre></div><p>I insist again, you want to write to the new softraid-backed disk:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Available disks are: sd0 sd1.
</span></span><span class=line><span class=cl>Which disk is the root disk? (&#39;?&#39; for details) [sd0] sd1
</span></span><span class=line><span class=cl>No valid MBR or GPT.
</span></span><span class=line><span class=cl>Use (W)hole disk MBR, whole disk (G)PT or (E)dit? [whole]
</span></span><span class=line><span class=cl>Setting OpenBSD MBR partition to whole sd1...done.
</span></span><span class=line><span class=cl>The auto-allocated layout for sd1 is:
</span></span><span class=line><span class=cl>#                size           offset  fstype [fsize bsize   cpg]
</span></span><span class=line><span class=cl>  a:             1.0G               64  4.2BSD   2048 16384     1 # /
</span></span><span class=line><span class=cl>  b:            16.2G          2097216    swap
</span></span><span class=line><span class=cl>  c:           234.4G                0  unused
</span></span><span class=line><span class=cl>  d:             4.0G         36067392  4.2BSD   2048 16384     1 # /tmp
</span></span><span class=line><span class=cl>  e:            29.5G         44455968  4.2BSD   2048 16384     1 # /var
</span></span><span class=line><span class=cl>  f:             2.0G        106342848  4.2BSD   2048 16384     1 # /usr
</span></span><span class=line><span class=cl>  g:             1.0G        110537152  4.2BSD   2048 16384     1 # /usr/X11R6
</span></span><span class=line><span class=cl>  h:            10.0G        112634304  4.2BSD   2048 16384     1 # /usr/local
</span></span><span class=line><span class=cl>  i:             2.0G        133605824  4.2BSD   2048 16384     1 # /usr/src
</span></span><span class=line><span class=cl>  j:             6.0G        137800128  4.2BSD   2048 16384     1 # /usr/obj
</span></span><span class=line><span class=cl>  k:           162.7G        150383040  4.2BSD   4096 32768     1 # /home
</span></span><span class=line><span class=cl>Use (A)uto layout, (E)dit auto layout, or create (C)ustom layout? [a]
</span></span></code></pre></div><p>Just for the purpose of simplifying, I will create a custom layout with only a root slice,
note that this is insecure and,
unless you know what you&rsquo;re doing you should avoid that as it exposes your system to a denial of service.</p><p>The swap slice is redundant with the one we already create along the RAID slice in sd0,
so the options are either to stick with the auto layout or to create a custom layout that&rsquo;s similar but without swap.</p><p>At the very very least,
you want to isolate / from /tmp, /var, /usr and /home,
though isolating it from /usr/local is not a bad idea.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Use (A)uto layout, (E)dit auto layout, or create (C)ustom layout? [a] C
</span></span><span class=line><span class=cl>Label editor (enter &#39;?&#39; for help at any prompt)
</span></span><span class=line><span class=cl>&gt; p
</span></span><span class=line><span class=cl>OpenBSD area: 64-491508675; size: 491508611; free: 491508611
</span></span><span class=line><span class=cl>#                size           offset  fstype [fsize bsize   cpg]
</span></span><span class=line><span class=cl>  c:        491524148                0  unused
</span></span><span class=line><span class=cl>&gt; a
</span></span><span class=line><span class=cl>partition: [a]
</span></span><span class=line><span class=cl>offset: [64]
</span></span><span class=line><span class=cl>size: [491508611]
</span></span><span class=line><span class=cl>FS type: [4.2BSD]
</span></span><span class=line><span class=cl>mount point: [none] /
</span></span><span class=line><span class=cl>Rounding size to bsize (64 sectors): 491508608
</span></span><span class=line><span class=cl>&gt; w
</span></span><span class=line><span class=cl>&gt; q
</span></span><span class=line><span class=cl>No label changes.
</span></span><span class=line><span class=cl>/dev/rsd1a: 239994.4MB in 491508608 sectors of 512 bytes
</span></span><span class=line><span class=cl>295 cylinder groups of 814.44MB, 26062 blocks, 52224 inodes each
</span></span><span class=line><span class=cl>Available disks are: sd0.
</span></span><span class=line><span class=cl>Which disk do you wish to initialize? (or &#39;done&#39;) [done]
</span></span><span class=line><span class=cl>/dev/sd1a (448be85498897147.a) on /mnt type ffs (rw, asynchronous, local)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Let&#39;s install the sets!
</span></span><span class=line><span class=cl>Location of sets? (disk http or &#39;done&#39;) [http]
</span></span><span class=line><span class=cl>HTTP proxy URL? (e.g. &#39;http://proxy:8080&#39;, or &#39;none&#39;) [none]
</span></span><span class=line><span class=cl>HTTP Server? (hostname, list#, &#39;done&#39; or &#39;?&#39;) [ftp.fr.openbsd.org]
</span></span><span class=line><span class=cl>Server directory? [pub/OpenBSD/6.2/amd64]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Select sets by entering a set name, a file name pattern or &#39;all&#39;. De-select
</span></span><span class=line><span class=cl>sets by prepending a &#39;-&#39;, e.g.: &#39;-game*&#39;. Selected sets are labelled &#39;[X]&#39;.
</span></span><span class=line><span class=cl>    [X] bsd           [X] base62.tgz    [X] game62.tgz    [X] xfont62.tgz
</span></span><span class=line><span class=cl>    [X] bsd.mp        [X] comp62.tgz    [X] xbase62.tgz   [X] xserv62.tgz
</span></span><span class=line><span class=cl>    [X] bsd.rd        [X] man62.tgz     [X] xshare62.tgz
</span></span><span class=line><span class=cl>Set name(s)? (or &#39;abort&#39; or &#39;done&#39;) [done]
</span></span><span class=line><span class=cl>Get/Verify SHA256.sig   100% |**************************|  2152       00:00
</span></span><span class=line><span class=cl>Signature Verified
</span></span><span class=line><span class=cl>Get/Verify bsd          100% |**************************| 12777 KB    00:08
</span></span><span class=line><span class=cl>Get/Verify bsd.mp       100% |**************************| 12858 KB    09:46
</span></span><span class=line><span class=cl>Get/Verify bsd.rd       100% |**************************|  9565 KB    00:05
</span></span><span class=line><span class=cl>Get/Verify base62.tgz   100% |**************************|   139 MB    01:24
</span></span><span class=line><span class=cl>Get/Verify comp62.tgz   100% |**************************| 75525 KB    50:08
</span></span><span class=line><span class=cl>Get/Verify man62.tgz    100% |**************************|  7008 KB    00:03 
</span></span><span class=line><span class=cl>Get/Verify game62.tgz   100% |**************************|  2718 KB    01:56
</span></span><span class=line><span class=cl>Get/Verify xbase62.tgz  100% |**************************| 17964 KB    12:29    
</span></span><span class=line><span class=cl>Get/Verify xshare62.tgz 100% |**************************|  4417 KB    02:43    
</span></span><span class=line><span class=cl>Get/Verify xfont62.tgz  100% |**************************| 39342 KB    00:20    
</span></span><span class=line><span class=cl>Get/Verify xserv62.tgz  100% |**************************| 12572 KB    00:06    
</span></span><span class=line><span class=cl>Installing bsd          100% |**************************| 12777 KB    00:00    
</span></span><span class=line><span class=cl>Installing bsd.mp       100% |**************************| 12858 KB    00:00    
</span></span><span class=line><span class=cl>Installing bsd.rd       100% |**************************|  9565 KB    00:00    
</span></span><span class=line><span class=cl>Installing base62.tgz   100% |**************************|   139 MB    00:10    
</span></span><span class=line><span class=cl>Extracting etc.tgz      100% |**************************|   189 KB    00:00    
</span></span><span class=line><span class=cl>Installing comp62.tgz   100% |**************************| 75525 KB    00:08    
</span></span><span class=line><span class=cl>Installing man62.tgz    100% |**************************|  7008 KB    00:01    
</span></span><span class=line><span class=cl>Installing game62.tgz   100% |**************************|  2718 KB    00:00    
</span></span><span class=line><span class=cl>Installing xbase62.tgz  100% |**************************| 17964 KB    00:01    
</span></span><span class=line><span class=cl>Extracting xetc.tgz     100% |**************************|  7036       00:00    
</span></span><span class=line><span class=cl>Installing xshare62.tgz 100% |**************************|  4417 KB    00:01    
</span></span><span class=line><span class=cl>Installing xfont62.tgz  100% |**************************| 39342 KB    00:02    
</span></span><span class=line><span class=cl>Installing xserv62.tgz  100% |**************************| 12572 KB    00:01    
</span></span><span class=line><span class=cl>Location of sets? (disk http or &#39;done&#39;) [done] Location of sets? (disk http or &#39;done&#39;) [done] 
</span></span><span class=line><span class=cl>Saving configuration files...done.
</span></span><span class=line><span class=cl>Making all device nodes...done.
</span></span><span class=line><span class=cl>Multiprocessor machine; using bsd.mp instead of bsd.
</span></span><span class=line><span class=cl>Relinking to create unique kernel...done.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CONGRATULATIONS! Your OpenBSD install has been successfully completed!
</span></span><span class=line><span class=cl>To boot the new system, enter &#39;reboot&#39; at the command prompt.
</span></span><span class=line><span class=cl>When you login to your new system the first time, please read your mail
</span></span><span class=line><span class=cl>using the &#39;mail&#39; command.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 
</span></span></code></pre></div><h2 id=step-4-reboot-to-encrypted-openbsd-system>Step #4: reboot to encrypted OpenBSD system</h2><p>The root slice being encrypted, you&rsquo;ll need to type your password every time you reboot.</p><p>Connect to the serial console,
you should see the boot prompt asking for a password.
The &rsquo;n&rsquo; glitch is still around,
so either you break out of password by typing enter so you can do the &lsquo;set tty com1&rsquo; trick,
or you do as I do and synchronize with the &rsquo;n&rsquo; keystroke to delete it and type password really fast.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># reboot
</span></span><span class=line><span class=cl>syncing disks... done
</span></span><span class=line><span class=cl>sd1 detached
</span></span><span class=line><span class=cl>rebooting...
</span></span><span class=line><span class=cl>[...]
</span></span><span class=line><span class=cl>Using drive 0, partition 3.                                                     
</span></span><span class=line><span class=cl>Loading......                                                                   
</span></span><span class=line><span class=cl>probing: pc0 com0 com1 mem[632K 2009M 14336M a20=on]                            
</span></span><span class=line><span class=cl>disk: hd0+ sr0*                                                                 
</span></span><span class=line><span class=cl>&gt;&gt; OpenBSD/amd64 BOOT 3.33                                                      
</span></span><span class=line><span class=cl>Passphrase: 
</span></span><span class=line><span class=cl>boot&gt; set tty com1
</span></span><span class=line><span class=cl>&gt;&gt; OpenBSD/amd64 BOOT 3.33
</span></span><span class=line><span class=cl>boot&gt; boot
</span></span><span class=line><span class=cl>Passphrase: 
</span></span><span class=line><span class=cl>[...]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OpenBSD/amd64 (pocs.online.net) (tty01)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>login: gilles
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl>OpenBSD 6.2 (GENERIC.MP) #134: Tue Oct  3 21:22:29 MDT 2017
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Welcome to OpenBSD: The proactively secure Unix-like operating system.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please use the sendbug(1) utility to report bugs in the system.
</span></span><span class=line><span class=cl>Before reporting a bug, please try to reproduce it with the latest
</span></span><span class=line><span class=cl>version of the code.  With bug reports, please try to ensure that
</span></span><span class=line><span class=cl>enough information to reproduce the problem is enclosed, and if a
</span></span><span class=line><span class=cl>known fix for it exists, include that as well.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You have new mail.
</span></span><span class=line><span class=cl>$
</span></span></code></pre></div><p>As suggested by <code>semarie@</code>,
once logged in you can take opportunity to fix the &rsquo;n&rsquo; glitch by setting tty in boot.conf:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ su
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl># echo set tty com1 &gt; /etc/boot.conf
</span></span></code></pre></div><h2 id=bonus-further-tightening-your-system>Bonus: further tightening your system</h2><p>These are the few steps I immediately do to tighten up my systems furthers:</p><h1 id=enable-doas>enable doas</h1><p>The &lsquo;gilles&rsquo; account I created at install is part of the &lsquo;wheel&rsquo; group,
which turns out to be exactly what the example doas.conf allows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ su
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl># cat /etc/examples/doas.conf |tail -1
</span></span><span class=line><span class=cl>permit keepenv :wheel
</span></span><span class=line><span class=cl># cp /etc/examples/doas.conf /etc
</span></span><span class=line><span class=cl># exit
</span></span><span class=line><span class=cl>$ doas sh
</span></span><span class=line><span class=cl>doas (gilles@pocs.online.net) password:
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><h1 id=disable-the-root-account>disable the root account</h1><p>Now that &lsquo;gilles&rsquo; can use <code>doas</code> we no longer ever need to authenticate as root,
so disable it by setting the password to &lsquo;*&rsquo;.
This will prevent &lsquo;root&rsquo; from being usable directly or through <code>su</code>,
yet if really needed &lsquo;gilles&rsquo; can still <code>doas su</code> to obtain a shell running as user &lsquo;root&rsquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># usermod -p&#39;*&#39; root
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><h1 id=update-system-with-syspatch>update system with syspatch</h1><p>The brand new system may require some patches to be applied,
the <code>syspatch</code> command written by ajacoutot@ performs a binary patching of the system,
then causes the kernel to be relinked using the KARL mechanism to shuffle objects order:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># syspatch
</span></span><span class=line><span class=cl>Get/Verify syspatch62-001_tcb_inv... 100% |*************|   465 KB    00:00    
</span></span><span class=line><span class=cl>Installing patch 001_tcb_invalid
</span></span><span class=line><span class=cl>Get/Verify syspatch62-002_fktrace... 100% |*************|   785 KB    00:21    
</span></span><span class=line><span class=cl>Installing patch 002_fktrace
</span></span><span class=line><span class=cl>Get/Verify syspatch62-003_mpls.tgz 100% |***************|   837 KB    00:00    
</span></span><span class=line><span class=cl>Installing patch 003_mpls
</span></span><span class=line><span class=cl>Get/Verify syspatch62-004_libssl.tgz 100% |*************|  2515 KB    00:01    
</span></span><span class=line><span class=cl>Installing patch 004_libssl
</span></span><span class=line><span class=cl>Relinking to create unique kernel... done.
</span></span></code></pre></div><h1 id=add-my-ssh-public-key-to-my-sshauthorized_keys>add my ssh public key to my ~/.ssh/authorized_keys</h1><p>Password for accessing SSH are bad,
copy the SSH public key generated on my laptop with <code>ssh-keygen</code> to the authorized_keys file of my account on the server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># echo &#39;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII19dxt4hf1t4Lo05TaPZQqrtwtszHHyAF7ctPYPRIvp gilles@debug.poolp.org&#39;&gt;&gt;~gilles/.ssh/authorized_keys
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><h1 id=disable-password-authentication-within-ssh>disable password authentication within ssh</h1><p>No reason to allow PasswordAuthentication anymore,
disable in sshd_config and restart sshd:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># echo PasswordAuthentication no &gt;&gt; /etc/ssh/sshd_config
</span></span><span class=line><span class=cl># /etc/rc.d/sshd restart                                                       
</span></span><span class=line><span class=cl>sshd(ok)
</span></span><span class=line><span class=cl>sshd(ok)
</span></span><span class=line><span class=cl>#
</span></span></code></pre></div><h1 id=reboot-so-you-boot-on-a-brand-new-up-to-date-system-with-latest-stable-kernel>reboot so you boot on a brand new up-to-date system with latest stable kernel</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl># reboot
</span></span><span class=line><span class=cl>syncing disks... done
</span></span><span class=line><span class=cl>sd1 detached
</span></span><span class=line><span class=cl>rebooting...
</span></span><span class=line><span class=cl>[...]
</span></span><span class=line><span class=cl>Using drive 0, partition 3.                                                     
</span></span><span class=line><span class=cl>Loading......                                                                   
</span></span><span class=line><span class=cl>probing: pc0 com0 com1 mem[632K 2009M 14336M a20=on]                            
</span></span><span class=line><span class=cl>disk: hd0+ sr0*                                                                 
</span></span><span class=line><span class=cl>&gt;&gt; OpenBSD/amd64 BOOT 3.33                                                      
</span></span><span class=line><span class=cl>Passphrase: 
</span></span><span class=line><span class=cl>boot&gt; set tty com1
</span></span><span class=line><span class=cl>&gt;&gt; OpenBSD/amd64 BOOT 3.33
</span></span><span class=line><span class=cl>boot&gt; boot
</span></span><span class=line><span class=cl>Passphrase: 
</span></span><span class=line><span class=cl>[...]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OpenBSD/amd64 (pocs.online.net) (tty01)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>login:
</span></span><span class=line><span class=cl>Password:
</span></span></code></pre></div><p>VOILA !</p><hr><p>Want to comment ? <a href=https://github.com/poolpOrg/poolpOrg.github.io/issues/>Open an issue on Github</a></p></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2018-04-30/opensmtpd-new-config/>&#171; OpenSMTPD new config</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2018-01-08/news-from-the-front/>News from the front ! &#187;</a><div class=clearfix></div></div></div></div></div></div><div class=alertbar><div class="container text-center"><span><img src=/images/poolp_org.png alt=logo height=0px>
Consider tipping me on <a href=https://paypal.me/poolpOrg>PayPal</a>,
supporting me through <a href=https://github.com/sponsors/poolpOrg>Github</a>,
<a href=https://patreon.com/gilles>Patreon</a> or
<a href=https://liberapay.com/poolpOrg>LiberaPay</a>,
or getting me something from <a href=http://amzn.eu/3MwH6CX>Amazon</a> for positive <a href=https://en.wikipedia.org/wiki/Reinforcement>reinforcement</a> :-)</span></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright poolp.org - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/mediumish.js></script></body></html>