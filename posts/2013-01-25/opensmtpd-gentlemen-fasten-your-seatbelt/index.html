<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=icon href=/images/poolp_org.png><title>OpenSMTPD: gentlemen, fasten your seatbelt | poolp.org</title><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenSMTPD: gentlemen, fasten your seatbelt"><meta name=twitter:description content="OHAI,
Lately we have stabilized and decided that we&rsquo;re okay with the features we have for our first release, this time for good, so we focused on making sure that we didn&rsquo;t introduce regressions and that we were rock solid.
We stressed incoming and outgoing path and found areas of improvements. This will be a long-standing task, but we have already improved memory usage considerably under high-load, we&rsquo;re pretty happy with the result."><meta property="og:title" content="OpenSMTPD: gentlemen, fasten your seatbelt"><meta property="og:description" content="OHAI,
Lately we have stabilized and decided that we&rsquo;re okay with the features we have for our first release, this time for good, so we focused on making sure that we didn&rsquo;t introduce regressions and that we were rock solid.
We stressed incoming and outgoing path and found areas of improvements. This will be a long-standing task, but we have already improved memory usage considerably under high-load, we&rsquo;re pretty happy with the result."><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2013-01-25/opensmtpd-gentlemen-fasten-your-seatbelt/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-01-25T23:01:47+00:00"><meta property="article:modified_time" content="2013-01-25T23:01:47+00:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link href=/css/medium.css rel=stylesheet><link href=/css/additional.css rel=stylesheet><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/posts>Articles</a></li><li class=nav-item><a class=nav-link href=/fr/contracting/>Freelance</a></li><li class=nav-item><a class=nav-link href=https://hypno.cat>Hypnose</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=mainheading></div><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=OpenSMTPD%3a%20gentlemen%2c%20fasten%20your%20seatbelt&url=https%3a%2f%2fpoolp.org%2fposts%2f2013-01-25%2fopensmtpd-gentlemen-fasten-your-seatbelt%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=435'),!1"><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fpoolp.org%2fposts%2f2013-01-25%2fopensmtpd-gentlemen-fasten-your-seatbelt%2f" onclick="return window.open(this.href,'facebook-share','width=550,height=435'),!1"><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fpoolp.org%2fposts%2f2013-01-25%2fopensmtpd-gentlemen-fasten-your-seatbelt%2f" onclick="return window.open(this.href,'xing-share','width=550,height=435'),!1"><i class="fab fa-xing"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/images/me.jpg alt="Gilles Chehade"></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade</a><br><span class=author-description><br><i class="far fa-star"></i>
Jan 25, 2013
<i class="far fa-clock clock"></i>
4 min read</span></div></div><h1 class=posttitle>OpenSMTPD: gentlemen, fasten your seatbelt</h1></div><div class=article-post><p>OHAI,</p><p>Lately we have stabilized and decided that we&rsquo;re okay with the features we have for our first release, this time for good, so we focused on making sure that we didn&rsquo;t introduce regressions and that we were rock solid.</p><p>We stressed incoming and outgoing path and found areas of improvements. This will be a long-standing task, but we have already improved memory usage considerably under high-load, we&rsquo;re pretty happy with the result.</p><p>All of the following has been committed, we published snapshots and we sync-ed the OpenBSD tree with our own repository so that OpenBSD-current now has all of the features, improvements and bug fixes we came up with in the last few weeks (or months for some stuff we didn&rsquo;t backport).</p><p>Anyway, here goes a summary and I&rsquo;m off to bed as I&rsquo;m sick as shit.</p><p>fix a descriptor leak</p><p>We were told of a crash which appeared to be coming from a descriptor leak. On Linux, lsof would display that message files were removed while the transfer process still had a descriptor opened. We tracked the issue and spotted that it would happen because of a missing condition in the transfer process where the message file would not be closed if recipients were rejected and the session was reused to send another message. Two liner fix.</p><p>SSL code cleanup</p><p>An OpenBSD user reported a problem with ldapd&rsquo;s ssl.c where the prime used for DH parameters was 512 bits which is short enough by today&rsquo;s standards to be rejected by OpenLDAP&rsquo;s client. OpenSMTPD&rsquo;s ssl.c has been changed a long time ago to bump this prime to a 1024 bits prime, but ldapd&rsquo;s ssl.c was actually a copy of OpenSMTPD&rsquo;s ssl.c from two years ago.</p><p>The desynchronization of ssl.c accross OpenBSD daemons has annoyed me for a long time but it occured to me that maintaining this gap would be causing further divergences in the future as reyk@ moves OpenIKED and relayd forward. After a quick chat with him I started creating a daemon-agnostic version of ssl.c.</p><p>There is still work to do in that area, but OpenSMTPD now comes with a ssl_privsep.c that is equivalent to that of relayd; a ssl.c file that no longer knows of any smtpd specific structures and which can be shared with other daemons; a ssl_smtpd.c that contains the smtpd-specific bits.</p><p>Note that ssl.c doesn&rsquo;t contain new code, this was only a rework of the interfaces to allow it to be shareable with different daemons.</p><p>Runtime tracing and profiling</p><p>I have added a feature that I&rsquo;ve been wanting for a long time: activating traces at runtime without a daemon restart.</p><p>Say a user suddenly observes that connections to a remote host fails, he can now simply type: smtpctl trace transfer</p><p>To obtain a real-time view of the sessions as they take place with remote hosts.</p><p>There are many trace subsystems, for incoming connections, outgoing connections, msg exchanges accross processes, etc, etc, &mldr; read the man page ;-)</p><p>While at it, if you need to verify bottlenecks OpenSMTPD also supports real-time profiling of imsg and queue using: smtpctl profile imsg and smtpctl profile queue</p><p>Both tracing and profiling can be turned on and off at runtime.</p><p>Improve memory use</p><p>Eric cleaned up some code to avoid passing envelopes when we could pass evpid instead. This prevents OpenSMTPD from accumulating data in the inter-process buffers (an evpid is 64bits, an envelope structure is several kbytes).</p><p>For the places where the envelope really needs to be passed, he suggested that we send a compressed version. I proposed that we use the ASCII envelope conversion as we know it works given that it&rsquo;s already used for disk-based envelopes. The ascii envelopes allow compressing the envelope quite a lot as instead of passing a large datastructure with partially used large fields, we pass the ascii representation that can be as small as a hundred bytes.</p><p>We should now be able to cope better in very heavily loaded situations ;-)</p></div><div class=after-post-tags><ul class=tags></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2013-02-02/opensmtpd-minor-fixes-preparing-release/>&#171; OpenSMTPD: minor fixes + preparing release</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2013-01-18/opensmtpd-stress-and-features/>OpenSMTPD: stress and features &#187;</a><div class=clearfix></div></div></div></div></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright Gilles Chehade - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script><script src=/js/mediumish.js></script></body></html>