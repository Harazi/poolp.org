<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><link rel=icon href=/images/poolp_org.png><title>April 2021: OpenSMTPD, plakar, ipcmsg, privsep and a small hypnosis talk | poolp.org</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://poolp.org/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/cover.png"><meta name=twitter:title content="April 2021: OpenSMTPD, plakar, ipcmsg, privsep and a small hypnosis talk"><meta name=twitter:description content="TL;DR: I worked on OpenSMTPD-portable, did a lot of plakar, a lot of Go and gave a technical talk on hypnosis. Shout outs to my patrons ! A huge thanks goes to the people sponsoring me on patreon, github or liberaPay, the work in this post was made possible by my sponsors.
Let&rsquo;s start with some LoFi Relax.
I have a youtube channel (subscribe ! now !)
This one caused me a copyright strike so I hope it was worth it :-)"><meta property="og:title" content="April 2021: OpenSMTPD, plakar, ipcmsg, privsep and a small hypnosis talk"><meta property="og:description" content="TL;DR: I worked on OpenSMTPD-portable, did a lot of plakar, a lot of Go and gave a technical talk on hypnosis. Shout outs to my patrons ! A huge thanks goes to the people sponsoring me on patreon, github or liberaPay, the work in this post was made possible by my sponsors.
Let&rsquo;s start with some LoFi Relax.
I have a youtube channel (subscribe ! now !)
This one caused me a copyright strike so I hope it was worth it :-)"><meta property="og:type" content="article"><meta property="og:url" content="https://poolp.org/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/"><meta property="og:image" content="https://poolp.org/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-30T21:12:00+02:00"><meta property="article:modified_time" content="2021-04-30T21:12:00+02:00"><link href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css rel=stylesheet integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel=stylesheet><link rel=stylesheet href=https://poolp.org/css/medium.a3d5489836b19de22a81ddc6bd21c17547d07529e67b266427378a04fa3ea727.css integrity="sha256-o9VImDaxneIqgd3GvSHBdUfQdSnmeyZkJzeKBPo+pyc="><link rel=stylesheet href=https://poolp.org/css/additional.8819b6defcdc6d21280f9b402b00df87ca779135901de6c22e708c62e20184b9.css integrity="sha256-iBm23vzcbSEoD5tAKwDfh8p3kTWQHebCLnCMYuIBhLk="><link rel=stylesheet href=/css/custom.css crossorigin=anonymous media=screen></head><body><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://poolp.org/><img src=/images/poolp_org.png alt=logo></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"></ul><ul class="navbar-nav ml-auto"><li class=nav-item style=margin:5px><a class="mt-1 mb-1" href=/categories/personal><button type=button class="btn btn-sm btn-primary">personal</button></a></li><li class=nav-item style=margin:5px><a class="mt-1 mb-1" href=/categories/technology><button type=button class="btn btn-sm btn-primary">technology</button></a></li></ul></div></div></nav><div class=site-content><div class=container><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="row post-top-meta"><div class="col-xs-12 col-md-12 col-lg-12 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><img class=author-thumb src=/authors/gilles-chehade/gilles-chehade.jpg alt="Gilles Chehade / جيل شحادة"></div><div class="col-xs-12 col-md-12 col-lg-12 text-center text-md-left md-nopad-left"><a target=_blank class=link-dark>Gilles Chehade / جيل شحادة</a><br><span class=author-description><br></span><br></div></div></div><div class="col-md-8 flex-first flex-md-unordered"><div class=mainheading><h1 class=posttitle>April 2021: OpenSMTPD, plakar, ipcmsg, privsep and a small hypnosis talk</h1><span class=author-description><i class="far fa-star"></i>
Apr 30, 2021
<i class="far fa-clock clock"></i>
13 min read</span><div class=after-post-tags><ul class=tags></ul></div><b><a class="far fa-comment" href=#comments>go to comments</a></b><br><br><center><img class="featured-image img-fluid" src=https://poolp.org/posts/2021-04-30/april-2021-opensmtpd-plakar-ipcmsg-privsep-and-a-small-hypnosis-talk/cover.png alt="thumbnail for this post"></center></div><div class=article-post><blockquote><b>TL;DR:</b>
I worked on OpenSMTPD-portable, did a lot of plakar, a lot of Go and gave a technical talk on hypnosis.</blockquote><h1 id=shout-outs-to-my-patrons->Shout outs to my patrons !</h1><p>A <strong>huge</strong> thanks goes to the people <strong>sponsoring me</strong> on <strong><a href=https://www.patreon.com/gilles>patreon</a></strong>,
<strong><a href=https://github.com/sponsors/poolpOrg>github</a></strong> or <strong><a href=https://liberapay.com/poolpOrg>liberaPay</a></strong>,
the work in this post was made possible by my sponsors.</p><h1 id=lets-start-with-some-lofi>Let&rsquo;s start with some LoFi</h1><p>Relax.</p><center><iframe width=560 height=315 src=https://www.youtube.com/embed/OUaa4Q8owaI title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></center><p>I have a <a href=https://www.youtube.com/c/GillesChehade>youtube channel</a> (subscribe ! now !)</p><p>This one caused me a <strong>copyright strike</strong> so I hope it was worth it :-)</p><h1 id=opensmtpd-portable>OpenSMTPD-portable</h1><p>I did a bit of <strong>review and test</strong> for diffs sent to me,
helped test a diff for a <strong>reproducible crash</strong> in the <strong>new libtls code</strong> on my machines,
and shared some of my nooSMTPD diffs with <code>eric@</code> so he could decide to reuse them or not in OpenSMTPD.</p><p>With OpenBSD 6.9 coming out,
<strong>OpenSMTPD 6.9.0 was tagged</strong> and <code>eric@</code> asked me if I could <strong>synchronize the OpenSMTPD portable repository</strong> so it matches OpenBSD.
I spent a few hours bringing back <strong>every individual commit</strong>,
<strong>fixing conflicts</strong> and ended up with a <strong>libtls-powered</strong> OpenSMTPD-portable which &mldr; didn&rsquo;t build anywhere because <strong>the world still uses OpenSSL</strong>.</p><p>Since I had already dealt with this in nooSMTPD,
I brought back my <strong>libtls compat layer</strong> so that on systems with OpenSSL the compat layer allows <strong>using the libtls interface on top of OpenSSL</strong>.
This fixed the CI for <strong>Ubuntu and Fedora</strong>,
unfortunately the CI for <strong>Alpine and ArchLinux</strong> uses LibreSSL and remain broken until the latest LibreSSL is packaged there.</p><p>Because the libtls conversion is such a major change,
there will be a <strong>delay</strong> between the time OpenSMTPD is released for <strong>OpenBSD</strong> users and the time it is released for <strong>other systems</strong>:
the change to the libtls interface has been heavily tested and I&rsquo;ve been running it for a while now,
but the portable adaptation of it has been <strong>virtually untested</strong>.
I&rsquo;ll send a mail this week-end to call for testing before we can tag a release.</p><h1 id=plakar>Plakar</h1><p>I <a href=/posts/2021-03-26/march-2021-backups-with-plakar>wrote about plakar last month</a> and made <strong>a lot of progress</strong> since then.</p><p>I&rsquo;m <strong>not publishing</strong> the code yet as there are many things I want to finish first before the first people start commenting and bikeshedding.</p><h2 id=restructured-the-project>restructured the project</h2><p>I&rsquo;m not too familiar with Go so I didn&rsquo;t structure the project very nicely at first.
I spent a few hours creating specific modules and reworking things so that they are properly split.</p><p>I&rsquo;m not done but it is starting to look less shameful :-)</p><h2 id=removed-namespaces>removed namespaces</h2><p>I initially thought namespaces within a plakar was a nice idea,
but the more I played with them the more I realized it wasn&rsquo;t and didn&rsquo;t bring any benefit over creating multiple plakars.
I decided to remove namespaces to simplify things.</p><h2 id=plakar-level-encryption>plakar-level encryption</h2><p>I brought <strong>support for encryption</strong> and tried two different approaches:
<strong>snapshot-level</strong> encryption and <strong>plakar-level</strong> encryption.</p><p>With the first approach, a plakar repository doesn&rsquo;t care about encryption.
It is <strong>the snapshots themselves</strong> that are encrypted on an <strong>individual basis</strong> and the same plakar can host both encrypted and cleartext snapshots.</p><p>With the second approach, <strong>a plakar repository is initialized as encrypted or cleartext</strong>.
The snapshots are automatically encrypted if needed and the same plakar ony hosts all encrypted or all cleartext snapshots.</p><p>I played with both but decided to go with the <strong>second approach</strong> because the first one came with additional unnecessary complexity.</p><h2 id=encryption-macro-details>encryption macro-details</h2><p>A user generates a <strong><code>P384</code> keypair</strong> as well as a <strong>random master key</strong>,
the bundle is protected by a <strong><code>pbkdf2</code>-derived passphrase</strong>.</p><p>When pushing to an encrypted plakar,
<strong>the chunks and objects are <code>aes256-gcm</code> encrypted</strong> using a <strong>subkey</strong> encrypted itself by the master key.</p><p>The snapshot index containing all the checksums for all objects and chunks is encrypted and <strong>signed</strong>.</p><p>Upon restore,
the index signature is <strong>verified</strong> and the chunks are decrypted.</p><h2 id=keypair-and-master-key-generation>keypair and master key generation</h2><p>The <code>P384</code> keypair and master key bundle is generated using the <code>plakar keygen</code> command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar keygen 
</span></span><span class=line><span class=cl>passphrase: 
</span></span><span class=line><span class=cl>passphrase <span class=o>(</span>confirm<span class=o>)</span>: 
</span></span><span class=line><span class=cl>keypair saved to <span class=nb>local</span> store
</span></span><span class=line><span class=cl>%
</span></span></code></pre></div><p>This results in the passphrase-encrypted bundle being saved to <code>~/.plakar/plakar.key</code>.</p><h2 id=plakar-initialization>plakar initialization</h2><p>To be able to create snapshots,
an initialized plakar repository must be available.
A local cleartext plakar is <strong>initialized by default</strong> in <code>~/.plakar</code> so that the command will work out of the box for local snapshots.</p><p>However it can also be initialized elsewhere,
<strong>defaulting to an encrypted plakar</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar init /tmp/plakar
</span></span><span class=line><span class=cl>passphrase: 
</span></span><span class=line><span class=cl>/tmp/plakar: store initialized
</span></span><span class=line><span class=cl>% 
</span></span></code></pre></div><p>or can be made cleartext by passing the <code>-cleartext</code> option:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar init -cleartext /tmp/plakar.ct
</span></span><span class=line><span class=cl>/tmp/plakar.ct: store initialized
</span></span><span class=line><span class=cl>%
</span></span></code></pre></div><h2 id=reworked-the-command-line-interface>Reworked the command line interface</h2><p>Last month,
to use an alternative plakar instead of <code>~/.plakar</code>,
it was necessary to use the <code>-store</code> option which I disliked&mldr;
so I reworked the command line to introduce a notion of <strong>direction</strong>.</p><p>When using the default plakar,
no change is required:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar push /private/etc
</span></span><span class=line><span class=cl>% plakar ls
</span></span><span class=line><span class=cl>2021-04-30T22:35:35Z 702b5b48-15dc-41cf-bfc1-1c8b94d1e985 3.1 MB <span class=o>(</span>files: 242, dirs: 41<span class=o>)</span>
</span></span><span class=line><span class=cl>% plakar pull 702b5b48
</span></span><span class=line><span class=cl>%
</span></span></code></pre></div><p>But when using an alternate plakar,
instead of providing the <code>-store</code> option it is now possible to <strong>push <code>to</code></strong> a plakar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar push /private/etc to /tmp/plakar.ct
</span></span><span class=line><span class=cl>%
</span></span></code></pre></div><p>.. and <strong>run commands <code>from</code></strong> a plakar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar ls from /tmp/plakar.ct            
</span></span><span class=line><span class=cl>2021-04-30T22:30:51Z d499fd92-01cb-4eb3-bb60-b147417b68a1 3.1 MB <span class=o>(</span>files: 242, dirs: 41<span class=o>)</span>
</span></span><span class=line><span class=cl>% plakar pull d499fd92 from /tmp/plakar.ct
</span></span><span class=line><span class=cl>%
</span></span></code></pre></div><p><strong>All commands</strong> support the direction option.</p><h2 id=generate-a-tarball>Generate a tarball</h2><p>I thought it would be nice if I could restore a snapshot or part of it <strong>into a tarball</strong>,
as I often want to extract a bit of a snapshot on a machine to send elsewhere.</p><p>I introduced a <code>tarball</code> command which allows generating a tarball:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar tarball d499fd92 &gt; /tmp/d499df92.tar.gz
</span></span></code></pre></div><p>It also supports partial restore:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar tarball d499fd92:/etc &gt; /tmp/d499df92_etc.tar.gz
</span></span></code></pre></div><h2 id=plakar-server-and-client>plakar server and client</h2><p>I implemented a <strong>proof of concept</strong> for a plakar server and client protocol,
allowing the use of plakar <strong>over the network</strong>.</p><p>On one end, I initialize a plakar repository and run a server from it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>nas% plakar init /tmp/plakar
</span></span><span class=line><span class=cl>passphrase:
</span></span><span class=line><span class=cl>/tmp/plakar: store initialized
</span></span><span class=line><span class=cl>nas% plakar server 192.168.0.2:2222 from /tmp/plakar
</span></span><span class=line><span class=cl>passphrase:
</span></span></code></pre></div><p>On the other end, I simply push to a remote plakar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>laptop% plakar push /etc to plakar://192.168.0.2:2222 
</span></span></code></pre></div><p>There is absolutely <strong>no difference or limitation</strong> from the client point of view,
any command that works locally will work remotely just as well.</p><p>It is even possible to <strong>chain servers</strong> in order to <strong>proxify</strong> a plakar server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>nas% plakar server 192.168.0.2:2222 from /tmp/plakar
</span></span><span class=line><span class=cl>passphrase:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gate% plakar server 192.168.0.1:2222 from plakar://192.168.0.2:2222
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>laptop% plakar push /etc to plakar://192.168.0.1:2222 
</span></span></code></pre></div><p>Does it serve a purpose ? nope, it just <strong>works by accident</strong>.</p><h2 id=plakar-ui>plakar ui</h2><p>Finally, I implemented a <strong>basic web UI</strong> so that I could browse the snapshots easily.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% plakar ui
</span></span><span class=line><span class=cl>Launched UI on port <span class=m>40717</span>
</span></span></code></pre></div><p>This opens a web browser which lets me browse the snapshots <strong>as a filesystem</strong>:</p><center><img src=/images/2021-04-01-plakar1.png></center>
<center><img src=/images/2021-04-01-plakar2.png></center><p>allows me to inspect <strong>individual files</strong>:</p><center><img src=/images/2021-04-01-plakar3.png></center><p>get a <strong>preview</strong>:</p><center><img src=/images/2021-04-01-plakar4.png></center><p>including of <strong>images, pdf, videos or sound</strong>:</p><center><img src=/images/2021-04-01-plakar5.png></center><p>and even <strong>search</strong> for files matching a pattern in every snapshot:</p><center><img src=/images/2021-04-01-plakar6.png></center><p>Because the web UI is a plakar client that doesn&rsquo;t do anything but plakar commands,
it can be launched from <strong>any plakar</strong> store,
cleartext or encrypted,
local or remote.</p><h1 id=some-work-in-go>Some work in Go</h1><p>I first wrote Go code with <a href=https://github.com/poolpOrg/filter-rspamd>filter-rspamd</a> and
<a href=https://github.com/poolpOrg/filter-senderscore>filter-senderscore</a> two years ago,
but never really dived into the language more than these two small projects because I still have some <strong>love-hate issues</strong> with some aspects of it.</p><p>I decided this month to get more familiar with it and started looking at what it would take to write a tiny daemon,
not just a program that runs an endless loop and does all work in the same process,
but one that does things the OpenBSD style with privileges separation,
message passing and fd passing.</p><p>I was not <strong>disappointed</strong>:
there&rsquo;s not much out there to do that.</p><h2 id=go-ipcmsg>go-ipcmsg</h2><p>The first thing that is missing is a package that provides something like the <code>imsg(3)</code> framework.</p><p>For those not familiar with it,
the <code>imsg(3)</code> framework provides functions that allow two processes to exchange messages,
<strong>including file descriptors</strong>,
while guaranteeing that messages are always received whole.</p><p>Typically,
you will create a <code>socketpair(2)</code> before <code>fork(2)</code>-ing a process.
The parent and the child will both use one end of the pair to communicate with each other,
using the <code>imsg(3)</code> framework that will take care of buffering I/O and exposing full messages to receiving end.</p><p>There are a lot of gory details on how it achieves this and requires understanding iovec,
the semantic of <code>sendmsg(2)</code> and <code>recvmsg(2)</code>,
how control messages and SCM_RIGHTS works,
as well as some of the side effets of cmsgbuf alignments.
I did a bit of work related to resources exhaustion there a few years ago and,
while the interface is lovely,
I can&rsquo;t say I really missed diving in that code.</p><p>When I figured that there was nothing similar in Go,
I started reproducing the <code>imsg(3)</code> API but realized that while the API was fine in C,
it could be made <strong>much simpler in Go</strong> using the language-provided <strong>channels</strong> and <strong>goroutines</strong>.</p><p>So I wrote a <code>Channel</code> struct which creates two channels,
one for reads and one for writes,
and associates them to a <code>socketpair(2)</code> end:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// parent process main routine, forks a child then sets up an ipcmsg
</span></span></span><span class=line><span class=cl><span class=c1>// Channel on the socketpair, returning read and write channels. The
</span></span></span><span class=line><span class=cl><span class=c1>// channels can be used to emit messages to the child process.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>parent</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pid</span><span class=p>,</span> <span class=nx>fd</span> <span class=o>:=</span> <span class=nf>fork_child</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>child_r</span><span class=p>,</span> <span class=nx>child_w</span> <span class=o>:=</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Channel</span><span class=p>(</span><span class=nx>pid</span><span class=p>,</span> <span class=nx>fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// send a message to child
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>child_w</span> <span class=o>&lt;-</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Message</span><span class=p>(</span><span class=mi>42</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;foobar&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// read a message from child
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>msg</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>child_r</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received message: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Data</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// child process main routine, sets up an ipcmsg Channel on fd 3,
</span></span></span><span class=line><span class=cl><span class=c1>// the socketpair end inherited from parent,
</span></span></span><span class=line><span class=cl><span class=c1>// read and write channels can be used to communicate with parent
</span></span></span><span class=line><span class=cl><span class=c1>// process.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>child</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>parent_r</span><span class=p>,</span> <span class=nx>parent_w</span> <span class=o>:=</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Channel</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nf>Getppid</span><span class=p>(),</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// receive a message from parent
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>msg</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>parent_r</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received message: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// write a message back
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>parent_w</span> <span class=o>&lt;-</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Message</span><span class=p>(</span><span class=mi>42</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;barbaz&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In practice,
you wouldn&rsquo;t just inline the calls but the parent and the child would call a <strong>dispatch function</strong> to handle messages and act upon them,
something similar to below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPCMSG_PING</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPCMSG_PONG</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>dispatcher</span><span class=p>(</span><span class=nx>r</span> <span class=kd>chan</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nx>IPCMessage</span><span class=p>,</span> <span class=nx>w</span> <span class=kd>chan</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nx>IPCMessage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>msg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Hdr</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>IPCMSG_PING</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;data: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nx>w</span> <span class=o>&lt;-</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Message</span><span class=p>(</span><span class=nx>IPCMSG_PONG</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;barbaz&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>parent</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pid</span><span class=p>,</span> <span class=nx>fd</span> <span class=o>:=</span> <span class=nf>fork_child</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>child_r</span><span class=p>,</span> <span class=nx>child_w</span> <span class=o>:=</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Channel</span><span class=p>(</span><span class=nx>pid</span><span class=p>,</span> <span class=nx>fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>dispatcher</span><span class=p>(</span><span class=nx>child_r</span><span class=p>,</span> <span class=nx>child_w</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The file descriptors passing is handled with the function <code>MessageWithFd()</code> which takes an additional parameter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=nx>fd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>syscall</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mo>0700</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span> <span class=o>&lt;-</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>MessageWithFd</span><span class=p>(</span><span class=nx>IPCMSG_PING</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;barbaz&#34;</span><span class=p>),</span> <span class=nx>fd</span><span class=p>)</span>
</span></span></code></pre></div><p>The sending end will have the descriptor closed upon sending,
the receiving end will be receive a message with a HasFd option set in its header and an open descriptor:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=nx>msg</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>r</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Hdr</span><span class=p>.</span><span class=nx>HasFd</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Fd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// expected a descriptor but got none, handle this
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>syscall</span><span class=p>.</span><span class=nf>Close</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>The package is already commited on <a href=https://github.com/poolpOrg/ipcmsg>Github</a>,
however <strong>it hasn&rsquo;t been heavily tested</strong> and I <strong>would not recommend using it</strong> for anything serious before it has matured a bit.
I would <strong>LOVE</strong> to receive testing feedbacks though !</p><h2 id=go-privsep>go-privsep</h2><p>The second thing missing is the ability to easily do privileges separation,
that is <strong>creating multiple processes</strong> that are <strong>inherited from a parent process</strong> with <strong>different privileges</strong>,
and have the ability to <strong>communicate one with another</strong>.</p><p>On OpenBSD,
daemons follow the <strong>fork+reexec</strong> pattern which boils down to the following:</p><p>The daemon is started,
it forks all of its child processes after setting up the plumbing for communicating with them,
and each child process re-executes itself so that it benefits from ASLR and doesn&rsquo;t retain the memory layout of the parent process.</p><p>This is an <strong>improvement</strong> over the more widely used fork pattern,
where each child inherits from parent,
because <strong>the reexec causes all inherited data to be lost</strong>.
It prevents inheriting sensitive information by accident at the cost of forcing the parent to send back the necessary information to each process.
And again, it makes all child processes benefit from ASLR too which is nice.</p><p>This pattern was popularized in OpenBSD <strong>a few years ago</strong>,
long after many of the daemons were already in place,
so each one did what it could to make it happen.
There was <strong>no attempt at unifying this through a framework</strong> like was done for IPC and <code>imsg(3)</code>.</p><p>Since I had a good understanding of how to do that and no framework to inspire myself,
I worked on a <code>privsep</code> package that would make it easier to write such daemons.
The idea is that a daemon will describe the different processes that compose it,
as well as the communication channels between them,
and the <code>privsep</code> package will then handle all the plumbing so that processes are created according to expectations.</p><p>Here is a simple example of how it works:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/poolpOrg/ipcmsg&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/poolpOrg/privsep&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPCMSG_PING</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPCMSG_PONG</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>parent_main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span> <span class=c1>// sleep forever
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>foobar_main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>parent</span> <span class=o>:=</span> <span class=nx>privsep</span><span class=p>.</span><span class=nf>GetParent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>parent</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Message</span><span class=p>(</span><span class=nx>IPCMSG_PING</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;abcdef&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>parent_dispatcher</span><span class=p>(</span><span class=nx>r</span> <span class=kd>chan</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nx>IPCMessage</span><span class=p>,</span> <span class=nx>w</span> <span class=kd>chan</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nx>IPCMessage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>msg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Hdr</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>IPCMSG_PING</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[parent] received PING, sending PONG\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span> <span class=o>&lt;-</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Message</span><span class=p>(</span><span class=nx>IPCMSG_PONG</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;abcdef&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>foobar_dispatcher</span><span class=p>(</span><span class=nx>r</span> <span class=kd>chan</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nx>IPCMessage</span><span class=p>,</span> <span class=nx>w</span> <span class=kd>chan</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nx>IPCMessage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>msg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>Hdr</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>IPCMSG_PONG</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[foobar] received PONG, sending PING\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span> <span class=o>&lt;-</span> <span class=nx>ipcmsg</span><span class=p>.</span><span class=nf>Message</span><span class=p>(</span><span class=nx>IPCMSG_PING</span><span class=p>,</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;abcdef&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>privsep</span><span class=p>.</span><span class=nf>Init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>parent</span> <span class=o>:=</span> <span class=nx>privsep</span><span class=p>.</span><span class=nf>Parent</span><span class=p>(</span><span class=nx>parent_main</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>foobar</span> <span class=o>:=</span> <span class=nx>privsep</span><span class=p>.</span><span class=nf>Child</span><span class=p>(</span><span class=s>&#34;foobar&#34;</span><span class=p>,</span> <span class=nx>foobar_main</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>parent</span><span class=p>.</span><span class=nf>Channel</span><span class=p>(</span><span class=nx>foobar</span><span class=p>,</span> <span class=nx>parent_dispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>foobar</span><span class=p>.</span><span class=nf>Channel</span><span class=p>(</span><span class=nx>parent</span><span class=p>,</span> <span class=nx>foobar_dispatcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>privsep</span><span class=p>.</span><span class=nf>Start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you can see,
it uses the <code>ipcmsg</code> package to handle IPC between the two processes,
allowing my <code>pingpong</code> daemon to play ping pong indefinitely.
Each process can have <strong>more specific settings</strong> set so that it runs under a <strong>specific user</strong>,
a <strong>specific group</strong> or from a <strong><code>chroot(2)</code> jail</strong>.</p><p>I still have <strong>a lot of work</strong> to do on this,
but I commited the <a href=https://github.com/poolpOrg/privsep>current state on Github</a> anyways.</p><h1 id=small-talk-on-hypnosis>small talk on hypnosis</h1><p>This is <strong>not tech related</strong> but since my other main activity is hypnosis and hypnotherapy,
I spent a bit of time this month working on a 3-hours talk I gave to a community of street hypnotists and hypnotherapists in Nantes.</p><p>I&rsquo;ve been working these last three months on a model to <strong>describe the organization of the psychic apparatus</strong>,
based on what I learnt, experienced and observed these last six years from hundreds of hypnosis sessions,
tons of psychology readings and many experiments in lucid dreaming.</p><p>The model describes how the psychic apparatus organization <strong>changes with the altered state of consciousness</strong> of a subject and what it means in terms of <strong>access to the subconscious and repressed psychic content</strong>.</p><p>This is <strong>not limited to hypnosis</strong> as it can be used to evaluate if a particular kind of therapy even makes sense,
but applied to hypnosis it is particularly useful to <strong>understand resistance</strong>,
what is happening in a subject when a technique is used,
what is happening when a technique isn&rsquo;t working,
and how to <strong>bring the subject to the proper state of consciousness</strong>.</p><p>I don&rsquo;t think this post is the right place to dive into details and,
well,
the talk lasted 3 hours and it was very superficial so I will stop there.
If people are interested in this topic,
let me know and I&rsquo;ll think of a way to present this as the slides I presented are not really informative without me talking over them.</p><h1 id=whats-next->What&rsquo;s next ?</h1><p>Not much.</p><p>May will be a calm month for me here as the <strong>sponsoring has decreased</strong> and I need to <strong>do some freelance</strong> to buy myself <strong>spare time</strong> in June/July.
Furthermore,
I have had to deal with some personal issues in April and I&rsquo;m not in the mood to do a lot of stuff at the moment.</p><p>I&rsquo;ll probably do a few things,
as usual,
but I&rsquo;m not sure what at this point as it depends on how much time I&rsquo;ll have available and how my mood evolves.</p><hr><p>Comments: <a href=https://github.com/poolpOrg/poolp.org/discussions/129>https://github.com/poolpOrg/poolp.org/discussions/129</a></p></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6" href=https://poolp.org/posts/2021-08-13/august-2021-taking-a-break/>&#171; August 2021: taking a break</a>
<a class="d-block col-md-6 text-lg-right" href=https://poolp.org/posts/2021-03-26/march-2021-backups-with-plakar/>March 2021: backups with Plakar &#187;</a><div class=clearfix></div></div></div></div></div><div class=container><div id=comments class="row justify-content-center mb-5"><div class=col-md-8><script src=https://giscus.app/client.js data-repo=poolpOrg/poolp.org data-repo-id="MDEwOlJlcG9zaXRvcnkxMjYxODk2MjA=" data-category=Articles data-category-id=DIC_kwDOB4WANM4B-Zf1 data-mapping=og:title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></div></div></div><footer class=footer><div class=container><div class=row><div class="col-md-6 col-sm-6 text-center text-lg-left">&copy; Copyright poolp.org - All rights reserved</div><div class="col-md-6 col-sm-6 text-center text-lg-right"><a target=_blank rel=noopener href=https://www.wowthemes.net>Mediumish Theme</a> by WowThemes.net</div></div></div></footer></div><script src=https://code.jquery.com/jquery-3.4.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js integrity=sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=https://poolp.org/js/mediumish.84218587c174fd40bce82544b98851670f0b124a7324b349c54a4065e2b32ffc.js integrity="sha256-hCGFh8F0/UC86CVEuYhRZw8LEkpzJLNJxUpAZeKzL/w="></script></body></html>